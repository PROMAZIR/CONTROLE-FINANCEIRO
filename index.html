<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C.F - Controle Financeiro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="C.F">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- SEO Meta Tags -->
    <meta name="title" content="C.F - Controle Financeiro">
    <meta name="description" content="Gerencie suas compras e parcelas de forma simples e eficiente">
    <meta name="keywords" content="controle financeiro, parcelas, compras, gest√£o">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://credi-boti.jd.starktech.net.br">
    <meta property="og:title" content="C.F - Controle Financeiro">
    <meta property="og:description" content="Gerencie suas compras e parcelas de forma simples e eficiente">
    <meta property="og:image" content="https://i.ibb.co/kj8jVkq/Logotipo-Faustino-Representa-es-e-Vendas-Moderno-Preto-Branco-2.png">
    
    <style>
        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* === LOADING SCREEN BANC√ÅRIO PREMIUM === */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #1e40af 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-container.fade-out {
            opacity: 0;
            transform: scale(1.05);
            pointer-events: none;
        }

        /* Padr√£o geom√©trico de fundo */
        .loading-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.05) 0%, transparent 50%);
            background-size: 100px 100px;
            animation: backgroundFloat 20s ease-in-out infinite;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(10px, -10px) rotate(1deg); }
            66% { transform: translate(-5px, 5px) rotate(-1deg); }
        }

        /* Logo Container */
        .logo-container {
            position: relative;
            margin-bottom: 40px;
            animation: logoEntrance 1.5s ease-out;
        }

        @keyframes logoEntrance {
            0% {
                opacity: 0;
                transform: scale(0.3) rotate(-10deg);
            }
            60% {
                opacity: 1;
                transform: scale(1.1) rotate(2deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .logo-wrapper {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
        }

        .logo-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: logoShine 3s ease-in-out infinite;
        }

        @keyframes logoShine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        .logo-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 16px;
            filter: brightness(1.1) contrast(1.1);
        }

        /* Badge de Status */
        .status-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* T√≠tulo e Subt√≠tulo */
        .app-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            letter-spacing: -1px;
        }

        .app-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 50px;
            font-weight: 300;
            text-align: center;
            letter-spacing: 0.5px;
        }

        /* Progress Bar Banc√°rio */
        .progress-container {
            width: 100%;
            max-width: 320px;
            margin-bottom: 30px;
        }

        .progress-track {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 3px;
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255,255,255,0.6), 
                transparent
            );
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        .progress-text {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.8;
        }

        /* Status Loading */
        .loading-status {
            text-align: center;
            margin-bottom: 40px;
        }

        .status-text {
            font-size: 1rem;
            margin-bottom: 16px;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: dotBounce 1.4s infinite ease-in-out;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes dotBounce {
            0%, 80%, 100% { 
                transform: scale(0.8); 
                opacity: 0.5; 
            }
            40% { 
                transform: scale(1.2); 
                opacity: 1; 
            }
        }

        /* Features Cards */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 360px;
            width: 100%;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            animation: featureFloat 6s ease-in-out infinite;
        }

        .feature-card:nth-child(1) { animation-delay: 0s; }
        .feature-card:nth-child(2) { animation-delay: 1s; }
        .feature-card:nth-child(3) { animation-delay: 2s; }

        @keyframes featureFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .feature-card:hover {
            transform: translateY(-4px) scale(1.05);
            background: rgba(255, 255, 255, 0.15);
        }

        .feature-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
            display: block;
        }

        .feature-label {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.9;
        }

        /* === APP CONTAINER === */
        .app-container {
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            position: fixed;
            top: 0;
            left: 0;
            background: #f8fafc;
            overflow: hidden;
        }

        .iframe-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: #f8fafc;
            overflow: hidden;
        }

        #mainIframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #f8fafc;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* === ERROR HANDLING === */
        .error-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            z-index: 1000;
        }

        .error-screen.show {
            display: flex;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            animation: errorFloat 3s ease-in-out infinite;
        }

        @keyframes errorFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
        }

        .error-message {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 32px;
            line-height: 1.6;
            max-width: 400px;
        }

        .error-actions {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }

        /* === INSTALL BUTTON === */
        .install-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(30, 58, 138, 0.4);
            z-index: 1000;
            display: none;
            cursor: pointer;
            border: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .install-button.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .install-button:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 25px rgba(30, 58, 138, 0.5);
        }

        /* === TOAST NOTIFICATIONS === */
        .toast {
            position: fixed;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(17, 24, 39, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            bottom: 30px;
            opacity: 1;
        }

        .toast.success {
            background: rgba(5, 150, 105, 0.95);
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.95);
        }

        .toast.warning {
            background: rgba(245, 158, 11, 0.95);
        }

        /* === RESPONSIVIDADE === */
        @media (max-width: 768px) {
            .app-title {
                font-size: 2rem;
            }

            .app-subtitle {
                font-size: 1rem;
                margin-bottom: 40px;
            }

            .logo-wrapper {
                width: 100px;
                height: 100px;
            }

            .logo-img {
                width: 70px;
                height: 70px;
            }

            .progress-container {
                max-width: 280px;
            }

            .features-grid {
                max-width: 300px;
                gap: 16px;
            }

            .feature-card {
                padding: 16px;
            }

            .feature-icon {
                font-size: 1.5rem;
            }

            .feature-label {
                font-size: 0.8rem;
            }

            /* Mobile iframe adjustments */
            .app-container {
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
            }

            .iframe-container {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }

            #mainIframe {
                width: 100%;
                height: 100%;
                min-height: 100vh;
                min-height: calc(var(--vh, 1vh) * 100);
            }
        }

        @media (max-width: 480px) {
            .loading-container {
                padding: 20px;
            }

            .app-title {
                font-size: 1.8rem;
            }

            .logo-wrapper {
                width: 90px;
                height: 90px;
                margin-bottom: 30px;
            }

            .logo-img {
                width: 60px;
                height: 60px;
            }

            .features-grid {
                grid-template-columns: 1fr;
                max-width: 200px;
                gap: 12px;
            }

            .feature-card {
                padding: 12px;
            }

            .error-actions {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 200px;
            }

            /* Ultra-mobile iframe */
            .app-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                overflow: hidden;
            }

            .iframe-container {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
            }

            #mainIframe {
                position: absolute;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                border: 0;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
        }

        /* Landscape mobile */
        @media (max-width: 896px) and (orientation: landscape) and (max-height: 414px) {
            .app-container,
            .iframe-container,
            #mainIframe {
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
            }
        }

        /* Tablet adjustments */
        @media (min-width: 481px) and (max-width: 1024px) {
            .app-container {
                width: 100vw;
                height: 100vh;
            }

            #mainIframe {
                width: 100%;
                height: 100vh;
            }
        }

        /* Large screens */
        @media (min-width: 1025px) {
            .app-container {
                width: 100vw;
                height: 100vh;
            }

            #mainIframe {
                width: 100%;
                height: 100vh;
            }
        }

        /* === ACESSIBILIDADE === */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-color-scheme: dark) {
            .app-container,
            .iframe-container,
            #main-iframe {
                background: #111827;
            }

            .error-screen {
                background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
                color: white;
            }

            .error-title {
                color: white;
            }

            .error-message {
                color: #d1d5db;
            }
        }

        /* === PREVEN√á√ïES MOBILE === */
        .loading-container,
        .app-container {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Mobile keyboard adjustments */
        body.keyboard-open .app-container {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }

        body.keyboard-open #mainIframe {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }

        /* iOS specific fixes */
        @supports (-webkit-overflow-scrolling: touch) {
            .app-container {
                height: 100vh;
                height: var(--ios-vh, 100vh);
            }
            
            #mainIframe {
                height: 100vh;
                height: var(--ios-vh, 100vh);
            }
        }

        /* Prevent overscroll on mobile */
        @media (max-width: 768px) {
            body {
                overscroll-behavior: none;
                -webkit-overflow-scrolling: touch;
            }
            
            .app-container {
                overscroll-behavior: none;
                -webkit-overflow-scrolling: touch;
            }
            
            #mainIframe {
                overscroll-behavior: none;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Force hardware acceleration on mobile */
        @media (max-width: 768px) {
            .app-container,
            .iframe-container,
            #mainIframe {
                -webkit-transform: translateZ(0);
                -moz-transform: translateZ(0);
                -ms-transform: translateZ(0);
                -o-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
                -webkit-perspective: 1000;
                perspective: 1000;
            }
        }

        /* === ANIMA√á√ïES DE ENTRADA === */
        .loading-container > * {
            animation-fill-mode: both;
        }

        .progress-container {
            animation: slideUp 0.8s ease-out 0.5s both;
        }

        .loading-status {
            animation: slideUp 0.8s ease-out 0.7s both;
        }

        .features-grid {
            animation: slideUp 0.8s ease-out 0.9s both;
        }

        @keyframes slideUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-container" id="loadingScreen">
        <!-- Logo -->
        <div class="logo-container">
            <div class="logo-wrapper">
                <img src="https://i.ibb.co/vx4BtbSv/Sem-t-tulo-1.png" 
                     alt="C.F Logo" 
                     class="logo-img">
                <div class="status-badge">‚úì</div>
            </div>
        </div>

        <!-- T√≠tulo -->
        <h1 class="app-title">C.F</h1>
        <p class="app-subtitle">Controle Financeiro Profissional</p>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-track">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </div>

        <!-- Loading Status -->
        <div class="loading-status">
            <div class="status-text" id="statusText">Inicializando aplicativo...</div>
            <div class="loading-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>

        <!-- Features -->
        <div class="features-grid">
            <div class="feature-card">
                <span class="feature-icon">üîí</span>
                <span class="feature-label">Seguro</span>
            </div>
            <div class="feature-card">
                <span class="feature-icon">‚ö°</span>
                <span class="feature-label">R√°pido</span>
            </div>
            <div class="feature-card">
                <span class="feature-icon">üíé</span>
                <span class="feature-label">Premium</span>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <div class="iframe-container">
            <iframe
                id="mainIframe"
                src="https://script.google.com/macros/s/AKfycbzulAS8ZXRKAZpYg6JYN3G2mzrqQQpUmygQ42HWpzUbIbLb2kENEyIO3gWecQd9OFtsrA/exec"
                allow="autoplay; camera; microphone; fullscreen; geolocation; payment"
                allowfullscreen
                loading="eager"
                referrerpolicy="no-referrer-when-downgrade"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads allow-top-navigation allow-popups-to-escape-sandbox"
                title="Controle Financeiro">
            </iframe>
        </div>

        <!-- Error Screen -->
        <div class="error-screen" id="errorScreen">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 class="error-title">Servi√ßo Temporariamente Indispon√≠vel</h2>
            <p class="error-message">
                O sistema financeiro est√° passando por manuten√ß√£o ou h√° um problema de conectividade. 
                Isso pode acontecer devido a:
            </p>
            <ul style="text-align: left; margin: 20px 0; color: #6b7280; line-height: 1.6;">
                <li>üåê Problemas de conex√£o com a internet</li>
                <li>üîí Restri√ß√µes de seguran√ßa do navegador (CORS/X-Frame-Options)</li>
                <li>‚öôÔ∏è Manuten√ß√£o programada do Google Apps Script</li>
                <li>üõ°Ô∏è Configura√ß√µes de firewall ou antiv√≠rus</li>
                <li>üì± Bloqueios espec√≠ficos do dispositivo m√≥vel</li>
            </ul>
            <div class="error-actions">
                <button class="btn" onclick="retryConnection()">
                    üîÑ Tentar Novamente
                </button>
                <button class="btn secondary" onclick="openInNewTab()">
                    üöÄ Abrir em Nova Aba
                </button>
                <button class="btn" onclick="runFullDiagnostic()" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);">
                    üîç Diagn√≥stico Completo
                </button>
            </div>
        </div>
    </div>

    <!-- Install Button -->
    <button class="install-button" id="installBtn" aria-label="Instalar aplicativo">
        üì± Instalar App
    </button>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Configura√ß√µes
        const CONFIG = {
            IFRAME_URL: 'https://script.google.com/macros/s/AKfycbyCTfJwf15QR4HBDQI05nWoqimuqNsK2dOs1BoxoFcJ15JQYLSz248SCdCI_zhbfoMGKg/exec',
            LOADING_DURATION: 6000,
            RETRY_ATTEMPTS: 3,
            IFRAME_TIMEOUT: 20000,
            STEP_DELAY: 1200
        };

        // Estados
        let state = {
            currentRetry: 0,
            loadingProgress: 0,
            iframeLoaded: false,
            deferredPrompt: null
        };

        // Elementos DOM
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            statusText: document.getElementById('statusText'),
            mainIframe: document.getElementById('mainIframe'),
            errorScreen: document.getElementById('errorScreen'),
            installBtn: document.getElementById('installBtn'),
            toast: document.getElementById('toast')
        };

        // === LOADING SEQUENCE ===
        class LoadingController {
            constructor() {
                this.steps = [
                    { progress: 15, text: 'Inicializando sistema banc√°rio...', delay: 1000 },
                    { progress: 30, text: 'Conectando aos servi√ßos seguros...', delay: 1400 },
                    { progress: 45, text: 'Verificando certificados de seguran√ßa...', delay: 1200 },
                    { progress: 60, text: 'Carregando interface do usu√°rio...', delay: 1300 },
                    { progress: 75, text: 'Sincronizando dados financeiros...', delay: 1100 },
                    { progress: 90, text: 'Aplicando configura√ß√µes...', delay: 1000 },
                    { progress: 100, text: 'Finalizando carregamento...', delay: 800 }
                ];
                this.currentStep = 0;
                this.iframeSetup = false;
            }

            start() {
                console.log('üîÑ Iniciando sequ√™ncia de loading banc√°rio...');
                this.animateProgress();
            }

            animateProgress() {
                if (this.currentStep < this.steps.length) {
                    const step = this.steps[this.currentStep];
                    
                    // Animar progresso com delay realista
                    setTimeout(() => {
                        elements.progressBar.style.width = step.progress + '%';
                        elements.progressText.textContent = step.progress + '%';
                        elements.statusText.textContent = step.text;
                        state.loadingProgress = step.progress;
                        
                        console.log(`üìä Loading: ${step.progress}% - ${step.text}`);
                        
                        // Setup iframe aos 60% para come√ßar carregamento em paralelo
                        if (step.progress === 60 && !this.iframeSetup) {
                            this.setupIframeInBackground();
                        }
                    }, step.delay);

                    this.currentStep++;
                    setTimeout(() => this.animateProgress(), step.delay);
                } else {
                    // Finalizar loading com delay extra
                    setTimeout(() => {
                        this.complete();
                    }, 1200);
                }
            }

            setupIframeInBackground() {
                console.log('üîß Configurando iframe em background...');
                this.iframeSetup = true;
                
                // Verificar se iframe j√° existe
                if (!elements.mainIframe) {
                    console.error('‚ùå Elemento iframe n√£o encontrado!');
                    return;
                }

                // Configurar eventos antes de carregar
                elements.mainIframe.addEventListener('load', () => this.handleIframeLoad());
                elements.mainIframe.addEventListener('error', () => this.handleIframeError());
                
                // Diagnosticar problema potencial
                this.diagnoseIframeIssues();
                
                // Timeout para detectar falha de carregamento
                setTimeout(() => {
                    if (!state.iframeLoaded) {
                        console.warn('‚ö†Ô∏è Iframe timeout - n√£o carregou em tempo h√°bil');
                        this.handleIframeError();
                    }
                }, CONFIG.IFRAME_TIMEOUT);
            }

            diagnoseIframeIssues() {
                console.group('üîç Diagn√≥stico de Iframe');
                
                // Verificar URL
                console.log('üåê URL do iframe:', elements.mainIframe.src);
                
                // Verificar atributos
                console.log('üîí Sandbox:', elements.mainIframe.sandbox.toString());
                console.log('‚úÖ Allow:', elements.mainIframe.allow);
                
                // Verificar conectividade
                console.log('üì° Status online:', navigator.onLine);
                
                // Verificar protocolo
                console.log('üîê Protocolo:', window.location.protocol);
                
                // Teste de fetch
                fetch(CONFIG.IFRAME_URL, { 
                    method: 'HEAD', 
                    mode: 'no-cors' 
                })
                .then(() => {
                    console.log('‚úÖ URL √© acess√≠vel via fetch');
                })
                .catch(error => {
                    console.log('‚ùå URL n√£o acess√≠vel via fetch:', error.message);
                });
                
                // Verificar se √© poss√≠vel criar iframe
                const testIframe = document.createElement('iframe');
                console.log('üÜï Suporte a iframe:', !!testIframe);
                
                console.groupEnd();
            }

            complete() {
                console.log('‚úÖ Loading completo, iniciando aplica√ß√£o...');
                elements.statusText.textContent = 'Aplicativo pronto!';
                
                elements.loadingScreen.classList.add('fade-out');
                
                setTimeout(() => {
                    elements.loadingScreen.style.display = 'none';
                    
                    // Se iframe ainda n√£o foi configurado, fazer agora
                    if (!this.iframeSetup) {
                        this.setupIframeInBackground();
                    }
                    
                    // Verificar se carregou
                    setTimeout(() => {
                        if (!state.iframeLoaded) {
                            console.warn('‚ö†Ô∏è Iframe n√£o carregou ap√≥s finalizar loading');
                        }
                    }, 2000);
                }, 1000);
            }

            handleIframeLoad() {
                console.log('‚úÖ Iframe carregado com sucesso!');
                state.iframeLoaded = true;
                
                // Verificar se realmente tem conte√∫do
                try {
                    const iframeDoc = elements.mainIframe.contentDocument || elements.mainIframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body) {
                        console.log('üìÑ Conte√∫do do iframe acess√≠vel');
                        showToast('Aplicativo carregado com sucesso! üéâ', 'success');
                    } else {
                        console.log('‚ö†Ô∏è Iframe carregou mas conte√∫do n√£o acess√≠vel (CORS)');
                        showToast('Sistema carregado (modo seguro)', 'success');
                    }
                } catch (error) {
                    console.log('üîí Iframe carregado, mas conte√∫do protegido por CORS');
                    showToast('Sistema financeiro carregado!', 'success');
                }
            }

            handleIframeError() {
                console.error('‚ùå Erro cr√≠tico ao carregar iframe');
                state.iframeLoaded = false;
                
                // An√°lise detalhada do erro
                console.group('üîç An√°lise de Erro do Iframe');
                console.log('üåê URL atual:', elements.mainIframe.src);
                console.log('üì° Status de rede:', navigator.onLine ? 'Online' : 'Offline');
                console.log('üîÑ Tentativas anteriores:', state.currentRetry);
                console.log('‚è±Ô∏è Timeout configurado:', CONFIG.IFRAME_TIMEOUT + 'ms');
                console.groupEnd();
                
                elements.errorScreen.classList.add('show');
                showToast('Erro ao carregar aplicativo financeiro', 'error');
            }
        }

        // === UTILITY FUNCTIONS ===
        function showToast(message, type = 'info') {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type}`;
            elements.toast.classList.add('show');

            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 4000);
        }

        function retryConnection() {
            if (state.currentRetry < CONFIG.RETRY_ATTEMPTS) {
                state.currentRetry++;
                elements.errorScreen.classList.remove('show');
                
                console.log(`üîÑ Tentativa de reconex√£o ${state.currentRetry}/${CONFIG.RETRY_ATTEMPTS}`);
                showToast(`Tentando reconectar... (${state.currentRetry}/${CONFIG.RETRY_ATTEMPTS})`, 'warning');
                
                // Criar nova URL com par√¢metros para evitar cache
                const timestamp = Date.now();
                const randomParam = Math.random().toString(36).substring(7);
                const newUrl = `${CONFIG.IFRAME_URL}?retry=${state.currentRetry}&t=${timestamp}&r=${randomParam}`;
                
                console.log('üåê Nova URL:', newUrl);
                
                // Criar novo iframe completamente
                const iframe = document.createElement('iframe');
                iframe.id = 'mainIframe';
                iframe.src = newUrl;
                iframe.allow = 'autoplay; camera; microphone; fullscreen; geolocation; payment';
                iframe.allowFullscreen = true;
                iframe.loading = 'eager';
                iframe.referrerPolicy = 'no-referrer-when-downgrade';
                iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads allow-top-navigation allow-popups-to-escape-sandbox';
                iframe.title = 'Controle Financeiro';
                
                // Estilos responsivos do iframe
                iframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    min-height: 100vh;
                    min-height: calc(var(--vh, 1vh) * 100);
                    border: none;
                    background: #f8fafc;
                    display: block;
                    position: absolute;
                    top: 0;
                    left: 0;
                    margin: 0;
                    padding: 0;
                    overflow: hidden;
                `;
                
                // Eventos detalhados
                iframe.addEventListener('load', () => {
                    console.log('‚úÖ Reconex√£o bem-sucedida!');
                    state.iframeLoaded = true;
                    showToast('Reconectado com sucesso! üéâ', 'success');
                    
                    // Verificar conte√∫do
                    setTimeout(() => {
                        try {
                            const doc = iframe.contentDocument || iframe.contentWindow.document;
                            if (doc && doc.body && doc.body.innerHTML.trim()) {
                                console.log('üìÑ Conte√∫do verificado no iframe');
                            } else {
                                console.log('‚ö†Ô∏è Iframe sem conte√∫do vis√≠vel');
                            }
                        } catch (e) {
                            console.log('üîí Conte√∫do protegido por CORS (normal para Google Apps Script)');
                        }
                    }, 1000);
                });
                
                iframe.addEventListener('error', () => {
                    console.error(`‚ùå Falha na tentativa ${state.currentRetry}`);
                    setTimeout(() => {
                        if (state.currentRetry >= CONFIG.RETRY_ATTEMPTS) {
                            showToast('Todas as tentativas falharam. Tente abrir em nova aba.', 'error');
                        }
                        elements.errorScreen.classList.add('show');
                    }, 1500);
                });
                
                // Timeout espec√≠fico para esta tentativa
                const timeoutId = setTimeout(() => {
                    if (!state.iframeLoaded) {
                        console.warn(`‚è±Ô∏è Timeout na tentativa ${state.currentRetry}`);
                        if (state.currentRetry < CONFIG.RETRY_ATTEMPTS) {
                            showToast(`Tentativa ${state.currentRetry} expirou, tentando novamente...`, 'warning');
                        } else {
                            showToast('Timeout. Verifique sua conex√£o.', 'error');
                        }
                        elements.errorScreen.classList.add('show');
                    }
                }, CONFIG.IFRAME_TIMEOUT);
                
                // Limpar timeout se carregar com sucesso
                iframe.addEventListener('load', () => {
                    clearTimeout(timeoutId);
                });
                
                // Substituir iframe
                const container = elements.mainIframe.parentNode;
                container.removeChild(elements.mainIframe);
                container.appendChild(iframe);
                elements.mainIframe = iframe;
                
                // Reset estado
                state.iframeLoaded = false;
                
            } else {
                console.error('üö´ Limite de tentativas excedido');
                showToast('Limite de tentativas excedido. Use "Abrir em Nova Aba".', 'error');
            }
        }

        function openInNewTab() {
            const timestamp = Date.now();
            const url = `${CONFIG.IFRAME_URL}?direct=true&t=${timestamp}`;
            
            console.log('üîó Abrindo em nova aba:', url);
            
            const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
            
            if (newWindow) {
                showToast('Abrindo sistema em nova aba... üöÄ', 'success');
                
                // Verificar se a janela foi fechada (popup bloqueado)
                setTimeout(() => {
                    if (newWindow.closed) {
                        showToast('A nova aba foi fechada', 'warning');
                    } else {
                        showToast('Se o sistema carregar na nova aba, o problema √© espec√≠fico do iframe', 'info');
                    }
                }, 3000);
            } else {
                console.error('‚ùå Popup foi bloqueado');
                showToast('Popup bloqueado. Permita popups para este site nas configura√ß√µes do navegador.', 'error');
                
                // Fallback: tentar com window.location
                setTimeout(() => {
                    if (confirm('Popup bloqueado. Deseja tentar abrir na mesma aba?')) {
                        window.location.href = url;
                    }
                }, 1000);
            }
        }

        // === PWA FUNCTIONALITY ===
        function setupPWA() {
            // Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registrado:', registration);
                    })
                    .catch(error => {
                        console.log('SW falhou:', error);
                    });
            }

            // Install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                elements.installBtn.style.display = 'block';
                elements.installBtn.classList.add('show');
            });

            // Install button
            elements.installBtn.addEventListener('click', async () => {
                if (!state.deferredPrompt) {
                    showToast('Instala√ß√£o n√£o dispon√≠vel', 'warning');
                    return;
                }

                try {
                    const result = await state.deferredPrompt.prompt();
                    
                    if (result.outcome === 'accepted') {
                        showToast('App instalado com sucesso!', 'success');
                        elements.installBtn.style.display = 'none';
                    } else {
                        showToast('Instala√ß√£o cancelada', 'info');
                    }
                } catch (error) {
                    console.error('Erro na instala√ß√£o:', error);
                    showToast('Erro na instala√ß√£o', 'error');
                }

                state.deferredPrompt = null;
            });

            // App installed
            window.addEventListener('appinstalled', () => {
                elements.installBtn.style.display = 'none';
                showToast('App instalado! Acesse pela tela inicial.', 'success');
            });

            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                elements.installBtn.style.display = 'none';
            }
        }

        // === CONNECTIVITY ===
        function setupConnectivity() {
            window.addEventListener('online', () => {
                showToast('Conex√£o restaurada!', 'success');
                if (!state.iframeLoaded) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            });

            window.addEventListener('offline', () => {
                showToast('Voc√™ est√° offline', 'warning');
            });

            // Check initial connection
            if (!navigator.onLine) {
                showToast('Sem conex√£o com a internet', 'error');
            }
        }

        // === MOBILE OPTIMIZATIONS ===
        function setupMobile() {
            // Viewport height fix for mobile - Critical for iframe responsiveness
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Log for debugging
                console.log(`üì± Viewport height set: ${window.innerHeight}px (--vh: ${vh}px)`);
                
                // Force iframe recalculation on mobile
                const iframe = elements.mainIframe;
                if (iframe && window.innerWidth <= 768) {
                    iframe.style.height = `${window.innerHeight}px`;
                    iframe.style.minHeight = `calc(var(--vh, 1vh) * 100)`;
                }
            }

            // Set initial viewport height
            setViewportHeight();
            
            // Update on resize and orientation change
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    setViewportHeight();
                    ensureIframeResponsiveness();
                }, 100);
            });
            
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    setViewportHeight();
                    ensureIframeResponsiveness();
                }, 300);
            });
            
            // Additional mobile-specific events
            window.addEventListener('load', setViewportHeight);
            
            // Prevent zoom on inputs
            document.addEventListener('touchstart', () => {});
            
            // Prevent text selection (except inputs)
            document.addEventListener('selectstart', (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });

            // Prevent gesture zoom
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });

            // Prevent double-tap zoom
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // iOS specific fixes
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                console.log('üçé iOS device detected - applying specific fixes');
                
                // Prevent iOS safari bounce
                document.body.addEventListener('touchmove', (e) => {
                    if (e.target === document.body || e.target === document.documentElement) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Fix for iOS viewport units
                document.documentElement.style.setProperty('--ios-vh', `${window.innerHeight}px`);
            }

            // Android specific fixes
            if (/Android/.test(navigator.userAgent)) {
                console.log('ü§ñ Android device detected - applying specific fixes');
                
                // Handle keyboard opening/closing
                let initialViewportHeight = window.innerHeight;
                window.addEventListener('resize', () => {
                    const currentHeight = window.innerHeight;
                    const heightDifference = initialViewportHeight - currentHeight;
                    
                    if (heightDifference > 150) {
                        // Keyboard likely opened
                        console.log('‚å®Ô∏è Keyboard opened');
                        document.body.classList.add('keyboard-open');
                    } else {
                        // Keyboard likely closed
                        console.log('‚å®Ô∏è Keyboard closed');
                        document.body.classList.remove('keyboard-open');
                        setViewportHeight();
                    }
                });
            }

            // Monitor iframe loading on mobile
            if (window.innerWidth <= 768) {
                console.log('üì± Mobile device detected - monitoring iframe responsiveness');
                
                const checkIframeResponsiveness = () => {
                    const iframe = elements.mainIframe;
                    if (iframe) {
                        const rect = iframe.getBoundingClientRect();
                        console.log(`üìê Iframe dimensions: ${rect.width}x${rect.height}`);
                        console.log(`üìê Window dimensions: ${window.innerWidth}x${window.innerHeight}`);
                        
                        // Ensure iframe fills screen on mobile
                        if (rect.width < window.innerWidth * 0.9 || rect.height < window.innerHeight * 0.9) {
                            console.warn('‚ö†Ô∏è Iframe not filling screen properly, adjusting...');
                            iframe.style.width = '100vw';
                            iframe.style.height = '100vh';
                            iframe.style.position = 'fixed';
                            iframe.style.top = '0';
                            iframe.style.left = '0';
                        }
                    }
                };
                
                // Check responsiveness after iframe loads
                setTimeout(checkIframeResponsiveness, 2000);
                setTimeout(checkIframeResponsiveness, 5000);
            }
        }

        // === ACCESSIBILITY ===
        function setupAccessibility() {
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (elements.errorScreen.classList.contains('show')) {
                        elements.errorScreen.classList.remove('show');
                    }
                }
            });

            // Focus management
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    document.body.classList.add('keyboard-navigation');
                }
            });

            document.addEventListener('mousedown', () => {
                document.body.classList.remove('keyboard-navigation');
            });
        }

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            console.clear();
            console.log('%cüè¶ C.F - Controle Financeiro v2.0', 'background: linear-gradient(90deg, #1e3a8a, #3730a3); color: white; padding: 10px 20px; border-radius: 8px; font-size: 16px; font-weight: bold;');
            console.log('üöÄ Sistema banc√°rio profissional iniciando...');
            
            // Debug inicial
            console.group('üîç Informa√ß√µes do Sistema');
            console.log('üåê URL do iframe:', CONFIG.IFRAME_URL);
            console.log('üì± User Agent:', navigator.userAgent);
            console.log('üîó URL atual:', window.location.href);
            console.log('üîê Protocolo:', window.location.protocol);
            console.log('üì° Status online:', navigator.onLine);
            console.log('üç™ Cookies habilitados:', navigator.cookieEnabled);
            console.log('üì∫ Resolu√ß√£o:', window.screen.width + 'x' + window.screen.height);
            console.log('üñºÔ∏è Viewport:', window.innerWidth + 'x' + window.innerHeight);
            console.groupEnd();
            
            // Verifica√ß√µes de compatibilidade
            console.group('üîß Verifica√ß√µes de Compatibilidade');
            console.log('iframe support:', document.createElement('iframe') ? '‚úÖ' : '‚ùå');
            console.log('localStorage:', typeof localStorage !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('sessionStorage:', typeof sessionStorage !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('Service Worker:', 'serviceWorker' in navigator ? '‚úÖ' : '‚ùå');
            console.log('Fetch API:', 'fetch' in window ? '‚úÖ' : '‚ùå');
            console.log('ES6 Support:', (() => { try { new Function('() => {}'); return '‚úÖ'; } catch { return '‚ùå'; } })());
            console.groupEnd();
            
            // Teste inicial de conectividade
            testInitialConnectivity();
            
            // Setup
            setupPWA();
            setupConnectivity();
            setupMobile();
            setupAccessibility();
            
            // Start loading com delay para visualizar
            setTimeout(() => {
                const loader = new LoadingController();
                loader.start();
                
                // Ensure iframe responsiveness from start
                ensureIframeResponsiveness();
            }, 500);
        });

        // Fun√ß√£o para garantir responsividade do iframe
        function ensureIframeResponsiveness() {
            const iframe = elements.mainIframe;
            if (!iframe) {
                console.warn('‚ö†Ô∏è Iframe n√£o encontrado para configura√ß√£o responsiva');
                return;
            }
            
            console.log('üì± Configurando responsividade do iframe...');
            
            // For√ßar estilos responsivos
            iframe.style.cssText = `
                width: 100vw !important;
                height: 100vh !important;
                min-height: calc(var(--vh, 1vh) * 100) !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                background: #f8fafc !important;
                display: block !important;
                overflow: hidden !important;
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
            `;
            
            // Configurar container tamb√©m
            const container = iframe.parentElement;
            if (container) {
                container.style.cssText = `
                    width: 100vw !important;
                    height: 100vh !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    overflow: hidden !important;
                `;
            }
            
            console.log('‚úÖ Iframe configurado para responsividade total');
            
            // Monitor iframe size changes
            if ('ResizeObserver' in window) {
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const { width, height } = entry.contentRect;
                        console.log(`üìê Iframe resized: ${width}x${height}`);
                        
                        // Re-apply responsive styles if needed
                        if (width < window.innerWidth * 0.95 || height < window.innerHeight * 0.95) {
                            console.log('üîÑ Re-applying responsive styles...');
                            ensureIframeResponsiveness();
                        }
                    }
                });
                
                resizeObserver.observe(iframe);
                console.log('üëÅÔ∏è ResizeObserver configurado para monitorar iframe');
            }
        }

        // Teste de conectividade inicial
        async function testInitialConnectivity() {
            console.group('üåê Teste de Conectividade Inicial');
            
            try {
                // Teste 1: Google (b√°sico)
                const googleTest = await fetch('https://www.google.com/favicon.ico', { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                console.log('Google.com:', '‚úÖ Acess√≠vel');
            } catch (error) {
                console.log('Google.com:', '‚ùå Inacess√≠vel -', error.message);
            }
            
            try {
                // Teste 2: Script do Google Apps
                const scriptTest = await fetch(CONFIG.IFRAME_URL, { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                console.log('Google Apps Script:', '‚úÖ Servidor responde');
            } catch (error) {
                console.log('Google Apps Script:', '‚ùå Servidor n√£o responde -', error.message);
            }
            
            // Teste 3: DNS
            try {
                const dnsTest = await fetch('https://script.google.com/favicon.ico', { 
                    method: 'HEAD', 
                    mode: 'no-cors' 
                });
                console.log('DNS script.google.com:', '‚úÖ Resolvido');
            } catch (error) {
                console.log('DNS script.google.com:', '‚ùå N√£o resolvido -', error.message);
            }
            
            console.groupEnd();
        }

        // === ERROR HANDLING ===
        window.addEventListener('error', (event) => {
            console.error('Erro global capturado:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promise rejeitada:', event.reason);
        });

        // === DIAGN√ìSTICO COMPLETO ===
        async function runFullDiagnostic() {
            console.clear();
            console.log('%cüîç DIAGN√ìSTICO COMPLETO DO SISTEMA', 'background: #7c3aed; color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold;');
            
            showToast('Executando diagn√≥stico completo...', 'info');
            
            const results = {
                browser: {},
                network: {},
                iframe: {},
                security: {}
            };
            
            // 1. Informa√ß√µes do Navegador
            console.group('üåê An√°lise do Navegador');
            results.browser = {
                userAgent: navigator.userAgent,
                cookiesEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                language: navigator.language,
                platform: navigator.platform,
                protocol: window.location.protocol,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                screen: `${window.screen.width}x${window.screen.height}`
            };
            
            Object.entries(results.browser).forEach(([key, value]) => {
                console.log(`${key}:`, value);
            });
            console.groupEnd();
            
            // 2. Testes de Rede
            console.group('üì° Testes de Conectividade');
            const networkTests = [
                { name: 'Google DNS', url: 'https://dns.google', expected: 'Acess√≠vel' },
                { name: 'Google Main', url: 'https://www.google.com/favicon.ico', expected: 'Acess√≠vel' },
                { name: 'Google Apps Script Domain', url: 'https://script.google.com/favicon.ico', expected: 'Acess√≠vel' },
                { name: 'Target URL', url: CONFIG.IFRAME_URL, expected: 'Responde' }
            ];
            
            for (const test of networkTests) {
                try {
                    const start = performance.now();
                    await fetch(test.url, { method: 'HEAD', mode: 'no-cors', cache: 'no-cache' });
                    const time = Math.round(performance.now() - start);
                    console.log(`‚úÖ ${test.name}: ${test.expected} (${time}ms)`);
                    results.network[test.name] = { status: 'success', time };
                } catch (error) {
                    console.log(`‚ùå ${test.name}: ${error.message}`);
                    results.network[test.name] = { status: 'error', error: error.message };
                }
            }
            console.groupEnd();
            
            // 3. Teste de Iframe
            console.group('üñºÔ∏è An√°lise de Iframe');
            const iframe = elements.mainIframe;
            results.iframe = {
                exists: !!iframe,
                src: iframe?.src || 'N/A',
                sandbox: iframe?.sandbox?.toString() || 'N/A',
                allow: iframe?.allow || 'N/A',
                loaded: state.iframeLoaded,
                retries: state.currentRetry
            };
            
            Object.entries(results.iframe).forEach(([key, value]) => {
                console.log(`${key}:`, value);
            });
            
            // Teste de cria√ß√£o de iframe
            try {
                const testIframe = document.createElement('iframe');
                testIframe.src = 'data:text/html,<h1>Test</h1>';
                console.log('‚úÖ Cria√ß√£o de iframe: Suportada');
                results.iframe.creationSupported = true;
            } catch (error) {
                console.log('‚ùå Cria√ß√£o de iframe:', error.message);
                results.iframe.creationSupported = false;
            }
            console.groupEnd();
            
            // 4. Verifica√ß√µes de Seguran√ßa
            console.group('üîí Verifica√ß√µes de Seguran√ßa');
            results.security = {
                https: window.location.protocol === 'https:',
                mixedContent: window.location.protocol === 'https:' && CONFIG.IFRAME_URL.startsWith('http:'),
                thirdPartyCookies: 'N√£o testado',
                corsEnabled: 'Testando...'
            };
            
            // Teste de CORS
            try {
                await fetch(CONFIG.IFRAME_URL, { method: 'GET', mode: 'cors' });
                results.security.corsEnabled = 'Permitido';
                console.log('‚úÖ CORS: Permitido');
            } catch (error) {
                results.security.corsEnabled = 'Bloqueado: ' + error.message;
                console.log('‚ùå CORS: Bloqueado -', error.message);
            }
            
            Object.entries(results.security).forEach(([key, value]) => {
                console.log(`${key}:`, value);
            });
            console.groupEnd();
            
            // 5. Relat√≥rio Final
            console.group('üìã Relat√≥rio e Recomenda√ß√µes');
            
            // Analisar problemas prov√°veis
            const issues = [];
            const solutions = [];
            
            if (!results.browser.onLine) {
                issues.push('‚ùå Sem conex√£o com internet');
                solutions.push('Verificar conex√£o de rede');
            }
            
            if (results.browser.protocol === 'http:') {
                issues.push('‚ö†Ô∏è P√°gina carregada via HTTP (n√£o seguro)');
                solutions.push('Usar HTTPS sempre que poss√≠vel');
            }
            
            if (results.security.corsEnabled.includes('Bloqueado')) {
                issues.push('‚ùå CORS bloqueado pelo servidor');
                solutions.push('Normal para Google Apps Script - usar iframe √© a solu√ß√£o correta');
            }
            
            if (!results.iframe.loaded && state.currentRetry > 0) {
                issues.push('‚ùå Iframe falhou em m√∫ltiplas tentativas');
                solutions.push('Problema provavelmente no servidor Google Apps Script');
            }
            
            if (results.browser.userAgent.includes('Mobile')) {
                issues.push('üì± Dispositivo m√≥vel detectado');
                solutions.push('Alguns provedores m√≥veis bloqueiam Google Apps Script');
            }
            
            console.log('üîç Problemas identificados:', issues.length > 0 ? issues : ['‚úÖ Nenhum problema √≥bvio detectado']);
            console.log('üí° Solu√ß√µes sugeridas:', solutions.length > 0 ? solutions : ['Sistema parece estar funcionando']);
            
            // Recomenda√ß√£o final
            if (!navigator.onLine) {
                console.log('üéØ RECOMENDA√á√ÉO: Verificar conex√£o de internet');
            } else if (results.security.corsEnabled.includes('Bloqueado') && !state.iframeLoaded) {
                console.log('üéØ RECOMENDA√á√ÉO: Tentar abrir em nova aba - pode ser X-Frame-Options');
            } else if (state.currentRetry >= CONFIG.RETRY_ATTEMPTS) {
                console.log('üéØ RECOMENDA√á√ÉO: Servidor Google Apps Script pode estar indispon√≠vel');
            } else {
                console.log('üéØ RECOMENDA√á√ÉO: Tentar novamente - problemas tempor√°rios');
            }
            
            console.groupEnd();
            
            showToast('Diagn√≥stico completo finalizado. Veja o console (F12) para detalhes.', 'success');
        }
    </script>
</body>
</html>
    </script>
</body>
</html>
