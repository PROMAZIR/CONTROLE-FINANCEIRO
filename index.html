<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarkTech - Sistema de Credi√°rio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Credi√°rio Inteligente - Gerencie seus credi√°rios de forma simples e eficiente">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StarkTech">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüõí%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüõí%3C/text%3E%3C/svg%3E">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .mode-toggle {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .mode-toggle:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 2rem;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .login-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .login-tab.active {
            background: #3498db;
            color: white;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-btn {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
            position: relative;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .login-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #7f8c8d;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ecf0f1;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .progress-bar {
            background: #ecf0f1;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            transition: width 0.8s ease;
        }

        .amounts {
            display: flex;
            justify-content: space-between;
            margin: 1rem 0;
        }

        .amount-paid {
            color: #2ecc71;
            font-weight: bold;
        }

        .amount-remaining {
            color: #e74c3c;
            font-weight: bold;
        }

        .action-btn {
            width: 100%;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Admin Panel */
        .admin-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-controls {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row input, .form-row select {
            padding: 0.8rem;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-row input:focus, .form-row select:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #2ecc71;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #f39c12;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #e74c3c;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ecf0f1;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
        }

        .installment {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .installment.paid {
            background: #d4edda;
            border-left: 4px solid #2ecc71;
        }

        .installment.overdue {
            background: #f8d7da;
            border-left: 4px solid #e74c3c;
        }

        .installment.pending {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }

        /* Status Indicator */
        .sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 0.8rem 1.2rem;
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
            z-index: 1001;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .sync-success { background: #2ecc71; }
        .sync-error { background: #e74c3c; }
        .sync-loading { background: #f39c12; }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats-grid, .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1rem;
            }

            .login-card {
                margin: 1rem;
                padding: 2rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card, .stat-card {
            animation: fadeIn 0.5s ease-out;
        }
        /* Estilos para feedback visual de formata√ß√£o */
.form-group input {
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-group input:focus {
    outline: none;
}

.form-group input::placeholder {
    color: #999;
    font-size: 0.9rem;
}

/* Bot√µes do painel de formata√ß√£o */
.format-btn {
    background: linear-gradient(45deg, #3498db, #2ecc71);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
}

.format-btn:hover {
    background: linear-gradient(45deg, #2ecc71, #3498db);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.test-btn {
    background: linear-gradient(45deg, #9b59b6, #8e44ad);
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.85rem;
    width: 100%;
    margin-bottom: 0.5rem;
}

.test-btn:hover {
    background: linear-gradient(45deg, #8e44ad, #9b59b6);
    transform: translateY(-1px);
}

.diagnostic-btn {
    background: linear-gradient(45deg, #e67e22, #f39c12);
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.85rem;
    width: 100%;
}

.diagnostic-btn:hover {
    background: linear-gradient(45deg, #f39c12, #e67e22);
    transform: translateY(-1px);
}

/* Painel de ferramentas */
.format-tools-panel {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #3498db;
}

.format-tools-panel h4 {
    margin-bottom: 1rem;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
        /* ESTILOS ADICIONAIS PARA PAGAMENTOS */

.payment-button {
    background: linear-gradient(45deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.payment-button:hover {
    background: linear-gradient(45deg, #2ecc71, #27ae60);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
}

.payment-modal {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.payment-url-display {
    background: rgba(255, 255, 255, 0.1);
    border: 2px dashed rgba(255, 255, 255, 0.3);
    padding: 1rem;
    border-radius: 10px;
    word-break: break-all;
    font-family: monospace;
    font-size: 0.8rem;
    color: #2c3e50;
            margin: 1rem 0;
        }
}
.payment-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .no-payment-url {
            background: rgba(220, 53, 69, 0.1);
            border: 2px dashed #dc3545;
            color: #dc3545;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
        }

        /* Indicador de status do link */
        .payment-status {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-weight: bold;
        }

        .payment-status.available {
            background: #d4edda;
            color: #155724;
        }

        .payment-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-status.loading {
            background: #fff3cd;
            color: #856404;
        }

.installment {
    position: relative;
    overflow: hidden;
}

.installment::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: #ecf0f1;
}

.installment.paid::before {
    background: #2ecc71;
}

.installment.overdue::before {
    background: #e74c3c;
}

.installment.pending::before {
    background: #f39c12;
}

/* Recupera√ß√£o compacta via WhatsApp */
.forgot-password-container {
    text-align: center;
    margin-top: 0.8rem;
    padding-top: 0.8rem;
    border-top: 1px solid #ecf0f1;
}

.whatsapp-recovery-btn {
    background: linear-gradient(45deg, #25d366, #128c7e);
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
}

.whatsapp-recovery-btn:hover {
    background: linear-gradient(45deg, #128c7e, #25d366);
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
    box-shadow: 0 3px 12px rgba(37, 211, 102, 0.4);
}

.recovery-hint {
    color: #6c757d;
    font-size: 0.75rem;
    margin-top: 0.4rem;
}

/* Modais Customizados - Corre√ß√£o Sandboxed */
.custom-confirm-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.7) !important;
    z-index: 999999 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.custom-alert-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.5) !important;
    z-index: 999998 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem;">Carregando...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 class="login-title">üõí StarkTech</h1>
            <p class="login-subtitle">Sistema de Credi√°rio</p>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchTab('client')">Cliente</button>
                <button class="login-tab" onclick="switchTab('admin')">Administrador</button>
            </div>

            <!-- FORMUL√ÅRIO DE LOGIN COM RECUPERA√á√ÉO COMPACTA -->
<form id="clientForm" class="login-form active">
    <div class="form-group">
        <label>CPF/CNPJ</label>
        <input type="text" id="clientIdentifier" placeholder="000.000.000-00 ou email@exemplo.com" required>
        <small style="color: #7f8c8d; font-size: 0.8rem; margin-top: 0.3rem; display: block;">
            ‚úÖ CPF: 000.000.000-00
        </small>
    </div>
    <div class="form-group">
        <label>Senha:</label>
        <input type="password" id="clientPassword" placeholder="Digite sua senha" required>
    </div>
    <button type="submit" class="login-btn">Entrar</button>
    
    <!-- ‚úÖ RECUPERA√á√ÉO COMPACTA VIA WHATSAPP -->
    <div class="forgot-password-container">
        <a href="#" class="whatsapp-recovery-btn" onclick="abrirRecuperacaoWhatsApp(); return false;">
            üì± Esqueci minha senha
        </a>
        <div class="recovery-hint">
            Recupere via WhatsApp em segundos
        </div>
    </div>
    
    <!-- ‚úÖ SE√á√ÉO SIMPLIFICADA - S√ì LOJAS PARCEIRAS -->
    <div style="text-align: center; margin-top: 2rem;">
        <div style="border-top: 1px solid #ecf0f1; padding-top: 1.5rem;">
            <h4 style="color: #2c3e50; margin-bottom: 1rem; font-size: 1rem;">üè™ Lojas Parceiras</h4>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
                <a href="https://minhaloja.boticario.com.br/srwhite/" target="_blank" 
                   style="background: linear-gradient(135deg, #e67e22, #d35400); color: white; text-decoration: none; padding: 0.8rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: bold; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; min-width: 160px; justify-content: center; box-shadow: 0 2px 10px rgba(230, 126, 34, 0.3);"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(230, 126, 34, 0.4)'"
                   onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 10px rgba(230, 126, 34, 0.3)'">
                    üíÑ O Botic√°rio
                </a>
                
                <a href="https://www.natura.com.br/consultoria/srwhite" target="_blank" 
                   style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; text-decoration: none; padding: 0.8rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: bold; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; min-width: 160px; justify-content: center; box-shadow: 0 2px 10px rgba(39, 174, 96, 0.3);"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(39, 174, 96, 0.4)'"
                   onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 10px rgba(39, 174, 96, 0.3)'">
                    üåø Natura
                </a>
            </div>
            
            <small style="color: #7f8c8d; font-size: 0.8rem;">
                Consultor: <strong>Sr¬∞White</strong>
            </small>
        </div>
        
        <!-- ‚úÖ CR√âDITOS STARKTECH COMPACTOS -->
        <div style="margin-top: 1.5rem; padding: 0.8rem; background: linear-gradient(135deg, rgba(52, 152, 219, 0.08), rgba(155, 89, 182, 0.08)); border-radius: 10px; border-left: 3px solid #3498db;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.4rem; margin-bottom: 0.3rem;">
                <span style="font-size: 1rem;">‚ö°</span>
                <strong style="color: #3498db; font-size: 0.95rem;">StarkTech</strong>
                <span style="font-size: 1rem;">‚ö°</span>
            </div>
            <div style="color: #7f8c8d; font-size: 0.75rem; font-weight: 500;">
                Sistema de Credi√°rio Inteligente
            </div>
        </div>
    </div>
</form>

            <!-- Login Admin -->
            <form id="adminForm" class="login-form">
                <div class="form-group">
                    <label>Usu√°rio:</label>
                    <input type="text" id="adminUser" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>Senha:</label>
                    <input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="login-btn">Entrar no Painel Admin</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <div class="logo">üõí StarkTech</div>
            <div class="user-info">
                <span id="userName">Usu√°rio</span>
                <button class="mode-toggle" id="modeToggle" onclick="toggleMode()" style="display: none;">Trocar Modo</button>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="container">
            <!-- Cliente Dashboard -->
            <div id="clientDashboard" class="dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí≥</div>
                        <div class="stat-value" id="totalCredits">0</div>
                        <div class="stat-label">Credi√°rios Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="totalDebt">R$ 0,00</div>
                        <div class="stat-label">Total em Aberto</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-value" id="overdueCount">0</div>
                        <div class="stat-label">Parcelas Vencidas</div>
                    </div>
                </div>

                <div class="cards-grid" id="clientCards">
                    <!-- Cards ser√£o gerados dinamicamente -->
                    </div>
            </div>
        </div>
    </div>

            <!-- Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detalhes</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">Carregando... </div>
        </div>
    </div>

            <!-- PAINEL ADMINISTRATIVO REORGANIZADO -->
<div id="adminDashboard" class="dashboard">
    
    <!-- ========================================
         DASHBOARD RESUMO - TOPO
         ======================================== -->
    <div class="admin-section">
        <h2 class="section-title">üìä Dashboard Administrativo</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalClients">0</div>
                <div class="stat-label">Total de Clientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="totalReceivable">R$ 0,00</div>
                <div class="stat-label">Total a Receber</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-value" id="adminOverdueCount">0</div>
                <div class="stat-label">Parcelas Vencidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value" id="collectionRate">0%</div>
                <div class="stat-label">Taxa de Cobran√ßa</div>
            </div>
        </div>
    </div>

    <!-- ========================================
         SE√á√ÉO DE ABAS NAVEG√ÅVEIS
         ======================================== -->
    <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchAdminTabWithApprovals('clientes')">üë• Clientes</button>
        <button class="admin-tab" onclick="switchAdminTabWithApprovals('creditos')">üí≥ Credi√°rios</button>
        <button class="admin-tab" onclick="switchAdminTabWithApprovals('senhas')">üîë Senhas</button>
        <button class="admin-tab" onclick="switchAdminTabWithApprovals('relatorios')">üìä Relat√≥rios</button>
    </div>

    <!-- ========================================
         ABA CLIENTES
         ======================================== -->
    <div id="adminTab-clientes" class="admin-tab-content active">
        <div class="admin-controls">
            <h3>üë• Gest√£o de Clientes</h3>
            
            <div class="admin-grid">
                <!-- Cadastro de Novo Cliente -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>‚ûï Cadastrar Novo Cliente</h4>
                        <small>Adicione um novo cliente ao sistema</small>
                    </div>
                    <form id="newClientForm">
                        <div class="form-group">
                            <label>Nome Completo</label>
                            <input type="text" id="newClientName" placeholder="Jo√£o Silva" required>
                        </div>
                        <div class="form-group">
                            <label>CPF/CNPJ</label>
                            <input type="text" id="newClientCpf" placeholder="000.000.000-00" required>
                        </div>
                        <div class="form-group">
                            <label>E-mail</label>
                            <input type="email" id="newClientEmail" placeholder="joao@email.com">
                        </div>
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="tel" id="newClientPhone" placeholder="(00) 00000-0000">
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input type="password" id="newClientPassword" placeholder="Digite uma senha" required>
                        </div>
                        <button type="submit" class="action-btn btn-success">
                            ‚ûï Cadastrar Cliente
                        </button>
                    </form>
                </div>

                <!-- Lista de Clientes Existentes -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>üìã Clientes Cadastrados</h4>
                        <small>Gerencie clientes existentes</small>
                    </div>
                    
                    <div class="client-actions">
                        <button class="action-btn btn-primary" onclick="refreshClientsList()" style="flex: 1;">
                            üîÑ Atualizar Lista
                        </button>
                        <button class="action-btn btn-warning" onclick="exportClients()" style="flex: 1;">
                            üì§ Exportar
                        </button>
                    </div>
                    
                    <div id="clientsList" class="clients-list">
                        <!-- Lista ser√° preenchida dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         ABA CREDI√ÅRIOS
         ======================================== -->
    <div id="adminTab-creditos" class="admin-tab-content">
        <div class="admin-controls">
            <h3>üí≥ Gest√£o de Credi√°rios</h3>
            
            <div class="admin-card">
                <div class="admin-card-header">
                    <h4>‚ûï Criar Novo Credi√°rio</h4>
                    <small>Configure um novo credi√°rio para um cliente</small>
                </div>
                
                <form id="newCreditForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="selectClient" required>
                                <option value="">Selecione o Cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nome do Produto</label>
                            <input type="text" id="newProductName" placeholder="Ex: Kit Natura Una" required>
                        </div>
                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <input type="text" id="newProductDescription" placeholder="Descri√ß√£o detalhada" required>
                        </div>
                        <div class="form-group">
                            <label>Emoji do Produto</label>
                            <input type="text" id="newProductEmoji" placeholder="üõí" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>Valor Total (R$)</label>
                            <input type="number" id="newTotalValue" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>N√∫mero de Parcelas</label>
                            <input type="number" id="newInstallments" placeholder="12" min="1" max="60" required>
                        </div>
                        <div class="form-group">
                            <label>Data da Compra</label>
                            <input type="date" id="newPurchaseDate" required>
                        </div>
                        <div class="form-group">
                            <label>Nome da Loja</label>
                            <input type="text" id="newStoreName" placeholder="Ex: Natura" required>
                        </div>
                        <div class="form-group">
                            <label>Emoji da Loja</label>
                            <input type="text" id="newStoreEmoji" placeholder="üè¨" maxlength="2">
                        </div>
                    </div>
                    
                    <div class="credit-preview" id="creditPreview" style="display: none;">
                        <!-- Preview ser√° mostrado aqui -->
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="action-btn btn-warning" onclick="previewCredit()">
                            üëÅÔ∏è Pr√©via
                        </button>
                        <button type="submit" class="action-btn btn-success">
                            üí≥ Criar Credi√°rio
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========================================
         ABA SENHAS
         ======================================== -->
    <div id="adminTab-senhas" class="admin-tab-content">
        <div class="admin-controls">
            <h3>üîë Gerenciamento de Senhas</h3>
            
            <div class="admin-grid">
                <!-- Recupera√ß√£o Individual -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>üîÑ Recupera√ß√£o Individual</h4>
                        <small>Gere nova senha para um cliente espec√≠fico</small>
                    </div>
                    <form id="adminRecoveryForm">
                        <div class="form-group">
                            <label>CPF/CNPJ ou Email do Cliente</label>
                            <input type="text" id="adminRecoveryIdentifier" placeholder="000.000.000-00 ou email@exemplo.com" required>
                        </div>
                        <div class="password-actions">
                            <button type="submit" class="action-btn btn-primary">
                                üîë Gerar Nova Senha
                            </button>
                            <button type="button" class="action-btn btn-warning" onclick="resetClientPasswordToDefault()">
                                üîß Reset ‚Üí 123456
                            </button>
                        </div>
                    </form>
                    
                    <div id="adminRecoveryResult"></div>
                </div>

                <!-- A√ß√µes em Massa -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>‚öôÔ∏è A√ß√µes em Massa</h4>
                        <small>Gerencie senhas de todos os clientes</small>
                    </div>
                    
                    <div class="mass-actions">
                        <button class="action-btn btn-warning" onclick="resetAllPasswords()">
                            üîß Resetar Todas ‚Üí "123456"
                        </button>
                        
                        <button class="action-btn btn-primary" onclick="listAllPasswords()">
                            üëÅÔ∏è Listar Todas as Senhas
                        </button>
                        
                        <button class="action-btn btn-success" onclick="testRecoverySystem()">
                            üß™ Testar Sistema
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Resultado das a√ß√µes aparece aqui -->
            <div id="massActionResult"></div>
            
            <!-- Lista de Senhas -->
            <div id="passwordList" class="password-list-container" style="display: none;">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>üìã Lista de Senhas dos Clientes</h4>
                        <button onclick="hidePasswordList()" class="close-btn">‚ùå</button>
                    </div>
                    <div id="passwordListContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         ABA RELAT√ìRIOS
         ======================================== -->
    <div id="adminTab-relatorios" class="admin-tab-content">
        <div class="admin-controls">
            <h3>üìä Relat√≥rios e Analytics</h3>
            
            <div class="reports-grid">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>üìà Relat√≥rio de Cobran√ßas</h4>
                        <small>Status de pagamentos e inadimpl√™ncia</small>
                    </div>
                    <button class="action-btn btn-primary" onclick="generatePaymentReport()">
                        üìä Gerar Relat√≥rio
                    </button>
                </div>

                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>üí∞ Relat√≥rio Financeiro</h4>
                        <small>Receitas, proje√ß√µes e an√°lises</small>
                    </div>
                    <button class="action-btn btn-success" onclick="generateFinancialReport()">
                        üíπ Gerar Relat√≥rio
                    </button>
                </div>

                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>üë• Relat√≥rio de Clientes</h4>
                        <small>Base de clientes e estat√≠sticas</small>
                    </div>
                    <button class="action-btn btn-warning" onclick="generateClientReport()">
                        üìã Gerar Relat√≥rio
                    </button>
                </div>

                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>üîÑ Backup do Sistema</h4>
                        <small>Exportar dados completos</small>
                    </div>
                    <button class="action-btn btn-danger" onclick="generateSystemBackup()">
                        üíæ Fazer Backup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         CARDS DE CREDI√ÅRIOS
         ======================================== -->
    <div class="cards-grid" id="adminCards">
        <!-- Cards ser√£o gerados dinamicamente -->
    </div>
</div>

<!-- CSS ADICIONAL PARA O PAINEL ORGANIZADO -->
<style>
/* Abas do Admin */
.admin-tabs {
    display: flex;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 0.5rem;
    margin-bottom: 2rem;
    gap: 0.5rem;
}

.admin-tab {
    flex: 1;
    background: none;
    border: none;
    padding: 1rem;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #6c757d;
}

.admin-tab.active {
    background: white;
    color: #2c3e50;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.admin-tab:hover:not(.active) {
    background: rgba(255,255,255,0.5);
    color: #495057;
}

/* Conte√∫do das Abas */
.admin-tab-content {
    display: none;
}

.admin-tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

/* Layout em Grid */
.admin-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

/* Cards do Admin */
.admin-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
}

.admin-card-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #ecf0f1;
}

.admin-card-header h4 {
    margin: 0 0 0.5rem 0;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.admin-card-header small {
    color: #7f8c8d;
    font-size: 0.85rem;
}

/* Formul√°rios */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #2c3e50;
    font-weight: 600;
    font-size: 0.9rem;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #3498db;
}

/* A√ß√µes */
.form-actions, .password-actions, .client-actions, .mass-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.mass-actions {
    flex-direction: column;
}

/* Lista de Clientes */
.clients-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

/* Preview do Credi√°rio */
.credit-preview {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border-left: 4px solid #17a2b8;
}

/* Lista de Senhas */
.password-list-container {
    margin-top: 2rem;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-tabs {
        flex-direction: column;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions, .password-actions, .client-actions {
        flex-direction: column;
    }
}
</style>

    <script>
        // ========================================
        // ESTADO DA APLICA√á√ÉO
        // ========================================
        
        let appState = {
            currentUser: null,
            userType: null,
            userData: null,
            credits: [],
            clients: [],
            systemInfo: null
        };
        // ========================================
// FUN√á√ïES B√ÅSICAS DE UI
// ========================================

function showLoading() {
    const loadingElement = document.getElementById('loadingOverlay');
    if (loadingElement) {
        loadingElement.style.display = 'flex';
    }
}

function hideLoading() {
    const loadingElement = document.getElementById('loadingOverlay');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    const bgColor = type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : type === 'warning' ? '#f39c12' : '#3498db';
    const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    
    alertDiv.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 9999;
        font-weight: bold;
        max-width: 350px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    `;
    
    alertDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span>${icon}</span>
            <div style="flex: 1;">${message}</div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; opacity: 0.7;">&times;</button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

        // ========================================
        // FUN√á√ïES DE GOOGLE APPS SCRIPT
        // ========================================
        
      async function callGoogleScript(functionName, parameters = {}) {
    return new Promise((resolve, reject) => {
        showLoading();
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    resolve(result);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    reject(error);
                })
                [functionName](parameters);
        } else {
            // Fallback para desenvolvimento
            const mockData = getMockResponse(functionName, parameters);
            setTimeout(() => {
                hideLoading();
                resolve(mockData);
            }, 1000);
        }
    });
}

        // ========================================
        // FUN√á√ïES DE UI E UTILIT√ÅRIAS - IN√çCIO (CORRE√á√ÉO)
        // ========================================
        
        function switchTab(tab) {
    try {
        document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
        
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        const targetForm = document.getElementById(tab + 'Form');
        if (targetForm) {
            targetForm.classList.add('active');
        }
        
        console.log('‚úÖ Tab alterada para:', tab);
    } catch (error) {
        console.error('‚ùå Erro ao alternar tab:', error);
    }
}

// Garantir que switchTab est√° dispon√≠vel globalmente
window.switchTab = switchTab;

        // ========================================
        // FUN√á√ïES DE PAGAMENTO ATUALIZADAS - BUSCA NA PLANILHA
        // ========================================

        /**
 * Busca o link de pagamento de uma parcela espec√≠fica na planilha
 * @param {string} creditId - ID do credi√°rio
 * @param {number} installmentNumber - N√∫mero da parcela
 * @param {string} installmentId - ID da parcela
 */
async function getPaymentUrlFromSheet(creditId, installmentNumber, installmentId) {
    try {
        console.log('üîç Buscando URL de pagamento na planilha...');
        console.log('üìã Dados:', { creditId, installmentNumber, installmentId });
        
        showLoading();
        
        // Buscar URL na planilha
        const result = await callGoogleScript('getPaymentUrlFromSheet', {
            creditId: creditId,
            installmentNumber: installmentNumber,
            installmentId: installmentId
        });
        
        hideLoading();
        
        if (result && result.success) {
            const paymentUrl = result.paymentUrl;
            
            if (paymentUrl && paymentUrl !== '' && paymentUrl !== 'undefined') {
                console.log('‚úÖ URL encontrada:', paymentUrl);
                
                // Mostrar modal com URL encontrada
                showPaymentModal(creditId, installmentNumber, installmentId, paymentUrl);
                
                return paymentUrl;
            } else {
                console.warn('‚ö†Ô∏è URL vazia ou n√£o encontrada');
                showNoPaymentUrlModal(creditId, installmentNumber, installmentId);
                return null;
            }
        } else {
            console.error('‚ùå Erro ao buscar URL:', result?.error);
            showAlert(`‚ùå Erro ao buscar link de pagamento: ${result?.error || 'Erro desconhecido'}`, 'error');
            return null;
        }
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro de conex√£o:', error);
        showAlert('‚ùå Erro de conex√£o ao buscar link de pagamento', 'error');
        return null;
    }
}

/**
 * Modal quando n√£o h√° URL de pagamento dispon√≠vel
 */
function showNoPaymentUrlModal(creditId, installmentNumber, installmentId) {
    const modal = ensureModalExists();
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    modalTitle.textContent = `‚ö†Ô∏è Link de Pagamento - Parcela ${installmentNumber}`;

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div class="no-payment-url">
                <h3 style="margin-bottom: 1rem;">‚ö†Ô∏è Link N√£o Dispon√≠vel</h3>
                <p style="margin-bottom: 1rem;">
                    O link de pagamento para esta parcela ainda n√£o foi configurado na planilha.
                </p>
                <small style="color: #6c757d;">
                    Entre em contato com o administrador para configurar o link de pagamento.
                </small>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <button class="action-btn btn-warning" onclick="requestPaymentUrl('${creditId}', ${installmentNumber}, '${installmentId}')" style="margin-bottom: 1rem; width: 100%;">
                    üìß Solicitar Link de Pagamento
                </button>
                
                <button class="action-btn btn-success" onclick="markAsPaidManually('${installmentId}')" style="width: 100%;">
                    ‚úÖ Marcar como Pago Manualmente
                </button>
            </div>
            
            <div style="margin-top: 1rem;">
                <button class="action-btn btn-primary" onclick="refreshPaymentUrl('${creditId}', ${installmentNumber}, '${installmentId}')" style="width: 100%;">
                    üîÑ Verificar Novamente
                </button>
            </div>
        </div>
    `;

    modal.classList.add('active');
}

/**
 * Mostra modal de confirma√ß√£o de pagamento
 */
function showPaymentModal(creditId, installmentNumber, installmentId, paymentUrl) {
    const modal = ensureModalExists();
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    modalTitle.textContent = `üí≥ Pagamento - Parcela ${installmentNumber}`;

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <h3 style="color: #2ecc71; margin-bottom: 1rem;">üîó Link de Pagamento Encontrado</h3>
                <p style="color: #666; margin-bottom: 1rem;">
                    Clique no bot√£o abaixo para ser redirecionado para a p√°gina de pagamento segura.
                </p>
                <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px dashed #2ecc71; margin: 1rem 0; word-break: break-all; font-size: 0.9rem;">
                    ${paymentUrl}
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="action-btn btn-success" onclick="proceedToPayment('${paymentUrl}', '${installmentId}')" style="flex: 1; min-width: 200px;">
                    üåê Ir para Pagamento
                </button>
                <button class="action-btn btn-primary" onclick="copyPaymentUrl('${paymentUrl}')" style="flex: 1; min-width: 200px;">
                    üìã Copiar Link
                </button>
            </div>
            
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
                <button class="action-btn btn-warning" onclick="markAsPaidManually('${installmentId}')" style="width: 100%;">
                    ‚úÖ Marcar como Pago Manualmente
                </button>
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                    Use apenas se o pagamento foi feito por outros meios
                </small>
            </div>
        </div>
    `;

    modal.classList.add('active');
}

/**
 * Solicitar cria√ß√£o de link de pagamento
 */
async function requestPaymentUrl(creditId, installmentNumber, installmentId) {
    try {
        showLoading();
        
        const result = await callGoogleScript('requestPaymentUrl', {
            creditId: creditId,
            installmentNumber: installmentNumber,
            installmentId: installmentId
        });
        
        hideLoading();
        
        if (result && result.success) {
            showAlert('üìß Solicita√ß√£o enviada! O link ser√° configurado em breve.', 'success');
            closeModal();
        } else {
            showAlert(`‚ùå Erro ao solicitar: ${result?.error || 'Erro desconhecido'}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        showAlert('‚ùå Erro de conex√£o', 'error');
    }
}

/**
 * Atualizar/verificar URL de pagamento novamente
 */
async function refreshPaymentUrl(creditId, installmentNumber, installmentId) {
    showAlert('üîÑ Verificando novamente...', 'info');
    closeModal();
    
    // Aguardar um pouco e tentar novamente
    setTimeout(async () => {
        await getPaymentUrlFromSheet(creditId, installmentNumber, installmentId);
    }, 1000);
}

/**
 * Procede para o pagamento abrindo a URL
 */
function proceedToPayment(paymentUrl, installmentId) {
    try {
        // Abrir URL de pagamento em nova aba
        window.open(paymentUrl, '_blank');
        
        // Mostrar instru√ß√µes
        showAlert('üåê P√°gina de pagamento aberta em nova aba. Ap√≥s concluir o pagamento, retorne aqui para confirmar.', 'success');
        
        // Fechar modal atual
        closeModal();
        
        // Mostrar modal de confirma√ß√£o p√≥s-pagamento
        setTimeout(() => {
            showPostPaymentModal(installmentId);
        }, 2000);
        
    } catch (error) {
        console.error('Erro ao abrir pagamento:', error);
        showAlert('Erro ao abrir p√°gina de pagamento', 'error');
    }
}

/**
 * Copia URL de pagamento para √°rea de transfer√™ncia
 */
function copyPaymentUrl(paymentUrl) {
    try {
        navigator.clipboard.writeText(paymentUrl).then(() => {
            showAlert('üìã Link de pagamento copiado!', 'success');
        }).catch(() => {
            // Fallback para navegadores mais antigos
            const textArea = document.createElement('textarea');
            textArea.value = paymentUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showAlert('üìã Link de pagamento copiado!', 'success');
        });
    } catch (error) {
        console.error('Erro ao copiar:', error);
        showAlert('Erro ao copiar link', 'error');
    }
}

/**
 * Mostra modal de confirma√ß√£o p√≥s-pagamento
 */
function showPostPaymentModal(installmentId) {
    const modal = ensureModalExists();
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    modalTitle.textContent = '‚úÖ Confirmar Pagamento';

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="background: #fff3cd; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <h3 style="color: #856404; margin-bottom: 1rem;">üí∞ Pagamento Realizado?</h3>
                <p style="color: #666;">
                    Se voc√™ concluiu o pagamento na p√°gina anterior, confirme abaixo para atualizar o status da parcela.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="action-btn btn-success" onclick="confirmPaymentCompleted('${installmentId}')" style="flex: 1;">
                    ‚úÖ Sim, Paguei
                </button>
                <button class="action-btn btn-danger" onclick="closeModal()" style="flex: 1;">
                    ‚ùå Cancelar
                </button>
            </div>
            
            <small style="color: #7f8c8d; display: block; margin-top: 1rem;">
                Confirme apenas se o pagamento foi processado com sucesso
            </small>
        </div>
    `;

    modal.classList.add('active');
}

/**
 * Confirma que o pagamento foi conclu√≠do
 */
async function confirmPaymentCompleted(installmentId) {
    try {
        showLoading();
        
        const result = await callGoogleScript('processOnlinePayment', {
            installmentId: installmentId,
            paymentMethod: 'URL de pagamento utilizada'
        });
        
        hideLoading();
        
        if (result && result.success) {
            showAlert('Pagamento confirmado! üéâ', 'success');
            closeModal();
            
            if (result.allPaid) {
                setTimeout(() => {
                    showAlert('üéâ Parab√©ns! Todas as parcelas foram pagas! Credi√°rio quitado.', 'success');
                }, 1000);
            }
            
            // Recarregar dados
            if (appState.userType === 'client') {
                await loadClientData();
            } else {
                await loadAdminData();
            }
        } else {
            showAlert(result?.error || 'Erro ao confirmar pagamento', 'error');
        }
        
    } catch (error) {
        hideLoading();
        console.error('Erro ao confirmar pagamento:', error);
        showAlert('Erro de conex√£o', 'error');
    }
}

// ========================================
// SISTEMA DE ABAS DO PAINEL ADMIN
// ========================================

// ===== 1Ô∏è‚É£2Ô∏è‚É£ SUBSTITUIR FUN√á√ÉO switchAdminTab PARA INCLUIR APROVA√á√ïES =====
function switchAdminTabWithApprovals(tabName) {
    try {
        // Chamar fun√ß√£o original se existir
        if (typeof switchAdminTab === 'function' && tabName !== 'aprovacoes') {
            switchAdminTab(tabName);
            return;
        }
        
        // Remover classe active de todas as abas
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Adicionar classe active na aba clicada
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        const tabElement = document.getElementById(`adminTab-${tabName}`);
        if (tabElement) {
            tabElement.classList.add('active');
        }
        
        // A√ß√µes espec√≠ficas por aba
        switch(tabName) {
            case 'aprovacoes':
                loadPendingPaymentRequests();
                break;
            case 'clientes':
                if (typeof refreshClientsList === 'function') {
                    refreshClientsList();
                }
                break;
            case 'creditos':
                if (typeof updateClientSelect === 'function') {
                    updateClientSelect();
                }
                if (typeof setTodayDate === 'function') {
                    setTodayDate();
                }
                break;
        }
        
        console.log('‚úÖ Admin tab alterada para:', tabName);
    } catch (error) {
        console.error('‚ùå Erro ao alternar admin tab:', error);
    }
}
// ===== 4Ô∏è‚É£ VERIFICAR STATUS DA SOLICITA√á√ÉO =====
async function checkRequestStatus(requestId) {
    try {
        showLoading();
        
        const result = await callGoogleScript('getPaymentRequestStatus', requestId);
        
        hideLoading();
        
        if (result && result.success) {
            const status = result.status;
            const statusText = status === 'aprovado' ? 'APROVADO ‚úÖ' : 
                             status === 'rejeitado' ? 'REJEITADO ‚ùå' : 
                             'EM AN√ÅLISE ‚è≥';
            
            const statusColor = status === 'aprovado' ? '#2ecc71' : 
                              status === 'rejeitado' ? '#e74c3c' : 
                              '#f39c12';
            
            showAlert(`üìã Status: ${statusText}`, status === 'pendente' ? 'warning' : status === 'aprovado' ? 'success' : 'error');
            
            if (status === 'aprovado') {
                setTimeout(() => {
                    loadClientData(); // Recarregar dados para mostrar parcela paga
                }, 1000);
            }
        } else {
            showAlert('‚ùå Erro ao verificar status', 'error');
        }
        
    } catch (error) {
        hideLoading();
        showAlert('‚ùå Erro de conex√£o', 'error');
    }
}
// ===== 5Ô∏è‚É£ ADMIN: CARREGAR SOLICITA√á√ïES PENDENTES =====
async function loadPendingPaymentRequests() {
     try {
        console.log('üìã [FIXED] Carregando solicita√ß√µes pendentes...');
        
        // Criar container se n√£o existir
        createPaymentRequestsContainer();
        
        showLoading();
        
        // Chamar fun√ß√£o do backend com tratamento de erro
        let result;
        try {
            result = await callGoogleScript('getPendingPaymentRequests');
        } catch (connectionError) {
            hideLoading();
            console.error('‚ùå Erro de conex√£o:', connectionError);
            
            // Tentar fallback ou mostrar dados mock em desenvolvimento
            if (typeof getMockResponse === 'function') {
                result = getMockResponse('getPendingPaymentRequests');
                console.log('‚ö° Usando dados mock para desenvolvimento');
            } else {
                updatePaymentRequestsInterface([]);
                showAlert('‚ùå Erro de conex√£o com o servidor. Tente novamente.', 'error');
                return [];
            }
        }
        
        hideLoading();
        
        if (result && result.success) {
            const requests = result.requests || [];
            console.log(`‚úÖ ${requests.length} solicita√ß√µes carregadas`);
            
            // Atualizar interface
            updatePaymentRequestsInterface(requests);
            
            // Armazenar no estado global
            if (appState) {
                appState.paymentRequests = requests;
            }
            
            return requests;
        } else {
            console.error('‚ùå Erro do servidor:', result?.error);
            
            // Mostrar interface vazia
            updatePaymentRequestsInterface([]);
            
            // Mostrar erro apenas se n√£o for "nenhuma solicita√ß√£o"
            if (result?.error && !result.error.includes('nenhuma')) {
                showAlert(`‚ùå Erro ao carregar solicita√ß√µes: ${result.error}`, 'error');
            }
            
            return [];
        }
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro cr√≠tico ao carregar solicita√ß√µes:', error);
        
        // Interface de erro
        updatePaymentRequestsInterface([]);
        showAlert('‚ùå Erro cr√≠tico no sistema. Contate o suporte.', 'error');
        
        return [];
    }
}
/**
 * ========================================
 * CORRE√á√ÉO DO PAR√ÇMETRO requestId
 * Resolve erro "ID da solicita√ß√£o n√£o informado"
 * ========================================
 */

/**
 * FUN√á√ÉO CORRIGIDA: rejectPaymentRequest
 * Com debugging completo de par√¢metros
 */
function rejectPaymentRequest(params) {
  try {
    console.log('‚ùå [BACKEND] === IN√çCIO REJEI√á√ÉO DE PAGAMENTO ===');
    console.log('üìù [BACKEND] Par√¢metros recebidos (tipo):', typeof params);
    console.log('üìù [BACKEND] Par√¢metros recebidos (valor):', params);
    console.log('üìù [BACKEND] JSON dos par√¢metros:', JSON.stringify(params));
    
    // === VALIDA√á√ÉO DETALHADA DE PAR√ÇMETROS ===
    
    // Caso 1: Par√¢metros nulos ou undefined
    if (!params) {
      console.error('‚ùå [BACKEND] ERRO: Par√¢metros s√£o null/undefined');
      return {
        success: false,
        error: 'Par√¢metros n√£o fornecidos - valor null ou undefined',
        debugInfo: {
          paramsType: typeof params,
          paramsValue: params
        }
      };
    }
    
    // Caso 2: Par√¢metros em formato string (pode acontecer)
    if (typeof params === 'string') {
      console.log('üîÑ [BACKEND] Par√¢metros recebidos como string, tentando fazer parse...');
      try {
        params = JSON.parse(params);
        console.log('‚úÖ [BACKEND] Parse bem-sucedido:', params);
      } catch (parseError) {
        console.error('‚ùå [BACKEND] Erro no parse JSON:', parseError);
        return {
          success: false,
          error: 'Par√¢metros em formato inv√°lido - string n√£o √© JSON v√°lido',
          originalParams: params
        };
      }
    }
    
    // Caso 3: Verificar se √© um objeto
    if (typeof params !== 'object') {
      console.error('‚ùå [BACKEND] ERRO: Par√¢metros n√£o s√£o um objeto');
      return {
        success: false,
        error: 'Par√¢metros devem ser um objeto',
        debugInfo: {
          paramsType: typeof params,
          paramsValue: params
        }
      };
    }
    
    // === EXTRA√á√ÉO DO requestId COM FALLBACKS ===
    
    let requestId = null;
    
    // Tentativa 1: Propriedade requestId
    if (params.requestId) {
      requestId = params.requestId;
      console.log('‚úÖ [BACKEND] requestId encontrado em params.requestId:', requestId);
    }
    // Tentativa 2: Propriedade id
    else if (params.id) {
      requestId = params.id;
      console.log('‚úÖ [BACKEND] requestId encontrado em params.id:', requestId);
    }
    // Tentativa 3: Propriedade request_id
    else if (params.request_id) {
      requestId = params.request_id;
      console.log('‚úÖ [BACKEND] requestId encontrado em params.request_id:', requestId);
    }
    // Tentativa 4: Primeiro par√¢metro se for array
    else if (Array.isArray(params) && params.length > 0) {
      requestId = params[0];
      console.log('‚úÖ [BACKEND] requestId encontrado como primeiro item do array:', requestId);
    }
    // Tentativa 5: Se params for diretamente o ID
    else if (typeof params === 'string' && params.startsWith('REQ_')) {
      requestId = params;
      console.log('‚úÖ [BACKEND] params √© diretamente o requestId:', requestId);
    }
    
    // Verificar se conseguimos extrair o requestId
    if (!requestId) {
      console.error('‚ùå [BACKEND] ERRO: N√£o foi poss√≠vel extrair requestId');
      console.log('üîç [BACKEND] Propriedades dispon√≠veis em params:');
      Object.keys(params).forEach(key => {
        console.log(`  - ${key}: ${params[key]} (${typeof params[key]})`);
      });
      
      return {
        success: false,
        error: 'ID da solicita√ß√£o n√£o encontrado nos par√¢metros',
        debugInfo: {
          paramsKeys: Object.keys(params),
          paramsValues: params,
          availableProperties: Object.keys(params).map(key => ({
            key: key,
            value: params[key],
            type: typeof params[key]
          }))
        }
      };
    }
    
    // Limpar e validar requestId
    requestId = String(requestId).trim();
    
    if (requestId === '' || requestId === 'undefined' || requestId === 'null') {
      console.error('‚ùå [BACKEND] ERRO: requestId √© vazio ou inv√°lido');
      return {
        success: false,
        error: 'ID da solicita√ß√£o est√° vazio ou √© inv√°lido',
        debugInfo: {
          requestIdValue: requestId,
          originalParams: params
        }
      };
    }
    
    console.log('‚úÖ [BACKEND] requestId validado:', requestId);
    
    // === EXTRAIR OUTROS PAR√ÇMETROS ===
    
    const reason = params.reason || params.motivo || 'Solicita√ß√£o rejeitada pelo administrador';
    const adminNote = params.adminNote || params.nota || params.note || '';
    
    console.log('üìù [BACKEND] Par√¢metros finais:', {
      requestId: requestId,
      reason: reason,
      adminNote: adminNote
    });
    
    // === CONTINUAR COM A L√ìGICA DE REJEI√á√ÉO ===
    
    // Acessar planilha
    let spreadsheet;
    try {
      spreadsheet = getOrCreateSpreadsheet();
      console.log('‚úÖ [BACKEND] Planilha acessada:', spreadsheet.getName());
    } catch (error) {
      console.error('‚ùå [BACKEND] Erro ao acessar planilha:', error);
      return {
        success: false,
        error: 'Erro ao acessar planilha: ' + error.message
      };
    }
    
    // Verificar aba de solicita√ß√µes
    let sheet = spreadsheet.getSheetByName('Solicitacoes');
    if (!sheet) {
      console.error('‚ùå [BACKEND] Aba Solicitacoes n√£o encontrada');
      return {
        success: false,
        error: 'Aba de solicita√ß√µes n√£o encontrada'
      };
    }
    
    // Buscar dados da aba
    let data;
    try {
      data = sheet.getDataRange().getValues();
      console.log(`üìä [BACKEND] ${data.length - 1} solicita√ß√µes encontradas na planilha`);
    } catch (error) {
      console.error('‚ùå [BACKEND] Erro ao ler dados da aba:', error);
      return {
        success: false,
        error: 'Erro ao ler dados da aba: ' + error.message
      };
    }
    
    // Verificar se h√° dados
    if (data.length <= 1) {
      console.error('‚ùå [BACKEND] Nenhuma solicita√ß√£o encontrada na planilha');
      return {
        success: false,
        error: 'Nenhuma solicita√ß√£o encontrada na planilha'
      };
    }
    
    // Buscar a solicita√ß√£o espec√≠fica
    let requestFound = false;
    let requestRow = -1;
    let currentRequestData = null;
    
    console.log('üîç [BACKEND] Procurando solicita√ß√£o:', requestId);
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowRequestId = String(row[0] || '').trim();
      
      console.log(`üîç [BACKEND] Linha ${i}: ID = "${rowRequestId}"`);
      
      if (rowRequestId === requestId) {
        requestFound = true;
        requestRow = i + 1; // +1 porque getRange √© 1-indexed
        currentRequestData = row;
        
        console.log(`‚úÖ [BACKEND] Solicita√ß√£o encontrada na linha ${requestRow}`);
        console.log('üìÑ [BACKEND] Dados atuais:', {
          id: row[0],
          cliente: row[1],
          produto: row[3],
          parcela: row[5],
          status: row[9]
        });
        break;
      }
    }
    
    if (!requestFound) {
      console.error('‚ùå [BACKEND] Solicita√ß√£o n√£o encontrada:', requestId);
      console.log('üîç [BACKEND] IDs dispon√≠veis na planilha:');
      for (let i = 1; i < Math.min(data.length, 6); i++) {
        console.log(`  ${i}. ID: "${data[i][0]}"`);
      }
      
      return {
        success: false,
        error: 'Solicita√ß√£o n√£o encontrada na planilha',
        debugInfo: {
          searchedId: requestId,
          availableIds: data.slice(1, 6).map(row => row[0]).filter(id => id)
        }
      };
    }
    
    // Verificar status atual
    const currentStatus = String(currentRequestData[9] || '').trim();
    console.log('üìã [BACKEND] Status atual da solicita√ß√£o:', currentStatus);
    
    if (currentStatus === 'rejeitado') {
      console.log('‚ö†Ô∏è [BACKEND] Solicita√ß√£o j√° foi rejeitada');
      return {
        success: false,
        error: 'Esta solicita√ß√£o j√° foi rejeitada',
        currentStatus: currentStatus
      };
    }
    
    // Preparar dados de rejei√ß√£o
    const currentNote = String(currentRequestData[10] || '');
    
    let newNote = currentNote;
    if (currentNote && currentNote.trim() !== '') {
      newNote += ' | ';
    }
    newNote += 'REJEITADO: ' + reason;
    
    if (adminNote && String(adminNote).trim() !== '') {
      newNote += ' | ADMIN: ' + String(adminNote).trim();
    }
    
    console.log('üìù [BACKEND] Nova observa√ß√£o:', newNote);
    
    // Atualizar status e observa√ß√µes
    try {
      // Atualizar status para 'rejeitado' (coluna J = 10)
      sheet.getRange(requestRow, 10).setValue('rejeitado');
      console.log('‚úÖ [BACKEND] Status atualizado para "rejeitado"');
      
      // Atualizar observa√ß√µes (coluna K = 11)
      sheet.getRange(requestRow, 11).setValue(newNote);
      console.log('‚úÖ [BACKEND] Observa√ß√µes atualizadas');
      
    } catch (error) {
      console.error('‚ùå [BACKEND] Erro ao atualizar planilha:', error);
      return {
        success: false,
        error: 'Erro ao atualizar planilha: ' + error.message
      };
    }
    
    console.log(`‚úÖ [BACKEND] Solicita√ß√£o ${requestId} rejeitada com sucesso`);
    
    return { 
      success: true,
      message: 'Solicita√ß√£o rejeitada com sucesso',
      requestId: requestId,
      reason: reason,
      adminNote: adminNote,
      updatedRow: requestRow
    };
    
  } catch (error) {
    console.error('‚ùå [BACKEND] Erro cr√≠tico ao rejeitar solicita√ß√£o:', error);
    console.error('üìã [BACKEND] Stack trace:', error.stack);
    
    return { 
      success: false, 
      error: 'Erro cr√≠tico: ' + error.message,
      stack: error.stack
    };
  }
}

/**
 * FUN√á√ÉO CORRIGIDA: approvePaymentRequest
 * Com o mesmo tratamento robusto de par√¢metros
 */
function approvePaymentRequest(params) {
  try {
    console.log('‚úÖ [BACKEND] === IN√çCIO APROVA√á√ÉO DE PAGAMENTO ===');
    console.log('üìù [BACKEND] Par√¢metros recebidos:', params);
    
    // Usar a mesma l√≥gica de extra√ß√£o de par√¢metros
    if (!params) {
      return {
        success: false,
        error: 'Par√¢metros n√£o fornecidos'
      };
    }
    
    // Tratar string JSON
    if (typeof params === 'string') {
      try {
        params = JSON.parse(params);
      } catch (parseError) {
        return {
          success: false,
          error: 'Par√¢metros em formato inv√°lido'
        };
      }
    }
    
    // Extrair requestId com fallbacks
    let requestId = params.requestId || params.id || params.request_id;
    
    if (Array.isArray(params) && params.length > 0) {
      requestId = params[0];
    }
    
    if (!requestId) {
      console.error('‚ùå [BACKEND] ID da solicita√ß√£o n√£o encontrado');
      console.log('üîç [BACKEND] Propriedades dispon√≠veis:', Object.keys(params));
      
      return {
        success: false,
        error: 'ID da solicita√ß√£o n√£o encontrado nos par√¢metros',
        debugInfo: {
          paramsKeys: Object.keys(params),
          paramsValues: params
        }
      };
    }
    
    requestId = String(requestId).trim();
    const adminNote = params.adminNote || params.nota || params.note || '';
    
    console.log('‚úÖ [BACKEND] Aprovando solicita√ß√£o:', requestId);
    
    // Resto da l√≥gica de aprova√ß√£o...
    const spreadsheet = getOrCreateSpreadsheet();
    const sheet = spreadsheet.getSheetByName('Solicitacoes');
    
    if (!sheet) {
      return {
        success: false,
        error: 'Aba de solicita√ß√µes n√£o encontrada'
      };
    }
    
    const data = sheet.getDataRange().getValues();
    let requestFound = false;
    let installmentId = null;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowRequestId = String(row[0] || '').trim();
      
      if (rowRequestId === requestId) {
        requestFound = true;
        installmentId = String(row[12] || '');
        
        // Atualizar status para 'aprovado'
        sheet.getRange(i + 1, 10).setValue('aprovado');
        
        if (adminNote) {
          const currentNote = String(row[10] || '');
          const newNote = currentNote + (currentNote ? ' | ' : '') + 'ADMIN: ' + adminNote;
          sheet.getRange(i + 1, 11).setValue(newNote);
        }
        
        console.log(`‚úÖ [BACKEND] Solicita√ß√£o ${requestId} aprovada`);
        break;
      }
    }
    
    if (!requestFound) {
      return {
        success: false,
        error: 'Solicita√ß√£o n√£o encontrada'
      };
    }
    
    // Marcar parcela como paga se temos o installmentId
    if (installmentId && installmentId.trim() !== '') {
      try {
        const paymentResult = markInstallmentAsPaid(installmentId, {
          method: 'Confirma√ß√£o Administrativa',
          note: adminNote || 'Pagamento confirmado pelo administrador'
        });
        
        console.log('üí∞ [BACKEND] Resultado do pagamento:', paymentResult.success ? '‚úÖ' : '‚ùå');
      } catch (error) {
        console.error('‚ùå [BACKEND] Erro ao marcar parcela:', error);
      }
    }
    
    return { 
      success: true,
      message: 'Solicita√ß√£o aprovada com sucesso',
      requestId: requestId,
      installmentId: installmentId
    };
    
  } catch (error) {
    console.error('‚ùå [BACKEND] Erro cr√≠tico ao aprovar:', error);
    return { 
      success: false, 
      error: 'Erro cr√≠tico: ' + error.message 
    };
  }
}

/**
 * FUN√á√ÉO DE DEBUG: Verificar como as fun√ß√µes est√£o sendo chamadas
 */
function debugFunctionCalls() {
  console.log('üß™ [BACKEND] === DEBUG DE CHAMADAS DE FUN√á√ÉO ===');
  
  // Testar diferentes formatos de par√¢metros
  const testCases = [
    // Formato objeto normal
    { requestId: 'REQ_test_1', reason: 'Teste 1' },
    
    // Formato com id em vez de requestId
    { id: 'REQ_test_2', reason: 'Teste 2' },
    
    // Formato string JSON
    '{"requestId": "REQ_test_3", "reason": "Teste 3"}',
    
    // Formato array
    ['REQ_test_4', 'Teste 4'],
    
    // Formato problem√°tico - objeto vazio
    {},
    
    // Formato problem√°tico - null
    null,
    
    // Formato problem√°tico - undefined
    undefined
  ];
  
  console.log('üß™ [BACKEND] Testando diferentes formatos de par√¢metros...');
  
  testCases.forEach((testCase, index) => {
    console.log(`\nüß™ [BACKEND] Teste ${index + 1}:`, testCase);
    
    try {
      const resultado = rejectPaymentRequest(testCase);
      console.log(`üìä [BACKEND] Resultado ${index + 1}:`, resultado.success ? '‚úÖ' : '‚ùå');
      if (!resultado.success) {
        console.log(`‚ùå [BACKEND] Erro ${index + 1}:`, resultado.error);
      }
    } catch (error) {
      console.log(`üí• [BACKEND] Exception ${index + 1}:`, error.message);
    }
  });
  
  return {
    success: true,
    message: 'Debug de chamadas de fun√ß√£o conclu√≠do'
  };
}

/**
 * FUN√á√ÉO DE WRAPPER: Para chamadas do frontend
 */
function rejectPaymentRequestWrapper(requestId, reason, adminNote) {
  console.log('üîÑ [BACKEND] Wrapper chamado com argumentos separados:', {
    requestId, reason, adminNote
  });
  
  // Converter argumentos separados em objeto
  const params = {
    requestId: requestId,
    reason: reason || 'Solicita√ß√£o rejeitada',
    adminNote: adminNote || ''
  };
  
  return rejectPaymentRequest(params);
}

/**
 * FUN√á√ÉO CORRIGIDA: approvePaymentRequest
 * Com a mesma l√≥gica de aceitar string direta
 */
function approvePaymentRequest(params) {
  try {
    console.log('‚úÖ [BACKEND] === IN√çCIO APROVA√á√ÉO DE PAGAMENTO (V3) ===');
    console.log('üìù [BACKEND] Par√¢metros recebidos:', typeof params, params);
    
    let requestId = null;
    let adminNote = '';
    
    // === IDENTIFICAR FORMATO DOS PAR√ÇMETROS ===
    
    if (!params) {
      return {
        success: false,
        error: 'Par√¢metros n√£o fornecidos'
      };
    }
    
    // CASO 1: String direta (requestId)
    if (typeof params === 'string') {
      if (params.startsWith('REQ_')) {
        requestId = params.trim();
        console.log('‚úÖ [BACKEND] String identificada como requestId:', requestId);
      } else if (params.startsWith('{')) {
        try {
          const parsed = JSON.parse(params);
          requestId = parsed.requestId || parsed.id;
          adminNote = parsed.adminNote || adminNote;
        } catch (parseError) {
          return {
            success: false,
            error: 'Formato JSON inv√°lido: ' + parseError.message
          };
        }
      } else {
        return {
          success: false,
          error: 'String deve ser um requestId (REQ_...) ou JSON v√°lido'
        };
      }
    }
    
    // CASO 2: Objeto
    else if (typeof params === 'object' && !Array.isArray(params)) {
      requestId = params.requestId || params.id || params.request_id;
      adminNote = params.adminNote || params.nota || params.note || adminNote;
    }
    
    // CASO 3: Array
    else if (Array.isArray(params)) {
      requestId = params[0];
      adminNote = params[1] || adminNote;
    }
    
    // === VALIDAR requestId ===
    
    if (!requestId) {
      return {
        success: false,
        error: 'ID da solicita√ß√£o n√£o encontrado'
      };
    }
    
    requestId = String(requestId).trim();
    
    console.log('‚úÖ [BACKEND] Aprovando solicita√ß√£o:', requestId);
    
    // === PROCESSAR APROVA√á√ÉO ===
    
    const spreadsheet = getOrCreateSpreadsheet();
    const sheet = spreadsheet.getSheetByName('Solicitacoes');
    
    if (!sheet) {
      return {
        success: false,
        error: 'Aba de solicita√ß√µes n√£o encontrada'
      };
    }
    
    const data = sheet.getDataRange().getValues();
    let requestFound = false;
    let installmentId = null;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowRequestId = String(row[0] || '').trim();
      
      if (rowRequestId === requestId) {
        requestFound = true;
        installmentId = String(row[12] || ''); // Installment_ID
        
        // Atualizar status para 'aprovado'
        sheet.getRange(i + 1, 10).setValue('aprovado');
        
        if (adminNote) {
          const currentNote = String(row[10] || '');
          const newNote = currentNote + (currentNote ? ' | ' : '') + 'ADMIN: ' + adminNote;
          sheet.getRange(i + 1, 11).setValue(newNote);
        }
        
        console.log(`‚úÖ [BACKEND] Solicita√ß√£o ${requestId} aprovada`);
        break;
      }
    }
    
    if (!requestFound) {
      return {
        success: false,
        error: 'Solicita√ß√£o n√£o encontrada'
      };
    }
    
    // Marcar parcela como paga se temos o installmentId
    if (installmentId && installmentId.trim() !== '') {
      try {
        const paymentResult = markInstallmentAsPaid(installmentId, {
          method: 'Confirma√ß√£o Administrativa',
          note: adminNote || 'Pagamento confirmado pelo administrador'
        });
        
        console.log('üí∞ [BACKEND] Resultado do pagamento:', paymentResult.success ? '‚úÖ' : '‚ùå');
        
        if (!paymentResult.success) {
          console.log('‚ö†Ô∏è [BACKEND] Erro ao marcar parcela:', paymentResult.error);
        }
      } catch (error) {
        console.error('‚ùå [BACKEND] Erro ao marcar parcela:', error);
      }
    }
    
    console.log(`‚úÖ [BACKEND] === APROVA√á√ÉO CONCLU√çDA COM SUCESSO ===`);
    
    return { 
      success: true,
      message: 'Solicita√ß√£o aprovada com sucesso',
      requestId: requestId,
      installmentId: installmentId,
      installmentMarkedAsPaid: !!installmentId
    };
    
  } catch (error) {
    console.error('‚ùå [BACKEND] Erro cr√≠tico ao aprovar:', error);
    return { 
      success: false, 
      error: 'Erro cr√≠tico: ' + error.message 
    };
  }
}

/**
 * FUN√á√ÉO DE TESTE: Verificar se a corre√ß√£o funciona
 */
function testarCorrecaoJsonParse() {
  console.log('üß™ [BACKEND] === TESTE DA CORRE√á√ÉO JSON PARSE ===');
  
  const testCases = [
    // Caso 1: String direta (como est√° vindo do frontend)
    'REQ_1753484846234_o4y4n',
    
    // Caso 2: Objeto normal
    { requestId: 'REQ_test_obj', reason: 'Teste objeto' },
    
    // Caso 3: String JSON
    '{"requestId": "REQ_test_json", "reason": "Teste JSON"}',
    
    // Caso 4: Array
    ['REQ_test_array', 'Teste array'],
    
    // Caso 5: String inv√°lida
    'string_invalida'
  ];
  
  const resultados = [];
  
  testCases.forEach((testCase, index) => {
    console.log(`\nüß™ [BACKEND] Teste ${index + 1}:`, testCase);
    
    try {
      const resultado = rejectPaymentRequest(testCase);
      resultados.push({
        caso: index + 1,
        entrada: testCase,
        sucesso: resultado.success,
        erro: resultado.error || null
      });
      
      console.log(`üìä [BACKEND] Resultado ${index + 1}:`, resultado.success ? '‚úÖ' : '‚ùå');
      if (!resultado.success) {
        console.log(`‚ùå [BACKEND] Erro ${index + 1}:`, resultado.error);
      }
    } catch (error) {
      console.log(`üí• [BACKEND] Exception ${index + 1}:`, error.message);
      resultados.push({
        caso: index + 1,
        entrada: testCase,
        sucesso: false,
        erro: 'Exception: ' + error.message
      });
    }
  });
  
  console.log('\nüìä [BACKEND] === RESUMO DOS TESTES ===');
  resultados.forEach(r => {
    console.log(`Teste ${r.caso}: ${r.sucesso ? '‚úÖ' : '‚ùå'} ${r.erro || ''}`);
  });
  
  return {
    success: true,
    resultados: resultados,
    message: 'Teste de corre√ß√£o JSON Parse conclu√≠do'
  };
}

/**
 * FUN√á√ÉO ESPEC√çFICA: Testar com o ID problem√°tico
 */
function testarIdProblematico() {
  console.log('üéØ [BACKEND] === TESTE COM ID PROBLEM√ÅTICO ===');
  
  // ID que estava causando erro
  const problematicId = 'REQ_1753484846234_o4y4n';
  
  console.log('üß™ [BACKEND] Testando rejei√ß√£o com:', problematicId);
  
  const resultado = rejectPaymentRequest(problematicId);
  
  console.log('üìä [BACKEND] Resultado:', resultado);
  
  return resultado;
}

// ===== LOGS DE INICIALIZA√á√ÉO =====

console.log('üîß === CORRE√á√ÉO JSON PARSE CARREGADA ===');
console.log('‚úÖ Problemas resolvidos:');
console.log('  - Aceita string direta como requestId');
console.log('  - N√£o tenta fazer JSON.parse em strings simples');
console.log('  - Identifica automaticamente o formato dos par√¢metros');
console.log('  - Trata todos os casos: string, objeto, array, JSON');
console.log('  - Logs detalhados para debugging');
console.log('');
console.log('üß™ Para testar: testarCorrecaoJsonParse()');
console.log('üéØ Para testar ID espec√≠fico: testarIdProblematico()');
console.log('');
console.log('üéâ Erro "SyntaxError: Unexpected token" resolvido!');

// ========================================
// FUN√á√ïES DE PREVIEW E VALIDA√á√ÉO
// ========================================

function previewCredit() {
    const clientSelect = document.getElementById('selectClient');
    const productName = document.getElementById('newProductName').value;
    const totalValue = document.getElementById('newTotalValue').value;
    const installments = document.getElementById('newInstallments').value;
    const storeName = document.getElementById('newStoreName').value;
    
    if (!clientSelect.value || !productName || !totalValue || !installments) {
        showAlert('‚ùå Preencha os campos obrigat√≥rios para ver a pr√©via', 'error');
        return;
    }
    
    const clientName = clientSelect.options[clientSelect.selectedIndex].text;
    const installmentValue = (parseFloat(totalValue) / parseInt(installments)).toFixed(2);
    
    const previewDiv = document.getElementById('creditPreview');
    previewDiv.innerHTML = `
        <h5 style="color: #2c3e50; margin-bottom: 1rem;">üëÅÔ∏è Pr√©via do Credi√°rio</h5>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
            <div><strong>Cliente:</strong> ${clientName}</div>
            <div><strong>Produto:</strong> ${productName}</div>
            <div><strong>Loja:</strong> ${storeName}</div>
            <div><strong>Valor Total:</strong> R$ ${parseFloat(totalValue).toFixed(2)}</div>
            <div><strong>Parcelas:</strong> ${installments}x</div>
            <div><strong>Valor da Parcela:</strong> R$ ${installmentValue}</div>
        </div>
    `;
    previewDiv.style.display = 'block';
}

function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('newPurchaseDate');
    if (dateInput && !dateInput.value) {
        dateInput.value = today;
    }
}

function refreshClientsList() {
    console.log('üîÑ Atualizando lista de clientes...');
    if (typeof loadAdminData === 'function') {
        loadAdminData();
    }
}

// ========================================
// FUN√á√ïES DE RELAT√ìRIOS
// ========================================

async function generatePaymentReport() {
    try {
        showLoading();
        // Aqui voc√™ implementaria a gera√ß√£o do relat√≥rio
        setTimeout(() => {
            hideLoading();
            showAlert('üìä Relat√≥rio de pagamentos gerado com sucesso!', 'success');
        }, 2000);
    } catch (error) {
        hideLoading();
        showAlert('‚ùå Erro ao gerar relat√≥rio', 'error');
    }
}

async function generateFinancialReport() {
    try {
        showLoading();
        setTimeout(() => {
            hideLoading();
            showAlert('üíπ Relat√≥rio financeiro gerado com sucesso!', 'success');
        }, 2000);
    } catch (error) {
        hideLoading();
        showAlert('‚ùå Erro ao gerar relat√≥rio financeiro', 'error');
    }
}

async function generateClientReport() {
    try {
        showLoading();
        setTimeout(() => {
            hideLoading();
            showAlert('üìã Relat√≥rio de clientes gerado com sucesso!', 'success');
        }, 2000);
    } catch (error) {
        hideLoading();
        showAlert('‚ùå Erro ao gerar relat√≥rio de clientes', 'error');
    }
}

async function generateSystemBackup() {
    if (!confirm('üíæ Deseja fazer backup completo do sistema?\n\nEsta opera√ß√£o pode demorar alguns minutos.')) {
        return;
    }
    
    try {
        showLoading();
        setTimeout(() => {
            hideLoading();
            showAlert('üíæ Backup do sistema criado com sucesso!', 'success');
        }, 3000);
    } catch (error) {
        hideLoading();
        showAlert('‚ùå Erro ao fazer backup', 'error');
    }
}

function exportClients() {
    showAlert('üì§ Funcionalidade de exporta√ß√£o em desenvolvimento', 'warning');
}

// ========================================
// INICIALIZA√á√ÉO DO PAINEL
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üõí Sistema de Credi√°rio StarkTech iniciado!');
    
    // Configurar event listeners de forma segura
    const clientForm = document.getElementById('clientForm');
    const adminForm = document.getElementById('adminForm');
    const newClientForm = document.getElementById('newClientForm');
    const newCreditForm = document.getElementById('newCreditForm');
    
    if (clientForm) {
        clientForm.addEventListener('submit', handleClientLogin);
    }
    
    if (adminForm) {
        adminForm.addEventListener('submit', handleAdminLogin);
    }
    
    if (newClientForm) {
        newClientForm.addEventListener('submit', createClient);
    }
    
    if (newCreditForm) {
        newCreditForm.addEventListener('submit', createCredit);
    }
    
    // Configurar data padr√£o
    const today = new Date().toISOString().split('T')[0];
    const purchaseDateInput = document.getElementById('newPurchaseDate');
    if (purchaseDateInput) {
        purchaseDateInput.value = today;
    }
    
    showAlert('Sistema carregado! üöÄ', 'success');
});
// ========================================
// GARANTIR FUN√á√ïES GLOBAIS
// ========================================

// Garantir que as fun√ß√µes cr√≠ticas estejam dispon√≠veis globalmente
window.switchTab = switchTab;
window.handleClientLogin = handleClientLogin;
window.handleAdminLogin = handleAdminLogin;
window.showApp = showApp;
window.logout = logout;
window.closeModal = closeModal;
window.testarLoginJackeline = testarLoginJackeline;
window.testarLoginSrWhite = testarLoginSrWhite;
window.openPaymentUrl = openPaymentUrl;
window.markAsPaidManually = markAsPaidManually;
window.editClient = editClient;
window.showLoading = showLoading;
window.hideLoading = hideLoading;
window.refreshClientsList = refreshClientsList;
window.setTodayDate = setTodayDate;
window.previewCredit = previewCredit;
window.toggleMode = toggleMode;
window.abrirRecuperacaoWhatsApp = abrirRecuperacaoWhatsApp;
window.generatePaymentReport = generatePaymentReport;
window.generateFinancialReport = generateFinancialReport;
window.generateClientReport = generateClientReport;
window.generateSystemBackup = generateSystemBackup;
window.exportClients = exportClients;
window.createClient = createClient;
window.createCredit = createCredit;
window.getPaymentUrlFromSheet = getPaymentUrlFromSheet;
window.showPaymentModal = showPaymentModal;
window.showNoPaymentUrlModal = showNoPaymentUrlModal;
window.requestPaymentUrl = requestPaymentUrl;
window.refreshPaymentUrl = refreshPaymentUrl;
window.proceedToPayment = proceedToPayment;
window.updateAdminDashboard=updateAdminDashboard
window.copyPaymentUrl = copyPaymentUrl;
window.showPostPaymentModal = showPostPaymentModal;
window.confirmPaymentCompleted = confirmPaymentCompleted;
window.testarBuscaUrlPagamento = testarBuscaUrlPagamento;
// ===== 1Ô∏è‚É£3Ô∏è‚É£ FUN√á√ïES GLOBAIS (ADICIONAR AO FINAL DO SEU C√ìDIGO) =====
// Adicione essas linhas ao final do seu c√≥digo, na se√ß√£o onde voc√™ define as fun√ß√µes globais

window.requestPaymentConfirmation = requestPaymentConfirmation;
window.showPaymentRequestStatus = showPaymentRequestStatus;
window.checkRequestStatus = checkRequestStatus;
window.loadPendingPaymentRequests = loadPendingPaymentRequests;
window.approvePaymentRequest = approvePaymentRequest;
window.rejectPaymentRequest = rejectPaymentRequest;
window.viewCreditDetailsWithApproval = viewCreditDetailsWithApproval;
window.loadAdminDataWithApprovals = loadAdminDataWithApprovals;
window.switchAdminTabWithApprovals = switchAdminTabWithApprovals;

// ===== 1Ô∏è‚É£4Ô∏è‚É£ INICIALIZA√á√ÉO AUTOM√ÅTICA =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîî Sistema de Aprova√ß√£o de Pagamento carregado!');
    
    // Se estiver no painel admin, criar interface de aprova√ß√µes
    if (appState?.userType === 'admin') {
        setTimeout(() => {
            createPaymentRequestsContainer();
            loadPendingPaymentRequests();
        }, 2000);
    }
    
});

console.log('‚úÖ Sistema de Aprova√ß√£o de Pagamento integrado com sucesso!');
console.log('üìã Funcionalidades adicionadas:');
console.log('   - requestPaymentConfirmation() - Cliente solicita confirma√ß√£o');
console.log('   - approvePaymentRequest() - Admin aprova pagamento');
console.log('   - rejectPaymentRequest() - Admin rejeita pagamento');
console.log('   - Nova aba "Aprova√ß√µes" no painel admin');


console.log('‚úÖ Sistema StarkTech carregado - switchTab dispon√≠vel:', typeof window.switchTab);
console.log('‚úÖ hideLoading dispon√≠vel:', typeof window.hideLoading);
console.log('‚úÖ getPaymentUrlFromSheet dispon√≠vel:', typeof window.getPaymentUrlFromSheet);
console.log('‚úÖ Total de fun√ß√µes globais:', Object.keys(window).filter(key => typeof window[key] === 'function' && key.includes('Payment')).length);
// ========================================
// GERENCIAMENTO DE SENHAS - FRONTEND ADMIN
// ========================================

// Event listener para o formul√°rio de recupera√ß√£o admin
document.addEventListener('DOMContentLoaded', function() {
    const adminRecoveryForm = document.getElementById('adminRecoveryForm');
    if (adminRecoveryForm) {
        adminRecoveryForm.addEventListener('submit', handleAdminRecovery);
    }
});
// ========================================
// SISTEMA DE APROVA√á√ÉO DE PAGAMENTOS - FRONTEND
// ========================================

/**
 * Criar container de solicita√ß√µes no painel admin (se n√£o existir)
 */
function createPaymentRequestsContainer() {
    // Verificar se j√° existe
    if (document.getElementById('paymentRequestsContainer')) {
        return;
    }
    
    // Encontrar o painel admin
    const adminDashboard = document.getElementById('adminDashboard');
    if (!adminDashboard) {
        console.warn('‚ö†Ô∏è Painel administrativo n√£o encontrado');
        return;
    }
    
    // Criar se√ß√£o de aprova√ß√µes
    const approvalSection = document.createElement('div');
    approvalSection.id = 'paymentRequestsContainer';
    approvalSection.innerHTML = `
        <div style="background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 1rem 0; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìã</span>
                    <span>Solicita√ß√µes de Pagamento</span>
                    <span id="pendingCount" style="background: rgba(255,255,255,0.2); padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.9rem;">0</span>
                </h3>
            </div>
            <div id="requestsList" style="padding: 1rem;">
                <div style="text-align: center; color: #6c757d; padding: 2rem;">
                    üîÑ Carregando solicita√ß√µes...
                </div>
            </div>
        </div>
    `;
    
    // Inserir no painel admin (no in√≠cio)
    adminDashboard.insertBefore(approvalSection, adminDashboard.firstChild);
    console.log('‚úÖ Container de aprova√ß√µes criado');
}
// ===== INTEGRA√á√ÉO DOS MODAIS DE PAGAMENTO =====

/**
 * Modal p√≥s-pagamento integrado com sistema de confirma√ß√£o
 */
function showPostPaymentModal(installmentId) {
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    modalTitle.textContent = '‚úÖ Confirmar Pagamento';

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="background: #fff3cd; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <h3 style="color: #856404; margin-bottom: 1rem;">üí∞ Pagamento Realizado?</h3>
                <p style="color: #666;">
                    Se voc√™ concluiu o pagamento na p√°gina anterior, confirme abaixo para solicitar a confirma√ß√£o.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="action-btn btn-success" onclick="handlePostPaymentConfirmation('${installmentId}')" style="flex: 1;">
                    ‚úÖ Sim, Paguei
                </button>
                <button class="action-btn btn-danger" onclick="closeModal()" style="flex: 1;">
                    ‚ùå Cancelar
                </button>
            </div>
            
            <small style="color: #7f8c8d; display: block; margin-top: 1rem;">
                Sua solicita√ß√£o ser√° enviada para confirma√ß√£o do administrador
            </small>
        </div>
    `;

    modal.classList.add('active');
}

/**
 * Fun√ß√£o que liga o modal p√≥s-pagamento com o sistema de confirma√ß√£o
 */
async function handlePostPaymentConfirmation(installmentId) {
    try {
        // Buscar dados da parcela para usar no sistema de confirma√ß√£o
        const installmentData = findInstallmentById(installmentId);
        
        if (!installmentData) {
            showAlert('‚ùå Parcela n√£o encontrada', 'error');
            return;
        }
        
        const { credit, installment } = installmentData;
        
        // Fechar o modal atual
        closeModal();
        
        // Chamar o sistema de confirma√ß√£o existente
        // Passa os mesmos par√¢metros que o bot√£o do modal principal usa
        await requestPaymentConfirmation(
            credit.id, 
            installment.number, 
            installment.id
        );
        
    } catch (error) {
        console.error('Erro ao processar confirma√ß√£o:', error);
        showAlert('‚ùå Erro ao processar confirma√ß√£o', 'error');
    }
}

/**
 * Fun√ß√£o auxiliar para encontrar parcela por ID (se n√£o existir)
 */
function findInstallmentById(installmentId) {
    for (const credit of appState.credits || []) {
        const installment = credit.installments?.find(inst => inst.id === installmentId);
        if (installment) {
            return { credit, installment };
        }
    }
    return null;
}

/**
 * Vers√£o modificada da fun√ß√£o de confirma√ß√£o para trabalhar com ambos os modais
 */
async function requestPaymentConfirmation(creditId, installmentNumber, installmentId, fromPostPayment = false) {
    try {
        // Buscar dados da parcela
        const credit = appState.credits?.find(c => c.id === creditId);
        if (!credit) {
            showAlert('‚ùå Credi√°rio n√£o encontrado', 'error');
            return;
        }
                
        const installment = credit.installments?.find(inst => inst.id === installmentId);
        if (!installment) {
            showAlert('‚ùå Parcela n√£o encontrada', 'error');
            return;
        }
                
        if (installment.status === 'Pago') {
            showAlert('‚úÖ Esta parcela j√° est√° paga', 'success');
            return;
        }

        // Se veio do modal p√≥s-pagamento, pula a confirma√ß√£o
        if (!fromPostPayment) {
            // Confirmar solicita√ß√£o normalmente
            if (!confirm(`üí≥ Solicitar confirma√ß√£o de pagamento?\n\nParcela ${installmentNumber}: ${formatCurrency(installment.value)}\nVencimento: ${formatDate(installment.dueDate)}\n\nO administrador ser√° notificado para confirmar o pagamento.`)) {
                return;
            }
        }
                
        showLoading();
        
        // Simular envio da solicita√ß√£o (aqui voc√™ colocaria sua l√≥gica real)
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Atualizar status
        installment.status = 'Aguardando Confirma√ß√£o';
        installment.requestDate = new Date().toISOString();
        
        hideLoading();
        
        const message = fromPostPayment 
            ? '‚úÖ Confirma√ß√£o de pagamento solicitada! O administrador ser√° notificado.'
            : '‚úÖ Solicita√ß√£o enviada com sucesso!';
            
        showAlert(message, 'success');
        
        // Atualizar a interface se necess√°rio
        updateInstallmentDisplay(installmentId);
        
    } catch (error) {
        hideLoading();
        console.error('Erro na solicita√ß√£o:', error);
        showAlert('‚ùå Erro interno. Tente novamente.', 'error');
    }
}

/**
 * Atualizar a fun√ß√£o viewCreditDetailsWithApproval para usar a nova vers√£o
 */
function viewCreditDetailsWithApproval(creditId) {
    console.log('üëÅÔ∏è Visualizando detalhes com sistema de aprova√ß√£o:', creditId);
    
    if (!creditId || !appState || !appState.credits) {
        showAlert('‚ùå Dados n√£o encontrados', 'error');
        return;
    }
    
    const credit = appState.credits.find(c => c.id === creditId);
    if (!credit) {
        showAlert('‚ùå Credi√°rio n√£o encontrado', 'error');
        return;
    }
    
    const modal = ensureModalExists();
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    modalTitle.textContent = `${credit.productEmoji || 'üõí'} ${credit.productName}`;
    
    let content = `
        <div style="margin-bottom: 2rem;">
            <p><strong>Cliente:</strong> ${credit.clientName}</p>
            <p><strong>Loja:</strong> ${credit.storeEmoji || 'üè¨'} ${credit.storeName}</p>
            <p><strong>Descri√ß√£o:</strong> ${credit.productDescription}</p>
            <p><strong>Data da Compra:</strong> ${formatDate(credit.purchaseDate)}</p>
            <p><strong>Valor Total:</strong> ${formatCurrency(credit.totalValue)}</p>
        </div>
        <h4>Parcelas:</h4>
    `;
    
    if (credit.installments && credit.installments.length > 0) {
        credit.installments.forEach(inst => {
            const today = new Date();
            const dueDate = new Date(inst.dueDate);
            const isOverdue = inst.status !== 'Pago' && dueDate < today;
            
            const statusClass = inst.status === 'Pago' ? 'paid' : 
                              inst.status === 'Aguardando Confirma√ß√£o' ? 'pending-confirmation' :
                              isOverdue ? 'overdue' : 'pending';
            
            const statusText = inst.status === 'Pago' ? '‚úì Pago' : 
                             inst.status === 'Aguardando Confirma√ß√£o' ? '‚è≥ Aguardando Confirma√ß√£o' :
                             isOverdue ? '‚ö†Ô∏è Vencida' : '‚è≥ Pendente';
            
            const statusColor = inst.status === 'Pago' ? '#2ecc71' : 
                              inst.status === 'Aguardando Confirma√ß√£o' ? '#3498db' :
                              isOverdue ? '#e74c3c' : '#f39c12';
            
            content += `
                <div class="installment ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <strong>Parcela ${inst.number}</strong><br>
                            <small>Vencimento: ${formatDate(inst.dueDate)}</small>
                            ${inst.paymentDate ? `<br><small>Pago em: ${formatDate(inst.paymentDate)}</small>` : ''}
                            ${inst.requestDate ? `<br><small>Solicitado em: ${formatDate(inst.requestDate)}</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <strong>${formatCurrency(inst.value)}</strong><br>
                            <span style="color: ${statusColor};">${statusText}</span>
                        </div>
                    </div>
                    ${inst.status !== 'Pago' && inst.status !== 'Aguardando Confirma√ß√£o' ? `
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="action-btn btn-primary" onclick="getPaymentUrlFromSheet('${credit.id}', ${inst.number}, '${inst.id}')" style="flex: 1; min-width: 120px;">
                                üí≥ Pagar Online
                            </button>
                            <button class="action-btn btn-warning" onclick="requestPaymentConfirmation('${credit.id}', ${inst.number}, '${inst.id}', false)" style="flex: 1; min-width: 120px; background: #17a2b8;">
                                üìß Solicitar Confirma√ß√£o
                            </button>
                            <button class="action-btn btn-success" onclick="markAsPaidManually('${inst.id}')" style="flex: 1; min-width: 120px;">
                                ‚úÖ Marcar Pago
                            </button>
                        </div>
                    ` : inst.status === 'Aguardando Confirma√ß√£o' ? `
                        <div style="padding: 0.5rem; background: #e3f2fd; border-radius: 5px; text-align: center;">
                            <small style="color: #1976d2;">‚è≥ Aguardando confirma√ß√£o do administrador</small>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    } else {
        content += '<p style="text-align: center; color: #7f8c8d;">Nenhuma parcela encontrada</p>';
    }
    
    modalContent.innerHTML = content;
    modal.classList.add('active');
}

/**
 * Fun√ß√£o para atualizar display da parcela (se n√£o existir)
 */
function updateInstallmentDisplay(installmentId) {
    // Atualizar qualquer elemento visual que mostre o status da parcela
    console.log('Atualizando display da parcela:', installmentId);
    
    // Buscar elemento da parcela e atualizar se necess√°rio
    const elements = document.querySelectorAll(`[data-installment-id="${installmentId}"]`);
    elements.forEach(element => {
        // L√≥gica para atualizar o visual do elemento
        element.classList.add('updated');
    });
}
/**
 * Carregar e exibir solicita√ß√µes pendentes
 */
async function loadPendingPaymentRequests() {
    try {
        console.log('üìã Carregando solicita√ß√µes pendentes...');
        
        // Criar container se n√£o existir
        createPaymentRequestsContainer();
        
        showLoading();
        
        const result = await callGoogleScript('getPendingPaymentRequests');
        
        hideLoading();
        
        if (result && result.success) {
            const requests = result.requests || [];
            updatePaymentRequestsInterface(requests);
            console.log(`‚úÖ ${requests.length} solicita√ß√µes carregadas`);
            return requests;
        } else {
            console.error('‚ùå Erro ao carregar solicita√ß√µes:', result?.error);
            updatePaymentRequestsInterface([]);
            return [];
        }
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro de conex√£o ao carregar solicita√ß√µes:', error);
        updatePaymentRequestsInterface([]);
        return [];
    }
}

/**
 * Atualizar interface com as solicita√ß√µes
 */
function updatePaymentRequestsInterface(requests) {
    const container = document.getElementById('requestsList');
    const countBadge = document.getElementById('pendingCount');
    
    if (!container) {
        console.warn('‚ö†Ô∏è Container de solicita√ß√µes n√£o encontrado');
        return;
    }
    
    // Atualizar contador
    if (countBadge) {
        countBadge.textContent = requests.length;
        countBadge.style.background = requests.length > 0 ? 'rgba(220, 53, 69, 0.8)' : 'rgba(255,255,255,0.2)';
    }
    
    // Limpar container
    container.innerHTML = '';
    
    if (requests.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: #6c757d; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <h4 style="color: #28a745; margin-bottom: 0.5rem;">Nenhuma solicita√ß√£o pendente</h4>
                <p>Todas as solicita√ß√µes foram processadas!</p>
            </div>
        `;
        return;
    }
    
    // Gerar cards das solicita√ß√µes
    requests.forEach(request => {
        const requestCard = createPaymentRequestCard(request);
        container.appendChild(requestCard);
    });
    
    console.log(`‚úÖ Interface atualizada com ${requests.length} solicita√ß√µes`);
}

async function handleAdminRecovery(event) {
    event.preventDefault();
    
    const identifier = document.getElementById('adminRecoveryIdentifier').value.trim();
    const resultDiv = document.getElementById('adminRecoveryResult');
    
    if (!identifier) {
        showAdminRecoveryMessage('‚ùå Digite o CPF/CNPJ ou email do cliente', 'error');
        return;
    }
    
    try {
        showLoading();
        showAdminRecoveryMessage('üîÑ Gerando nova senha...', 'info');
        
        const result = await callGoogleScript('recoverPassword', identifier);
        
        hideLoading();
        
        if (result.success) {
            showAdminRecoveryMessage(`
                ‚úÖ Nova senha gerada!<br>
                <strong>üë§ Cliente:</strong> ${result.clientName}<br>
                <strong>üîë Nova Senha:</strong> <code style="background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: bold; font-size: 1.1rem;">${result.newPassword}</code><br>
                <button onclick="copyToClipboard('${result.newPassword}')" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; margin-top: 0.5rem; cursor: pointer;">üìã Copiar Senha</button>
            `, 'success');
            
            // Limpar formul√°rio
            document.getElementById('adminRecoveryIdentifier').value = '';
            
        } else {
            showAdminRecoveryMessage(`‚ùå ${result.error}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        console.error('Erro na recupera√ß√£o admin:', error);
        showAdminRecoveryMessage('‚ùå Erro de conex√£o', 'error');
    }
}


async function resetClientPasswordToDefault() {
    const identifier = document.getElementById('adminRecoveryIdentifier').value.trim();
    
    if (!identifier) {
        showAdminRecoveryMessage('‚ùå Digite o CPF/CNPJ ou email do cliente', 'error');
        return;
    }
    
    if (!confirm(`Resetar senha do cliente "${identifier}" para "123456"?`)) {
        return;
    }
    
    try {
        showLoading();
        
        const result = await callGoogleScript('resetPasswordByCpf', identifier, '123456');
        
        hideLoading();
        
        if (result.success) {
            showAdminRecoveryMessage(`
                ‚úÖ Senha resetada!<br>
                <strong>üë§ Cliente:</strong> ${result.loginInfo.nome}<br>
                <strong>üîë Nova Senha:</strong> <code style="background: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: bold;">123456</code>
            `, 'success');
            
            document.getElementById('adminRecoveryIdentifier').value = '';
        } else {
            showAdminRecoveryMessage(`‚ùå ${result.error}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        showAdminRecoveryMessage('‚ùå Erro de conex√£o', 'error');
    }
}

async function resetAllPasswords() {
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nEsta a√ß√£o vai resetar a senha de TODOS os clientes para "123456".\n\nDeseja continuar?')) {
        return;
    }
    
    try {
        showLoading();
        
        const result = await callGoogleScript('resetAllPasswordsToDefault');
        
        hideLoading();
        
        if (result.success) {
            showMassActionMessage(`
                ‚úÖ Reset em massa conclu√≠do!<br>
                <strong>üìä ${result.resetCount} senhas resetadas para "123456"</strong><br>
                <small>Todos os clientes agora podem fazer login com a senha padr√£o.</small>
            `, 'success');
        } else {
            showMassActionMessage(`‚ùå ${result.error}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        showMassActionMessage('‚ùå Erro de conex√£o', 'error');
    }
}

async function listAllPasswords() {
    try {
        showLoading();
        
        const result = await callGoogleScript('listClientsWithPasswords');
        
        hideLoading();
        
        if (result.success) {
            const passwordListDiv = document.getElementById('passwordList');
            const contentDiv = document.getElementById('passwordListContent');
            
            let content = '<div style="max-height: 400px; overflow-y: auto;">';
            
            result.clients.forEach((client, index) => {
                const senhaDisplay = client.senha || '‚ö†Ô∏è SEM SENHA';
                const statusColor = client.temSenha ? '#28a745' : '#dc3545';
                
                content += `
                    <div style="background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border-left: 4px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${client.nome}</strong><br>
                                <small>üìÑ ${client.cpf} | üìß ${client.email || 'Sem email'}</small>
                            </div>
                            <div style="text-align: right;">
                                <code style="background: #e9ecef; padding: 0.3rem 0.6rem; border-radius: 4px; font-weight: bold;">${senhaDisplay}</code><br>
                                <button onclick="copyToClipboard('${client.senha}')" style="background: #007bff; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; margin-top: 0.3rem; cursor: pointer;">üìã Copiar</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += '</div>';
            
            contentDiv.innerHTML = content;
            passwordListDiv.style.display = 'block';
            
            showMassActionMessage(`‚úÖ ${result.clients.length} clientes listados`, 'success');
            
        } else {
            showMassActionMessage(`‚ùå ${result.error}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        showMassActionMessage('‚ùå Erro de conex√£o', 'error');
    }
}

async function testRecoverySystem() {
    try {
        showLoading();
        
        const result = await callGoogleScript('testarSistemaRecuperacao');
        
        hideLoading();
        
        if (result.success) {
            showMassActionMessage(`
                üß™ Testes conclu√≠dos!<br>
                <strong>‚úÖ CPF:</strong> ${result.results.cpf ? 'OK' : 'Falhou'}<br>
                <strong>üìß Email:</strong> ${result.results.email ? 'OK' : 'Falhou'}<br>
                <strong>‚ùå Inv√°lido:</strong> ${result.results.invalid ? 'OK (rejeitou corretamente)' : 'Falhou'}<br>
                <small>Verifique o console do Apps Script para logs detalhados.</small>
            `, 'success');
        } else {
            showMassActionMessage(`‚ùå ${result.error}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        showMassActionMessage('‚ùå Erro de conex√£o', 'error');
    }
}

function hidePasswordList() {
    document.getElementById('passwordList').style.display = 'none';
}

        /**
         * Copiar texto para clipboard
         */
        function copyToClipboard(text) {
            try {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('üìã Link copiado para a √°rea de transfer√™ncia!', 'success');
                }).catch(() => {
                    // Fallback para navegadores mais antigos
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showAlert('üìã Link copiado!', 'success');
                });
            } catch (error) {
                console.error('‚ùå Erro ao copiar:', error);
                showAlert('‚ùå Erro ao copiar link', 'error');
            }
        }

function showAdminRecoveryMessage(message, type) {
    const resultDiv = document.getElementById('adminRecoveryResult');
    const className = type === 'success' ? 'alert alert-success' : 
                     type === 'error' ? 'alert alert-danger' : 'alert alert-warning';
    
    resultDiv.innerHTML = `<div class="${className}">${message}</div>`;
    
    // Auto-limpar ap√≥s 10 segundos para mensagens de sucesso
    if (type === 'success') {
        setTimeout(() => {
            resultDiv.innerHTML = '';
        }, 10000);
    }
}

function showMassActionMessage(message, type) {
    const resultDiv = document.getElementById('massActionResult') || document.getElementById('adminRecoveryResult');
    if (resultDiv) {
        const className = type === 'success' ? 'alert alert-success' : 
                         type === 'error' ? 'alert alert-danger' : 'alert alert-warning';
        
        resultDiv.innerHTML = `<div class="${className}">${message}</div>`;
        
        if (type === 'success') {
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 10000);
        }
    }
}
// ===== 2Ô∏è‚É£ FUN√á√ÉO CLIENTE: SOLICITAR CONFIRMA√á√ÉO DE PAGAMENTO =====
async function requestPaymentConfirmation(creditId, installmentNumber, installmentId) {
    try {
        // Buscar dados da parcela
        const credit = appState.credits?.find(c => c.id === creditId);
        if (!credit) {
            showAlert('‚ùå Credi√°rio n√£o encontrado', 'error');
            return;
        }
        
        const installment = credit.installments?.find(inst => inst.id === installmentId);
        if (!installment) {
            showAlert('‚ùå Parcela n√£o encontrada', 'error');
            return;
        }
        
        if (installment.status === 'Pago') {
            showAlert('‚úÖ Esta parcela j√° est√° paga', 'success');
            return;
        }
        
        // Confirmar solicita√ß√£o
        if (!confirm(`üí≥ Solicitar confirma√ß√£o de pagamento?\n\nParcela ${installmentNumber}: ${formatCurrency(installment.value)}\nVencimento: ${formatDate(installment.dueDate)}\n\nO administrador ser√° notificado para confirmar o pagamento.`)) {
            return;
        }
        
        showLoading();
        
        // Enviar solicita√ß√£o para o backend
        const result = await callGoogleScript('requestPaymentConfirmation', {
            creditId: creditId,
            installmentId: installmentId,
            installmentNumber: installmentNumber,
            clientName: appState.userData?.name || 'Cliente',
            clientEmail: appState.userData?.email || '',
            productName: credit.productName,
            storeName: credit.storeName,
            installmentValue: installment.value,
            dueDate: installment.dueDate,
            requestDate: new Date().toISOString().split('T')[0],
            note: 'Pagamento realizado - aguardando confirma√ß√£o'
        });
        
        hideLoading();
        
        if (result && result.success) {
            showAlert('üìß Solicita√ß√£o enviada! O administrador foi notificado para confirmar seu pagamento.', 'success');
            closeModal();
            
            // Mostrar modal de acompanhamento
            setTimeout(() => {
                showPaymentRequestStatus(result.requestId);
            }, 1000);
            
        } else {
            showAlert(`‚ùå Erro ao enviar solicita√ß√£o: ${result?.error || 'Erro desconhecido'}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro na solicita√ß√£o:', error);
        showAlert('‚ùå Erro de conex√£o', 'error');
    }
}
// ===== 3Ô∏è‚É£ MODAL DE STATUS DA SOLICITA√á√ÉO =====
function showPaymentRequestStatus(requestId) {
    const modal = ensureModalExists();
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    modalTitle.textContent = 'üìã Solicita√ß√£o Enviada';

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <h3 style="color: #1976d2; margin-bottom: 1rem;">‚úÖ Solicita√ß√£o Registrada</h3>
                <p style="color: #666; margin-bottom: 1rem;">
                    Sua solicita√ß√£o de confirma√ß√£o de pagamento foi enviada com sucesso!
                </p>
                <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px dashed #1976d2; margin: 1rem 0;">
                    <strong>ID da Solicita√ß√£o:</strong> ${requestId || 'Gerado automaticamente'}
                </div>
            </div>
            
            <div style="background: #fff3e0; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: #f57900; margin-bottom: 0.5rem;">üìã Pr√≥ximos Passos:</h4>
                <ul style="text-align: left; color: #666; margin: 0.5rem 0;">
                    <li>O administrador ser√° notificado</li>
                    <li>Sua solicita√ß√£o ser√° analisada</li>
                    <li>Voc√™ receber√° confirma√ß√£o em breve</li>
                    <li>O status ser√° atualizado automaticamente</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="action-btn btn-primary" onclick="checkRequestStatus('${requestId}')" style="flex: 1;">
                    üîÑ Verificar Status
                </button>
                <button class="action-btn btn-secondary" onclick="closeModal()" style="flex: 1; background: #6c757d;">
                    ‚úÖ Entendi
                </button>
            </div>
        </div>
    `;

    modal.classList.add('active');
}


// ========================================
// RECUPERA√á√ÉO ULTRA COMPACTA - WHATSAPP
// ========================================

function abrirRecuperacaoWhatsApp() {
    const identifier = document.getElementById('clientIdentifier').value.trim();
    const numero = '556262996373091';
    
    // Detectar se √© CPF ou email para personalizar a mensagem
    const isCPF = identifier.match(/^\d{3}\.?\d{3}\.?\d{3}-?\d{2}$/) || identifier.match(/^\d{11}$/);
    const isEmail = identifier.includes('@');
    
    let tipoIdentificador = 'CPF';
    if (isCPF) tipoIdentificador = 'CPF';
    else if (isEmail) tipoIdentificador = 'Email';
    
    const mensagem = `üîë Preciso recuperar minha senha do StarkTech

üìã ${tipoIdentificador}: ${identifier || '[Digite aqui]'}
üë§ Nome: [Digite seu nome]

Obrigado!`;
    
    const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
    
    // Abrir WhatsApp
    window.open(url, '_blank');
    
    // Feedback visual
    showAlert('üì± WhatsApp aberto! Envie a mensagem para recuperar sua senha.', 'success');
}
// ========================================
// MELHORIAS AUTOM√ÅTICAS
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    // Auto-detectar quando usu√°rio digita algo para facilitar recupera√ß√£o
    const identifierField = document.getElementById('clientIdentifier');
    
    if (identifierField) {
        identifierField.addEventListener('input', function() {
            const value = this.value.trim();
            const recoveryBtn = document.querySelector('.whatsapp-recovery-btn');
            
            if (value.length >= 3 && recoveryBtn) {
                // Mudar texto do bot√£o baseado no que foi digitado
                if (value.includes('@')) {
                    recoveryBtn.innerHTML = 'üì± Recuperar (Email)';
                } else if (value.match(/\d/)) {
                    recoveryBtn.innerHTML = 'üì± Recuperar (Senha)';
                } else {
                    recoveryBtn.innerHTML = 'üì± Esqueci minha senha';
                }
            }
        });
    }
});

        function getMockResponse(functionName, parameters) {
    switch (functionName) {
        case 'handleLogin':
            if (parameters.userType === 'admin' && parameters.user === 'admin' && parameters.password === 'cf@2025stark') {
                return {
                    success: true,
                    userType: 'admin',
                    userData: { name: 'Administrador', user: 'admin' }
                };
            } else if (parameters.userType === 'client') {
                if (parameters.identifier === '762.538.452-65' && parameters.password === '2025026') {
                    return {
                        success: true,
                        userType: 'client',
                        userData: { 
                            id: 'jackeline', 
                            name: 'Jackeline Duarte', 
                            cpf: '762.538.452-65', 
                            email: 'duarte@gmail.com'
                        }
                    };
                } else if (parameters.identifier === '123.456.789-00' && parameters.password === '123456') {
                    return {
                        success: true,
                        userType: 'client',
                        userData: { 
                            id: 'srwhite', 
                            name: 'Sr¬∞White & Wanderson', 
                            cpf: '123.456.789-00', 
                            email: 'wanderson@email.com'
                        }
                    };
                } else if (parameters.identifier === '987.654.321-00' && parameters.password === 'senha123') {
                    return {
                        success: true,
                        userType: 'client',
                        userData: { 
                            id: 'maria', 
                            name: 'Maria Silva', 
                            cpf: '987.654.321-00', 
                            email: 'maria@email.com'
                        }
                    };
                }
            }
            return { success: false, error: 'CPF/CNPJ ou senha incorretos' };

        case 'requestPaymentConfirmation':
            return {
                success: true,
                requestId: 'req_' + Date.now(),
                message: 'Solicita√ß√£o registrada com sucesso'
            };

        case 'getPendingPaymentRequests':
            return {
                success: true,
                requests: [
                    {
                        id: 'req_001',
                        clientName: appState?.userData?.name || 'Cliente Teste',
                        clientEmail: appState?.userData?.email || 'cliente@teste.com',
                        productName: 'Produto Teste',
                        storeName: 'Loja Teste',
                        installmentNumber: 1,
                        installmentValue: 150.00,
                        dueDate: '2025-03-15',
                        requestDate: '2025-01-25',
                        status: 'pendente',
                        note: 'Pagamento realizado via PIX'
                    }
                ]
            };

        case 'approvePaymentRequest':
            return {
                success: true,
                message: 'Pagamento aprovado e parcela marcada como paga',
                allPaid: false
            };

        case 'rejectPaymentRequest':
            return {
                success: true,
                message: 'Solicita√ß√£o rejeitada e cliente notificado'
            };

        case 'getPaymentRequestStatus':
            return {
                success: true,
                status: Math.random() > 0.5 ? 'aprovado' : 'pendente'
            };

        case 'loadClientData':
            if (parameters === 'jackeline') {
                return {
                    success: true,
                    data: {
                        totalCredits: 2,
                        totalDebt: 280.00,
                        overdueCount: 0,
                        credits: [
                            {
                                id: 'credit1',
                                clientName: 'Jackeline Duarte',
                                productName: 'Kit Maquiagem Natura',
                                productDescription: 'Kit completo Una com batom, base e p√≥',
                                productEmoji: 'üíÑ',
                                storeName: 'Loja Natura',
                                storeEmoji: 'üåø',
                                totalValue: 420.00,
                                purchaseDate: '2025-01-10',
                                installments: [
                                    { id: 'inst1', number: 1, value: 140.00, dueDate: '2025-02-10', status: 'Pago', paymentDate: '2025-02-08' },
                                    { id: 'inst2', number: 2, value: 140.00, dueDate: '2025-03-10', status: 'Pago', paymentDate: '2025-03-05' },
                                    { id: 'inst3', number: 3, value: 140.00, dueDate: '2025-04-10', status: 'Pendente', paymentDate: null }
                                ]
                            },
                            {
                                id: 'credit2',
                                clientName: 'Jackeline Duarte',
                                productName: 'Perfume Kaiak Feminino',
                                productDescription: 'Kaiak Feminino 100ml',
                                productEmoji: 'üå∏',
                                storeName: 'Loja Natura',
                                storeEmoji: 'üåø',
                                totalValue: 280.00,
                                purchaseDate: '2025-01-20',
                                installments: [
                                    { id: 'inst4', number: 1, value: 140.00, dueDate: '2025-02-20', status: 'Pago', paymentDate: '2025-02-18' },
                                    { id: 'inst5', number: 2, value: 140.00, dueDate: '2025-03-20', status: 'Pendente', paymentDate: null }
                                ]
                            }
                        ]
                    }
                };
            } else if (parameters === 'srwhite') {
                return {
                    success: true,
                    data: {
                        totalCredits: 1,
                        totalDebt: 150.00,
                        overdueCount: 0,
                        credits: [
                            {
                                id: 'credit3',
                                clientName: 'Sr¬∞White & Wanderson',
                                productName: 'Kit Presente Egeo',
                                productDescription: 'Egeo Blue + Desodorante + Gel',
                                productEmoji: 'üéÅ',
                                storeName: 'Sr¬∞White Store',
                                storeEmoji: 'üè¨',
                                totalValue: 300.00,
                                purchaseDate: '2025-01-15',
                                installments: [
                                    { id: 'inst6', number: 1, value: 150.00, dueDate: '2025-02-15', status: 'Pago', paymentDate: '2025-02-12' },
                                    { id: 'inst7', number: 2, value: 150.00, dueDate: '2025-03-15', status: 'Pendente', paymentDate: null }
                                ]
                            }
                        ]
                    }
                };
            } else if (parameters === 'maria') {
                return {
                    success: true,
                    data: {
                        totalCredits: 1,
                        totalDebt: 120.00,
                        overdueCount: 1,
                        credits: [
                            {
                                id: 'credit4',
                                clientName: 'Maria Silva',
                                productName: 'Smartphone Galaxy A14',
                                productDescription: 'Galaxy A14 4G 128GB Preto',
                                productEmoji: 'üì±',
                                storeName: 'TechShop',
                                storeEmoji: 'üè™',
                                totalValue: 600.00,
                                purchaseDate: '2024-12-01',
                                installments: [
                                    { id: 'inst8', number: 1, value: 120.00, dueDate: '2025-01-01', status: 'Pago', paymentDate: '2024-12-30' },
                                    { id: 'inst9', number: 2, value: 120.00, dueDate: '2025-02-01', status: 'Pago', paymentDate: '2025-01-28' },
                                    { id: 'inst10', number: 3, value: 120.00, dueDate: '2025-03-01', status: 'Pago', paymentDate: '2025-02-25' },
                                    { id: 'inst11', number: 4, value: 120.00, dueDate: '2025-04-01', status: 'Pago', paymentDate: '2025-03-28' },
                                    { id: 'inst12', number: 5, value: 120.00, dueDate: '2025-05-01', status: 'Pendente', paymentDate: null }
                                ]
                            }
                        ]
                    }
                };
            }
            return {
                success: true,
                data: {
                    totalCredits: 0,
                    totalDebt: 0,
                    overdueCount: 0,
                    credits: []
                }
            };

        case 'loadAdminData':
            return {
                success: true,
                clients: [],
                credits: [],
                dashboard: {
                    totalCredits: 0,
                    totalDebt: 0,
                    overdueCount: 0,
                    collectionRate: 0
                }
            };

        case 'resetPasswordByCpf':
        case 'resolverProblemaJackeline':
            if (parameters.cpf === '762.538.452-65') {
                return {
                    success: true,
                    message: 'Senha da Jackeline resetada para 123456',
                    loginInfo: {
                        cpf: '762.538.452-65',
                        senha: '123456',
                        nome: 'jackeline duarte'
                    }
                };
            }
            return { success: false, error: 'Cliente n√£o encontrado' };

        case 'updateClient':
            return { success: true, message: 'Cliente atualizado com sucesso' };

        default:
            return { success: true, message: 'Fun√ß√£o mockada' };
    }
}


        // ========================================
        // FUN√á√ïES DE UI E UTILIT√ÅRIAS (MANTIDAS IGUAIS)
        // ========================================
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            const bgColor = type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : type === 'warning' ? '#f39c12' : '#3498db';
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            alertDiv.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 9999;
                font-weight: bold;
                max-width: 350px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            `;
            
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>${icon}</span>
                    <div style="flex: 1;">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; opacity: 0.7;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

function showSyncStatus(message, type = 'info', duration = 3000) {
    try {
        // Verificar se elemento existe, se n√£o criar
        let syncStatus = document.getElementById('syncStatus');
        
        if (!syncStatus) {
            // Criar elemento dinamicamente
            syncStatus = document.createElement('div');
            syncStatus.id = 'syncStatus';
            syncStatus.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 0.8rem 1.2rem;
                border-radius: 25px;
                color: white;
                font-size: 0.9rem;
                z-index: 1001;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                min-width: 200px;
                text-align: center;
                display: none;
            `;
            document.body.appendChild(syncStatus);
        }
        
        // Definir cor baseada no tipo
        const colors = {
            success: '#2ecc71',
            error: '#e74c3c', 
            warning: '#f39c12',
            loading: '#3498db',
            info: '#17a2b8'
        };
        
        // Aplicar estilo e mostrar
        syncStatus.style.background = colors[type] || colors.info;
        syncStatus.textContent = message;
        syncStatus.style.display = 'block';
        
        // Ocultar automaticamente
        setTimeout(() => {
            if (syncStatus) {
                syncStatus.style.display = 'none';
            }
        }, duration);
        
        console.log(`üì¢ ${message} [${type}]`);
        
    } catch (error) {
        console.error('Erro no showSyncStatus:', error);
        // Fallback: usar console
        console.log(`üì¢ ${message}`);
    }
}

// ========================================
// 2Ô∏è‚É£ ADICIONAR ESTAS FUN√á√ïES DE BACKUP:
// ========================================

// Vers√£o ainda mais simples se a anterior falhar
function showMessage(message, type = 'info') {
    console.log(`üì¢ [${type.toUpperCase()}] ${message}`);
    
    // Criar notifica√ß√£o tempor√°ria
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${type === 'success' ? '#2ecc71' : type === 'error' ? '#e74c3c' : '#3498db'};
        color: white;
        padding: 1rem;
        border-radius: 8px;
        z-index: 9999;
        font-weight: bold;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Fun√ß√£o de teste para verificar se est√° funcionando
function testarNotificacoes() {
    showSyncStatus('Teste 1: Sucesso! ‚úÖ', 'success');
    
    setTimeout(() => {
        showSyncStatus('Teste 2: Erro! ‚ùå', 'error');
    }, 1500);
    
    setTimeout(() => {
        showSyncStatus('Teste 3: Aviso! ‚ö†Ô∏è', 'warning');
    }, 3000);
    
    setTimeout(() => {
        showMessage('Teste 4: Backup funcionando! üîÑ', 'info');
    }, 4500);
}

// ========================================
// 3Ô∏è‚É£ SUBSTITUIR TODAS AS CHAMADAS showSyncStatus POR ESTA VERS√ÉO SEGURA:
// ========================================

function safeSyncStatus(message, type = 'info') {
    try {
        showSyncStatus(message, type);
    } catch (error) {
        try {
            showMessage(message, type);
        } catch (error2) {
            console.log(`üì¢ ${message} [${type}]`);
        }
    }
}

// ========================================
// EXEMPLOS DE USO (substitua nas suas fun√ß√µes):
// ========================================

/*
// ANTES (causava erro):
showSyncStatus('Login realizado! ‚úÖ', 'success');

// DEPOIS (√† prova de erros):
safeSyncStatus('Login realizado! ‚úÖ', 'success');
*/

// ========================================
// INICIALIZA√á√ÉO AUTOM√ÅTICA
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Sistema de notifica√ß√µes seguro carregado');
    
    // Teste autom√°tico (remova depois se quiser)
    setTimeout(() => {
        safeSyncStatus('Sistema carregado! üöÄ', 'success');
    }, 1000);
});

console.log('üîß Corre√ß√£o do syncStatus aplicada - erro resolvido!');

        // ========================================
        // FUN√á√ïES PRINCIPAIS
        // ========================================

        async function handleClientLogin(event) {
            event.preventDefault();
            
            const identifier = document.getElementById('clientIdentifier').value;
            const password = document.getElementById('clientPassword').value;
            
            try {
                const result = await callGoogleScript('handleLogin', {
                    userType: 'client',
                    identifier: identifier,
                    password: password
                });
                
                if (result.success) {
                    appState.currentUser = result.userData.name;
                    appState.userType = 'client';
                    appState.userData = result.userData;
                    
                    showApp();
                    showAlert('Login realizado! ‚úÖ', 'success');
                    await loadClientData();
                } else {
                    showAlert(result.error || 'Erro no login', 'error');
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showAlert('Erro de conex√£o. Tente novamente.', 'error');
            }
        }


        async function handleAdminLogin(event) {
    event.preventDefault();
    
    const user = document.getElementById('adminUser').value;
    const password = document.getElementById('adminPass').value;
    
    try {
        const result = await callGoogleScript('handleLogin', {
            userType: 'admin',
            user: user,
            password: password
        });
        
        hideLoading();
        
        if (result.success) {
            appState.currentUser = 'Administrador';
            appState.userType = 'admin';
            appState.userData = result.userData;
            
            showApp();
            showAlert('Admin logado! ‚úÖ', 'success');
            await loadAdminData();
        } else {
            showAlert(result.error || 'Erro no login', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Erro no login:', error);
        showAlert('Erro de conex√£o. Tente novamente.', 'error');
    }
}

        async function loadClientData() {
            try {
                const clientId = appState.userData.id; // Usar o ID do usu√°rio logado
                const result = await callGoogleScript('loadClientData', clientId);
                hideLoading();
                
                if (result.success) {
                    appState.credits = result.data.credits || [];
                    updateClientDashboard(result.data);
                } else {
                    showAlert('Erro ao carregar dados', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao carregar dados do cliente:', error);
                showAlert('Erro de conex√£o', 'error');
            }
        }

        async function loadAdminData() {
            try {
                const result = await callGoogleScript('loadAdminData');
                hideLoading();
                
                if (result.success) {
                    appState.clients = result.clients || [];
                    appState.credits = result.credits || [];
                    updateAdminDashboard(result.dashboard);
                    updateClientsInterface();
                } else {
                    showAlert('Erro ao carregar dados administrativos', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao carregar dados administrativos:', error);
                showAlert('Erro de conex√£o', 'error');
            }
        }

        function updateClientDashboard(data) {
            document.getElementById('totalCredits').textContent = data.totalCredits || 0;
            document.getElementById('totalDebt').textContent = formatCurrency(data.totalDebt || 0);
            document.getElementById('overdueCount').textContent = data.overdueCount || 0;
            
            generateClientCards(data.credits || []);
        }

        function updateAdminDashboard(data) {
            document.getElementById('totalClients').textContent = appState.clients.length;
            document.getElementById('totalReceivable').textContent = formatCurrency(data.totalDebt || 0);
            document.getElementById('adminOverdueCount').textContent = data.overdueCount || 0;
            document.getElementById('collectionRate').textContent = (data.collectionRate || 0) + '%';
            
            generateAdminCards();
        }
        // ========================================
// FUN√á√ÉO generateAdminCards (ESTAVA FALTANDO)
// ========================================

function generateAdminCards() {
    const container = document.getElementById('adminCards');
    
    // Verificar se o container existe
    if (!container) {
        console.warn('‚ö†Ô∏è Container adminCards n√£o encontrado');
        return;
    }
    
    container.innerHTML = '';

    // Se n√£o h√° credi√°rios, mostrar mensagem
    if (!appState.credits || appState.credits.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #7f8c8d; font-size: 1.2rem; padding: 2rem;">Nenhum credi√°rio encontrado</div>';
        return;
    }

    // Gerar cards para cada credi√°rio
    appState.credits.forEach(credit => {
        const totalAmount = credit.totalValue || 0;
        const paidAmount = credit.installments
            ? credit.installments
                .filter(inst => inst.status === 'Pago')
                .reduce((sum, inst) => sum + (inst.value || 0), 0)
            : 0;
        const remainingAmount = totalAmount - paidAmount;
        const progressPercent = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
        
        // Calcular parcelas em atraso
        const today = new Date();
        const overdueCount = credit.installments
            ? credit.installments.filter(inst => {
                if (inst.status === 'Pago') return false;
                const dueDate = new Date(inst.dueDate);
                return dueDate < today;
            }).length
            : 0;

        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';
        cardDiv.innerHTML = `
            <div class="card-header">
                <div class="card-icon" style="background: ${overdueCount > 0 ? '#e74c3c' : progressPercent === 100 ? '#2ecc71' : '#3498db'}; color: white;">
                    ${credit.productEmoji || 'üõí'}
                </div>
                <div>
                    <h3>${credit.productName || 'Produto'}</h3>
                    <p style="color: #7f8c8d;">${credit.clientName || 'Cliente'}</p>
                    <small style="color: #7f8c8d;">${credit.storeName || 'Loja'}</small>
                </div>
            </div>
            <div style="font-size: 1.8rem; font-weight: bold; color: #2c3e50; margin-bottom: 1rem;">
                ${formatCurrency(totalAmount)}
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercent}%; background: ${overdueCount > 0 ? '#e74c3c' : '#2ecc71'};"></div>
            </div>
            <div style="text-align: center; margin-bottom: 1rem;">
                ${progressPercent}% pago
                ${overdueCount > 0 ? `<br><span style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è ${overdueCount} em atraso</span>` : ''}
            </div>
            <div class="amounts">
                <span class="amount-paid">${formatCurrency(paidAmount)}<br><small>Pago</small></span>
                <span class="amount-remaining">${formatCurrency(remainingAmount)}<br><small>Restante</small></span>
            </div>
            <button class="action-btn btn-primary" onclick="viewCreditDetailsWithApproval('${credit.id}')">
                Ver Detalhes
            </button>
        `;
        container.appendChild(cardDiv);
    });

    console.log(`‚úÖ ${appState.credits.length} cards administrativos gerados`);
}

// ========================================
// ADICIONAR A FUN√á√ÉO AO ESCOPO GLOBAL
// ========================================
window.generateAdminCards = generateAdminCards;

        function generateClientCards(credits) {
            const container = document.getElementById('clientCards');
            container.innerHTML = '';

            if (credits.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7f8c8d; font-size: 1.2rem; padding: 2rem;">Nenhum credi√°rio encontrado</div>';
                return;
            }

            credits.forEach(credit => {
                const totalAmount = credit.totalValue;
                const paidAmount = credit.installments
                    .filter(inst => inst.status === 'Pago')
                    .reduce((sum, inst) => sum + inst.value, 0);
                const remainingAmount = totalAmount - paidAmount;
                const progressPercent = Math.round((paidAmount / totalAmount) * 100);

                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.innerHTML = `
                    <div class="card-header">
                        <div class="card-icon" style="background: #3498db; color: white;">
                            ${credit.productEmoji || 'üõí'}
                        </div>
                        <div>
                            <h3>${credit.productName}</h3>
                            <p style="color: #7f8c8d;">${credit.storeName}</p>
                        </div>
                    </div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #2c3e50; margin-bottom: 1rem;">
                        ${formatCurrency(totalAmount)}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%;"></div>
                    </div>
                    <div style="text-align: center; margin-bottom: 1rem;">${progressPercent}% pago</div>
                    <div class="amounts">
                        <span class="amount-paid">${formatCurrency(paidAmount)}<br><small>Pago</small></span>
                        <span class="amount-remaining">${formatCurrency(remainingAmount)}<br><small>Restante</small></span>
                    </div>
                    <button class="action-btn btn-primary" onclick="viewCreditDetailsWithApproval('${credit.id}')">
                        Ver Detalhes
                    </button>
                `;
                container.appendChild(cardDiv);
            });
        }
        // ========================================
// FUN√á√ïES PLACEHOLDER (PARA N√ÉO QUEBRAR)
// ========================================

function openPaymentUrl(creditId, installmentNumber, installmentId) {
    showAlert('üîó Funcionalidade de pagamento em desenvolvimento', 'warning');
}

function markAsPaidManually(installmentId) {
    if (confirm('Marcar esta parcela como paga?')) {
        showAlert('‚úÖ Funcionalidade em desenvolvimento', 'warning');
    }
}

function editClient(clientId) {
    showAlert('‚úèÔ∏è Funcionalidade de edi√ß√£o em desenvolvimento', 'warning');
}

async function createClient(event) {
    event.preventDefault();
    showAlert('üìù Funcionalidade de cria√ß√£o de cliente em desenvolvimento', 'warning');
}

async function createCredit(event) {
    event.preventDefault();
    showAlert('üìù Funcionalidade de cria√ß√£o de credi√°rio em desenvolvimento', 'warning');
}
// ========================================
// FUN√á√ïES ADICIONAIS DO SISTEMA ORIGINAL
// ========================================
function switchAdminTabWithApprovals(tabName) {
    try {
        // Chamar fun√ß√£o original se existir
        if (typeof switchAdminTab === 'function' && tabName !== 'aprovacoes') {
            switchAdminTab(tabName);
            return;
        }
        
        // Remover classe active de todas as abas
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Adicionar classe active na aba clicada
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        const tabElement = document.getElementById(`adminTab-${tabName}`);
        if (tabElement) {
            tabElement.classList.add('active');
        }
        
        // A√ß√µes espec√≠ficas por aba
        switch(tabName) {
            case 'aprovacoes':
                loadPendingPaymentRequests();
                break;
            case 'clientes':
                if (typeof refreshClientsList === 'function') {
                    refreshClientsList();
                }
                break;
            case 'creditos':
                if (typeof updateClientSelect === 'function') {
                    updateClientSelect();
                }
                if (typeof setTodayDate === 'function') {
                    setTodayDate();
                }
                break;
        }
        
        console.log('‚úÖ Admin tab alterada para:', tabName);
    } catch (error) {
        console.error('‚ùå Erro ao alternar admin tab:', error);
    }
}

        function updateClientsInterface() {
            updateClientsList();
            updateClientSelect();
        }

        async function testarLoginJackeline() {
            document.getElementById('clientIdentifier').value = '762.538.452-65';
            document.getElementById('clientPassword').value = '2025026';
            
            showSyncStatus('Testando login da Jackeline...', 'loading');
            
            try {
                const result = await callGoogleScript('handleLogin', {
                    userType: 'client',
                    identifier: '762.538.452-65',
                    password: '2025026'
                });
                
                hideLoading();
                
                if (result.success) {
                    appState.currentUser = result.userData.name;
                    appState.userType = 'client';
                    appState.userData = result.userData;
                    
                    showApp();
                    showSyncStatus('Login da Jackeline OK! ‚úÖ', 'success');
                    await loadClientData();
                } else {
                    showAlert('‚ùå Login falhou: ' + (result.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no teste:', error);
                showAlert('Erro de conex√£o. Verifique se o Google Apps Script est√° configurado.', 'warning');
            }
        }

        async function testarLoginSrWhite() {
            document.getElementById('clientIdentifier').value = '123.456.789-00';
            document.getElementById('clientPassword').value = '123456';
            
            showSyncStatus('Testando login Sr¬∞White...', 'loading');
            
            try {
                const result = await callGoogleScript('handleLogin', {
                    userType: 'client',
                    identifier: '123.456.789-00',
                    password: '123456'
                });
                
                hideLoading();
                
                if (result.success) {
                    appState.currentUser = result.userData.name;
                    appState.userType = 'client';
                    appState.userData = result.userData;
                    
                    showApp();
                    showSyncStatus('Login Sr¬∞White OK! ‚úÖ', 'success');
                    await loadClientData();
                } else {
                    showAlert('‚ùå Login falhou: ' + (result.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no teste:', error);
                showAlert('Erro de conex√£o. Verifique se o Google Apps Script est√° configurado.', 'warning');
            }
        }

        async function testarLoginMaria() {
            document.getElementById('clientIdentifier').value = '987.654.321-00';
            document.getElementById('clientPassword').value = 'senha123';
            
            showSyncStatus('Testando login Maria...', 'loading');
            
            try {
                const result = await callGoogleScript('handleLogin', {
                    userType: 'client',
                    identifier: '987.654.321-00',
                    password: 'senha123'
                });
                
                hideLoading();
                
                if (result.success) {
                    appState.currentUser = result.userData.name;
                    appState.userType = 'client';
                    appState.userData = result.userData;
                    
                    showApp();
                    showSyncStatus('Login Maria OK! ‚úÖ', 'success');
                    await loadClientData();
                } else {
                    showAlert('‚ùå Login falhou: ' + (result.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no teste:', error);
                showAlert('Erro de conex√£o. Verifique se o Google Apps Script est√° configurado.', 'warning');
            }
        }

        async function resolverProblemaLogin() {
            if (!confirm('Resetar todas as senhas dos clientes para "123456"?')) {
                return;
            }

            try {
                const result = await callGoogleScript('resolverProblemaJackeline');
                hideLoading();
                
                if (result.success) {
                    showSyncStatus('Senhas resetadas! ‚úÖ', 'success');
                    showAlert('üéâ Problema resolvido! Agora voc√™ pode fazer login com:\n\nüì± CPF: 762.538.452-65\nüîê Senha: 123456', 'success');
                } else {
                    showAlert(result.error || 'Erro ao resetar senhas', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao resetar senhas:', error);
                showAlert('Erro de conex√£o', 'error');
            }
        }

        function updateClientsList() {
            const container = document.getElementById('clientsList');
            container.innerHTML = '';
            
            if (appState.clients.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 1rem;">Nenhum cliente cadastrado</div>';
                return;
            }
            
            appState.clients.forEach(client => {
                const clientDiv = document.createElement('div');
                clientDiv.style.cssText = 'background: #f8f9fa; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border-left: 4px solid #3498db;';
                clientDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>üë§ ${client.name}</strong><br>
                            <small style="color: #7f8c8d;">üìÑ ${client.cpf}</small>
                        </div>
                        <div>
                            <button class="action-btn btn-primary" style="padding: 0.5rem; font-size: 0.8rem;" onclick="editClient('${client.id}')">
                                Editar
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(clientDiv);
            });
        }

        function updateClientSelect() {
            const select = document.getElementById('selectClient');
            select.innerHTML = '<option value="">Selecione o Cliente</option>';
            
            appState.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} - ${client.cpf}`;
                select.appendChild(option);
            });
        }

        async function createClient(event) {
            event.preventDefault();
            
            const clientData = {
                name: document.getElementById('newClientName').value,
                cpf: document.getElementById('newClientCpf').value,
                email: document.getElementById('newClientEmail').value,
                phone: document.getElementById('newClientPhone').value,
                password: document.getElementById('newClientPassword').value
            };
            
            try {
                const result = await callGoogleScript('createClient', clientData);
                hideLoading();
                
                if (result.success) {
                    showSyncStatus('Cliente cadastrado! ‚úÖ', 'success');
                    document.getElementById('newClientForm').reset();
                    await loadAdminData(); // Recarregar dados
                } else {
                    showAlert(result.error || 'Erro ao cadastrar cliente', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao criar cliente:', error);
                showAlert('Erro de conex√£o', 'error');
            }
        }

        async function createCredit(event) {
            event.preventDefault();
            
            const creditData = {
                clientId: document.getElementById('selectClient').value,
                productName: document.getElementById('newProductName').value,
                productDescription: document.getElementById('newProductDescription').value,
                productEmoji: document.getElementById('newProductEmoji').value,
                totalValue: parseFloat(document.getElementById('newTotalValue').value),
                purchaseDate: document.getElementById('newPurchaseDate').value,
                storeName: document.getElementById('newStoreName').value,
                storeEmoji: document.getElementById('newStoreEmoji').value,
                installments: parseInt(document.getElementById('newInstallments').value)
            };
            
            try {
                const result = await callGoogleScript('createCredit', creditData);
                hideLoading();
                
                if (result.success) {
                    showSyncStatus('Credi√°rio criado! ‚úÖ', 'success');
                    document.getElementById('newCreditForm').reset();
                    await loadAdminData(); // Recarregar dados
                } else {
                    showAlert(result.error || 'Erro ao criar credi√°rio', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao criar credi√°rio:', error);
                showAlert('Erro de conex√£o', 'error');
            }
        }

        async function payInstallment(creditId, installmentNumber) {
            if (!confirm(`Confirmar pagamento da parcela ${installmentNumber}?`)) {
                return;
            }
            
            try {
                // Encontrar o ID da parcela
                const credit = appState.credits.find(c => c.id === creditId);
                if (!credit) {
                    showAlert('Credi√°rio n√£o encontrado', 'error');
                    return;
                }
                
                const installment = credit.installments.find(inst => inst.number === installmentNumber);
                if (!installment) {
                    showAlert('Parcela n√£o encontrada', 'error');
                    return;
                }
                
                const result = await callGoogleScript('payInstallment', installment.id);
                hideLoading();
                
                if (result.success) {
                    showSyncStatus('Pagamento registrado! üéâ', 'success');
                    closeModal();
                    
                    // Recarregar dados baseado no tipo de usu√°rio
                    if (appState.userType === 'client') {
                        await loadClientData();
                    } else {
                        await loadAdminData();
                    }
                } else {
                    showAlert(result.error || 'Erro ao registrar pagamento', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao pagar parcela:', error);
                showAlert('Erro de conex√£o', 'error');
            }
        }
      // ========================================
// FORMATA√á√ÉO AUTOM√ÅTICA - FRONTEND COMPLETO
// SUBSTITUA as fun√ß√µes existentes por estas
// ========================================

/**
 * Configurar formata√ß√£o autom√°tica em campo
 */
function setupAutoFormatting(fieldId, type) {
    const field = document.getElementById(fieldId);
    if (!field) {
        console.log(`‚ö†Ô∏è Campo ${fieldId} n√£o encontrado`);
        return;
    }
    
    field.addEventListener('input', function(e) {
        let value = e.target.value;
        
        if (type === 'cpf-cnpj') {
            // Remover caracteres n√£o num√©ricos
            const numbers = value.replace(/\D/g, '');
            
            // Limitar tamanho
            if (numbers.length > 14) {
                value = value.slice(0, -1);
                return;
            }
            
            // Formata√ß√£o autom√°tica
            let formatted = '';
            if (numbers.length <= 11) {
                // CPF: 000.000.000-00
                formatted = numbers.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else {
                // CNPJ: 00.000.000/0000-00
                formatted = numbers.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            }
            
            e.target.value = formatted;
            
            // Feedback visual
            if (numbers.length === 11 || numbers.length === 14) {
                e.target.style.borderColor = '#28a745'; // Verde
                e.target.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
            } else if (numbers.length > 0) {
                e.target.style.borderColor = '#ffc107'; // Amarelo
                e.target.style.boxShadow = '0 0 0 0.2rem rgba(255, 193, 7, 0.25)';
            } else {
                e.target.style.borderColor = '#ced4da'; // Padr√£o
                e.target.style.boxShadow = 'none';
            }
        }
        
        else if (type === 'phone') {
            const numbers = value.replace(/\D/g, '');
            
            if (numbers.length > 11) {
                value = value.slice(0, -1);
                return;
            }
            
            if (numbers.length <= 10) {
                // Fixo: (00) 0000-0000
                e.target.value = numbers.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else {
                // Celular: (00) 00000-0000
                e.target.value = numbers.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
        }
    });
    
    // Configurar placeholder
    if (type === 'cpf-cnpj') {
        field.placeholder = 'CPF: 000.000.000-00 ou CNPJ: 00.000.000/0000-00';
    } else if (type === 'phone') {
        field.placeholder = '(00) 00000-0000';
    }
    
    console.log(`‚úÖ Formata√ß√£o configurada para ${fieldId} (${type})`);
}

/**
 * Corrigir CPFs existentes (usando fun√ß√£o correta do backend)
 */
async function corrigirCpfsExistentes() {
    if (!confirm('üîß Deseja formatar todos os CPFs/CNPJs existentes na planilha?\n\nIsso vai aplicar formata√ß√£o em todos os documentos n√£o formatados.')) {
        return;
    }
    
    try {
        showLoading();
        console.log('üîß Iniciando corre√ß√£o de CPFs...');
        
        // Usar o nome correto da fun√ß√£o do backend
        const result = await callGoogleScript('fixExistingCpfs');
        
        hideLoading();
        
        if (result && result.success) {
            const message = `‚úÖ Corre√ß√£o conclu√≠da com sucesso!\n\nüìä ${result.corrected} CPFs/CNPJs formatados`;
            showAlert(message, 'success');
            
            console.log('‚úÖ Corre√ß√£o realizada:', result);
            
            // Recarregar dados se estivermos no painel admin
            if (appState && appState.userType === 'admin') {
                console.log('üîÑ Recarregando dados do admin...');
                await loadAdminData();
            }
        } else {
            const errorMsg = result?.error || 'Erro desconhecido na corre√ß√£o';
            showAlert('‚ùå Erro na corre√ß√£o: ' + errorMsg, 'error');
            console.error('‚ùå Erro na corre√ß√£o:', result);
        }
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro de conex√£o:', error);
        
        let errorMessage = 'Erro de conex√£o. ';
        if (error.message && error.message.includes('not a function')) {
            errorMessage += 'Verifique se as fun√ß√µes foram adicionadas corretamente no Google Apps Script.';
        } else {
            errorMessage += 'Tente novamente em alguns instantes.';
        }
        
        showAlert(errorMessage, 'error');
    }
}

/**
 * Testar sistema de formata√ß√£o
 */
async function testarSistemaFormatacao() {
    try {
        showLoading();
        console.log('üß™ Testando sistema de formata√ß√£o...');
        
        const result = await callGoogleScript('testFormattingSystem');
        
        hideLoading();
        
        if (result && result.success) {
            const message = `üß™ Teste conclu√≠do com sucesso!\n\n` +
                          `üì± CPF formatado: ${result.cpfFormatted}\n` +
                          `üè¢ CNPJ formatado: ${result.cnpjFormatted}\n` +
                          `üë• Clientes: ${result.clientsCount}`;
            
            showAlert(message, 'success');
            console.log('‚úÖ Teste realizado:', result);
        } else {
            showAlert('‚ùå Erro no teste: ' + (result?.error || 'Erro desconhecido'), 'error');
            console.error('‚ùå Erro no teste:', result);
        }
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro no teste:', error);
        showAlert('Erro de conex√£o no teste', 'error');
    }
}

/**
 * Executar diagn√≥stico completo
 */
async function executarDiagnostico() {
    try {
        showLoading();
        console.log('üè• Executando diagn√≥stico completo...');
        
        const result = await callGoogleScript('diagnosticoCompletoFormatacao');
        
        hideLoading();
        
        if (result && result.success) {
            const message = `üè• Diagn√≥stico conclu√≠do!\n\n` +
                          `üì± CPF: ${result.formatacao.cpf}\n` +
                          `üè¢ CNPJ: ${result.formatacao.cnpj}\n` +
                          `üë• Clientes: ${result.clientes}\n\n` +
                          `Verifique o console do Google Apps Script para detalhes completos.`;
            
            showAlert(message, 'success');
            console.log('‚úÖ Diagn√≥stico realizado:', result);
        } else {
            showAlert('‚ùå Erro no diagn√≥stico: ' + (result?.error || 'Erro desconhecido'), 'error');
            console.error('‚ùå Erro no diagn√≥stico:', result);
        }
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro no diagn√≥stico:', error);
        showAlert('Erro de conex√£o no diagn√≥stico', 'error');
    }
}

/**
 * Fun√ß√£o atualizada para criar cliente com valida√ß√£o
 */
async function createClientWithFormatting(event) {
    event.preventDefault();
    
    const name = document.getElementById('newClientName').value.trim();
    const cpf = document.getElementById('newClientCpf').value.trim();
    const email = document.getElementById('newClientEmail').value.trim();
    const phone = document.getElementById('newClientPhone').value.trim();
    const password = document.getElementById('newClientPassword').value.trim();
    
    console.log('üìù Criando cliente:', { name, cpf: cpf.replace(/\d/g, '*'), email });
    
    // Valida√ß√µes b√°sicas
    if (!name || !cpf || !password) {
        showAlert('‚ùå Nome, CPF/CNPJ e senha s√£o obrigat√≥rios', 'error');
        return;
    }
    
    // Verificar se CPF/CNPJ tem tamanho v√°lido
    const numbers = cpf.replace(/\D/g, '');
    if (numbers.length !== 11 && numbers.length !== 14) {
        showAlert('‚ùå CPF deve ter 11 d√≠gitos ou CNPJ deve ter 14 d√≠gitos', 'error');
        return;
    }
    
    const clientData = {
        name: name,
        cpf: cpf, // O backend vai formatar automaticamente
        email: email,
        phone: phone,
        password: password
    };
    
    try {
        showLoading();
        
        const result = await callGoogleScript('createClient', clientData);
        
        hideLoading();
        
        if (result && result.success) {
            const successMsg = `‚úÖ Cliente cadastrado com sucesso!\n\nüë§ ${name}\nüìÑ ${result.formattedCpf || cpf}`;
            showAlert(successMsg, 'success');
            
            // Limpar formul√°rio
            document.getElementById('newClientForm').reset();
            
            // Limpar estilos de valida√ß√£o
            document.querySelectorAll('#newClientForm input').forEach(input => {
                input.style.borderColor = '#ced4da';
                input.style.boxShadow = 'none';
            });
            
            console.log('‚úÖ Cliente criado:', result);
            
            // Recarregar dados se estivermos no admin
            if (appState && appState.userType === 'admin') {
                await loadAdminData();
            }
        } else {
            const errorMsg = result?.error || 'Erro desconhecido ao cadastrar cliente';
            showAlert('‚ùå ' + errorMsg, 'error');
            console.error('‚ùå Erro ao criar cliente:', result);
        }
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro de conex√£o:', error);
        showAlert('‚ùå Erro de conex√£o. Tente novamente.', 'error');
    }
}

/**
 * Inicializar formata√ß√£o autom√°tica
 */
function initializeAutoFormatting() {
    console.log('üöÄ Inicializando formata√ß√£o autom√°tica...');
    
    // Configurar campos de CPF/CNPJ
    setupAutoFormatting('newClientCpf', 'cpf-cnpj');
    setupAutoFormatting('editClientCpf', 'cpf-cnpj');
    
    // Configurar campos de telefone
    setupAutoFormatting('newClientPhone', 'phone');
    setupAutoFormatting('editClientPhone', 'phone');
    
    // Configurar field de login tamb√©m
    setupAutoFormatting('clientIdentifier', 'cpf-cnpj');
    
    console.log('‚úÖ Formata√ß√£o autom√°tica configurada');
}

/**
 * Configurar event listeners
 */
function setupEventListeners() {
    // Substituir event listener do form de criar cliente
    const newClientForm = document.getElementById('newClientForm');
    if (newClientForm) {
        // Remover listeners anteriores clonando o elemento
        const newForm = newClientForm.cloneNode(true);
        newClientForm.parentNode.replaceChild(newForm, newClientForm);
        
        // Adicionar novo listener
        newForm.addEventListener('submit', createClientWithFormatting);
        console.log('‚úÖ Event listener configurado para formul√°rio de cliente');
    }
}

// ========================================
// INICIALIZA√á√ÉO QUANDO DOM CARREGAR
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã DOM carregado - configurando formata√ß√£o...');
    
    // Configurar formata√ß√£o autom√°tica
    initializeAutoFormatting();
    
    // Configurar event listeners
    setupEventListeners();
    
    console.log('üéØ Sistema de formata√ß√£o inicializado com sucesso!');
    
});

        // ========================================
        // FUN√á√ïES DE PAGAMENTO - FRONTEND
       // ========================================

       /**
 * Abre URL de pagamento para uma parcela espec√≠fica
 * @param {string} creditId - ID do credi√°rio
 * @param {number} installmentNumber - N√∫mero da parcela
 * @param {string} installmentId - ID da parcela
 */
 /**
         * Abrir URL de pagamento em nova aba
         */
        function openPaymentUrl(paymentUrl) {
            try {
                if (!paymentUrl || paymentUrl === 'undefined') {
                    showAlert('‚ùå URL de pagamento inv√°lida', 'error');
                    return;
                }
                
                // Validar se √© uma URL v√°lida
                try {
                    new URL(paymentUrl);
                } catch (e) {
                    showAlert('‚ùå URL de pagamento mal formatada', 'error');
                    return;
                }
                
                // Abrir em nova aba
                window.open(paymentUrl, '_blank');
                
                // Feedback para o usu√°rio
                showAlert('üåê P√°gina de pagamento aberta em nova aba', 'success');
                
                // Opcional: fechar modal ap√≥s alguns segundos
                setTimeout(() => {
                    closeModal();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir URL:', error);
                showAlert('‚ùå Erro ao abrir p√°gina de pagamento', 'error');
            }
        }
function testarSistemaPagamento() {
    console.log('üß™ Testando sistema de pagamentos...');
    
    // Use os IDs reais dos seus credi√°rios
    const testCases = [
        { creditId: 'mdb7klq53udltf1g39c', installmentNumber: 1 },
        { creditId: 'mdaz6rsih5ou4jdrbbk', installmentNumber: 1 }
    ];
    
    testCases.forEach((test, index) => {
        setTimeout(() => {
            console.log(`üéØ Teste ${index + 1}:`, test);
            
            google.script.run
                .withSuccessHandler(function(url) {
                    console.log(`‚úÖ Teste ${index + 1} - URL:`, url);
                })
                .withFailureHandler(function(error) {
                    console.log(`‚ùå Teste ${index + 1} - Erro:`, error);
                })
                .getPaymentUrlByProduct(test.creditId, test.installmentNumber);
        }, index * 1000);
    });
    
    return 'Testes iniciados - verifique o console';
}


/**
 * Mostra modal de confirma√ß√£o de pagamento
 */
function showPaymentModal(creditId, installmentNumber, installmentId, paymentUrl) {
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    modalTitle.textContent = `üí≥ Pagamento - Parcela ${installmentNumber}`;

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <h3 style="color: #2ecc71; margin-bottom: 1rem;">üîó Link de Pagamento Gerado</h3>
                <p style="color: #666; margin-bottom: 1rem;">
                    Clique no bot√£o abaixo para ser redirecionado para a p√°gina de pagamento segura.
                </p>
                <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px dashed #2ecc71; margin: 1rem 0; word-break: break-all; font-size: 0.9rem;">
                    ${paymentUrl}
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="action-btn btn-success" onclick="proceedToPayment('${paymentUrl}', '${installmentId}')" style="flex: 1; min-width: 200px;">
                    üåê Ir para Pagamento
                </button>
                <button class="action-btn btn-primary" onclick="copyPaymentUrl('${paymentUrl}')" style="flex: 1; min-width: 200px;">
                    üìã Copiar Link
                </button>
            </div>
            
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #ecf0f1;">
                <button class="action-btn btn-warning" onclick="markAsPaidManually('${installmentId}')" style="width: 100%;">
                    ‚úÖ Marcar como Pago Manualmente
                </button>
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                    Use apenas se o pagamento foi feito por outros meios
                </small>
            </div>
        </div>
    `;

    modal.classList.add('active');
}

/**
 * Procede para o pagamento abrindo a URL
 */
function proceedToPayment(paymentUrl, installmentId) {
    try {
        // Abrir URL de pagamento em nova aba
        window.open(paymentUrl, '_blank');
        
        // Mostrar instru√ß√µes
        showAlert('üåê P√°gina de pagamento aberta em nova aba. Ap√≥s concluir o pagamento, retorne aqui para confirmar.', 'success');
        
        // Fechar modal atual
        closeModal();
        
        // Mostrar modal de confirma√ß√£o p√≥s-pagamento
        setTimeout(() => {
            showPostPaymentModal(installmentId);
        }, 2000);
        
    } catch (error) {
        console.error('Erro ao abrir pagamento:', error);
        showAlert('Erro ao abrir p√°gina de pagamento', 'error');
    }
}

/**
 * Copia URL de pagamento para √°rea de transfer√™ncia
 */
function copyPaymentUrl(paymentUrl) {
    try {
        navigator.clipboard.writeText(paymentUrl).then(() => {
            showAlert('üìã Link de pagamento copiado!', 'success');
        }).catch(() => {
            // Fallback para navegadores mais antigos
            const textArea = document.createElement('textarea');
            textArea.value = paymentUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showAlert('üìã Link de pagamento copiado!', 'success');
        });
    } catch (error) {
        console.error('Erro ao copiar:', error);
        showAlert('Erro ao copiar link', 'error');
    }
}

/**
 * Mostra modal de confirma√ß√£o p√≥s-pagamento
 */
function showPostPaymentModal(installmentId) {
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    modalTitle.textContent = '‚úÖ Confirmar Pagamento';

    modalContent.innerHTML = `
        <div style="text-align: center;">
            <div style="background: #fff3cd; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <h3 style="color: #856404; margin-bottom: 1rem;">üí∞ Pagamento Realizado?</h3>
                <p style="color: #666;">
                    Se voc√™ concluiu o pagamento na p√°gina anterior, confirme abaixo para atualizar o status da parcela.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="action-btn btn-success" onclick="confirmPaymentCompleted('${installmentId}')" style="flex: 1;">
                    ‚úÖ Sim, Paguei
                </button>
                <button class="action-btn btn-danger" onclick="closeModal()" style="flex: 1;">
                    ‚ùå Cancelar
                </button>
            </div>
            
            <small style="color: #7f8c8d; display: block; margin-top: 1rem;">
                Confirme apenas se o pagamento foi processado com sucesso
            </small>
        </div>
    `;

    modal.classList.add('active');
}
function testarBuscaUrlPagamento() {
    console.log('üîç Testando busca de URL diretamente...');
    
    // Testar com parcela que tem URL
    console.log('üìã Teste 1: Parcela COM URL');
    getPaymentUrlFromSheet('payment-test-123', 1, 'payment-inst-1');
    
    setTimeout(() => {
        console.log('üìã Teste 2: Parcela SEM URL');
        getPaymentUrlFromSheet('payment-test-123', 2, 'payment-inst-2');
    }, 3000);
    
    return 'Testes de busca iniciados - verifique os modais';
}
function generateCreditDetailsContent(credit) {
    try {
        let content = `
            <div style="margin-bottom: 2rem;">
                <p><strong>Cliente:</strong> ${escapeHtml(credit.clientName || 'N/A')}</p>
                <p><strong>Loja:</strong> ${credit.storeEmoji || 'üè¨'} ${escapeHtml(credit.storeName || 'N/A')}</p>
                <p><strong>Descri√ß√£o:</strong> ${escapeHtml(credit.productDescription || 'N/A')}</p>
                <p><strong>Data da Compra:</strong> ${formatDate(credit.purchaseDate)}</p>
                <p><strong>Valor Total:</strong> ${formatCurrency(credit.totalValue)}</p>
            </div>
            <h4>Parcelas:</h4>
        `;
        
        if (credit.installments && credit.installments.length > 0) {
            credit.installments.forEach(inst => {
                const today = new Date();
                const dueDate = new Date(inst.dueDate);
                const isOverdue = inst.status !== 'Pago' && dueDate < today;
                
                const statusClass = inst.status === 'Pago' ? 'paid' : 
                                  isOverdue ? 'overdue' : 'pending';
                
                const statusText = inst.status === 'Pago' ? '‚úì Pago' : 
                                 isOverdue ? '‚ö†Ô∏è Vencida' : '‚è≥ Pendente';
                
                const statusColor = inst.status === 'Pago' ? '#2ecc71' : 
                                  isOverdue ? '#e74c3c' : '#f39c12';
                
                content += `
                    <div class="installment ${statusClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <strong>Parcela ${inst.number}</strong><br>
                                <small>Vencimento: ${formatDate(inst.dueDate)}</small>
                                ${inst.paymentDate ? `<br><small>Pago em: ${formatDate(inst.paymentDate)}</small>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <strong>${formatCurrency(inst.value)}</strong><br>
                                <span style="color: ${statusColor};">${statusText}</span>
                            </div>
                        </div>
                        ${inst.status !== 'Pago' ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="action-btn btn-primary" onclick="openPaymentUrl('${credit.id}', ${inst.number}, '${inst.id}')" style="flex: 1;">
                                    üí≥ Pagar
                                </button>
                                <button class="action-btn btn-success" onclick="markAsPaidManually('${inst.id}')" style="flex: 1;">
                                    ‚úÖ Marcar Pago
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
        } else {
            content += '<p style="text-align: center; color: #7f8c8d;">Nenhuma parcela encontrada</p>';
        }
        
        return content;
        
    } catch (error) {
        console.error('‚ùå Erro ao gerar conte√∫do:', error);
        return '<div style="text-align: center; padding: 2rem; color: #e74c3c;"><p>‚ùå Erro ao carregar detalhes</p></div>';
    }
}

/**
 * Confirma que o pagamento foi conclu√≠do
 */
async function confirmPaymentCompleted(installmentId) {
    try {
        showLoading();
        
        const result = await callGoogleScript('processOnlinePayment', installmentId, 'URL de pagamento utilizada');
        
        hideLoading();
        
        if (result.success) {
            showSyncStatus('Pagamento confirmado! üéâ', 'success');
            closeModal();
            
            if (result.allPaid) {
                showAlert('üéâ Parab√©ns! Todas as parcelas foram pagas! Credi√°rio quitado.', 'success');
            }
            
            // Recarregar dados
            if (appState.userType === 'client') {
                await loadClientData();
            } else {
                await loadAdminData();
            }
        } else {
            showAlert(result.error || 'Erro ao confirmar pagamento', 'error');
        }
        
    } catch (error) {
        hideLoading();
        console.error('Erro ao confirmar pagamento:', error);
        showAlert('Erro de conex√£o', 'error');
    }
}

/**
 * Marca parcela como paga manualmente
 */
async function markAsPaidManually(installmentId) {
    if (!confirm('Confirmar que esta parcela foi paga por outros meios?')) {
        return;
    }
    
    try {
        showLoading();
                
        const result = await callGoogleScript('markInstallmentAsPaid', {
            installmentId: installmentId,
            paymentMethod: 'Pagamento Manual',
            note: 'Marcado como pago manualmente pelo usu√°rio'
        });
        
        hideLoading();
        
        if (result && result.success) {
            showAlert('‚úÖ Parcela marcada como paga!', 'success');
            closeModal();
            
            if (result.allPaid) {
                setTimeout(() => {
                    showAlert('üéâ Parab√©ns! Todas as parcelas foram pagas! Credi√°rio quitado.', 'success');
                }, 1000);
            }
            
            // Recarregar dados
            if (appState.userType === 'client') {
                await loadClientData();
            } else {
                await loadAdminData();
            }
        } else {
            showAlert(`‚ùå Erro ao marcar como pago: ${result?.error || 'Erro desconhecido'}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Erro ao marcar como pago:', error);
        showAlert('‚ùå Erro de conex√£o', 'error');
    }
}

/**
 * Atualizar fun√ß√£o loadAdminData para incluir solicita√ß√µes
 */
async function loadAdminDataWithApprovals() {
    try {
        console.log('üìä Carregando dados administrativos com aprova√ß√µes...');
        
        // Carregar dados normais do admin (se fun√ß√£o existir)
        if (typeof loadAdminData === 'function') {
            await loadAdminData();
        }
        
        // Carregar solicita√ß√µes de pagamento
        const requests = await loadPendingPaymentRequests();
        
        // Armazenar no estado global
        if (appState) {
            appState.paymentRequests = requests;
        }
        
        console.log('‚úÖ Dados administrativos com aprova√ß√µes carregados');
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados admin com aprova√ß√µes:', error);
    }
}
// ========================================
// INTEGRA√á√ÉO AUTOM√ÅTICA
// ========================================

// Executar quando admin fizer login
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîî Sistema de Aprova√ß√£o de Pagamento inicializando...');
    
    // Verificar periodicamente se √© admin
    const checkAdminInterval = setInterval(() => {
        if (appState && appState.userType === 'admin') {
            console.log('üë®‚Äçüíº Admin detectado - configurando aprova√ß√µes...');
            
            setTimeout(() => {
                loadAdminDataWithApprovals();
            }, 2000);
            
            // Auto-refresh a cada 30 segundos
            setInterval(async () => {
                if (appState && appState.userType === 'admin') {
                    console.log('üîÑ Auto-refresh das solicita√ß√µes...');
                    await loadPendingPaymentRequests();
                }
            }, 30000);
            
            clearInterval(checkAdminInterval);
        }
    }, 1000);
});

// ========================================
// DISPONIBILIZAR FUN√á√ïES GLOBALMENTE
// ========================================

window.createPaymentRequestsContainer = createPaymentRequestsContainer;
window.loadPendingPaymentRequests = loadPendingPaymentRequests;
window.updatePaymentRequestsInterface = updatePaymentRequestsInterface;
window.approvePaymentRequest = approvePaymentRequest;
window.rejectPaymentRequest = rejectPaymentRequest;
window.loadAdminDataWithApprovals = loadAdminDataWithApprovals;
window.refreshPaymentRequests = refreshPaymentRequests;

console.log('‚úÖ Sistema de Aprova√ß√£o de Pagamentos carregado!');
// Categorizar solicita√ß√µes
function categorizeRequests(requests) {
    const pending = requests.filter(r => r.status === 'pendente' || !r.status);
    const approved = requests.filter(r => r.status === 'aprovado');
    const rejected = requests.filter(r => r.status === 'rejeitado');
    
    // Ordenar pendentes por urg√™ncia
    pending.sort((a, b) => {
        const urgencyA = calculateUrgency(a.dueDate);
        const urgencyB = calculateUrgency(b.dueDate);
        
        if (urgencyA.isUrgent && !urgencyB.isUrgent) return -1;
        if (!urgencyA.isUrgent && urgencyB.isUrgent) return 1;
        
        return new Date(a.dueDate) - new Date(b.dueDate);
    });
    
    return { pending, approved, rejected };
}
// Renderizar se√ß√µes de solicita√ß√µes
function renderRequestSections(container, categorized) {
    // Se√ß√£o de pendentes
    if (categorized.pending.length > 0) {
        const pendingSection = createSectionHeader('pendente', categorized.pending.length);
        container.appendChild(pendingSection);
        
        categorized.pending.forEach(request => {
            const card = createPaymentRequestCard(request);
            container.appendChild(card);
        });
    }
    
    // Se√ß√£o de hist√≥rico (se houver)
    if (categorized.approved.length > 0 || categorized.rejected.length > 0) {
        const historicalSection = createHistoricalSection(categorized.approved, categorized.rejected);
        container.appendChild(historicalSection);
    }
}
// Criar header de se√ß√£o
function createSectionHeader(type, count) {
    const section = document.createElement('div');
    const configs = {
        'pendente': { icon: '‚è≥', color: '#ffc107', text: 'Pendentes' }
    };
    
    const config = configs[type];
    
    section.innerHTML = `
        <h4 style="
            color: ${config.color};
            margin: 0 0 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-left: 4px solid ${config.color};
        ">
            ${config.icon} ${config.text} (${count})
        </h4>
    `;
    
    return section;
}

// Criar se√ß√£o hist√≥rica
function createHistoricalSection(approved, rejected) {
    const section = document.createElement('div');
    section.style.marginTop = '2rem';
    
    const totalProcessed = approved.length + rejected.length;
    
    section.innerHTML = `
        <details style="margin-top: 1.5rem;">
            <summary style="
                cursor: pointer;
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 8px;
                font-weight: bold;
                color: #495057;
                border: 1px solid #dee2e6;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='#e9ecef'" 
               onmouseout="this.style.background='#f8f9fa'">
                üìã Hist√≥rico Processado (${totalProcessed}) 
                - ${approved.length} aprovadas, ${rejected.length} rejeitadas
            </summary>
            <div id="historicalRequests" style="margin-top: 1rem;"></div>
        </details>
    `;
    
    const historicalContainer = section.querySelector('#historicalRequests');
    
    [...approved, ...rejected].forEach(request => {
        const card = createPaymentRequestCard(request);
        card.style.opacity = '0.8';
        card.style.transform = 'scale(0.98)';
        historicalContainer.appendChild(card);
    });
    
    return section;
}
// ========================================
// ADICIONE ESTA FUN√á√ÉO AO SEU C√ìDIGO EXISTENTE
// (N√£o altere nada do seu c√≥digo, apenas adicione esta fun√ß√£o)
// ========================================

/**
 * Fun√ß√£o createPaymentRequestCard que estava faltando
 * Compat√≠vel 100% com seu c√≥digo existente
 */
function createPaymentRequestCard(request) {
    try {
        // Valida√ß√£o b√°sica
        if (!request || !request.id) {
            console.error('‚ùå Dados da solicita√ß√£o inv√°lidos:', request);
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: #f8d7da;
                color: #721c24;
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                text-align: center;
                border: 1px solid #f5c6cb;
            `;
            errorDiv.innerHTML = '‚ùå Dados inv√°lidos da solicita√ß√£o';
            return errorDiv;
        }

        // Extrair dados com valores padr√£o seguros
        const clientName = request.clientName || 'Cliente Desconhecido';
        const clientEmail = request.clientEmail || 'Email n√£o informado';
        const productName = request.productName || 'Produto';
        const storeName = request.storeName || 'Loja';
        const installmentNumber = request.installmentNumber || '?';
        const installmentValue = request.installmentValue || 0;
        const dueDate = request.dueDate || '';
        const requestDate = request.requestDate || '';
        const note = request.note || '';
        const status = request.status || 'pendente';

        // Configura√ß√£o visual baseada no status
        let statusColor, statusIcon, statusText, statusBg;
        
        switch (status) {
            case 'aprovado':
                statusColor = '#28a745';
                statusIcon = '‚úÖ';
                statusText = 'APROVADO';
                statusBg = '#d4edda';
                break;
            case 'rejeitado':
                statusColor = '#dc3545';
                statusIcon = '‚ùå';
                statusText = 'REJEITADO';
                statusBg = '#f8d7da';
                break;
            default: // pendente
                statusColor = '#ffc107';
                statusIcon = '‚è≥';
                statusText = 'PENDENTE';
                statusBg = '#fff3cd';
        }

        // Verificar se est√° vencida (apenas para pendentes)
        let isOverdue = false;
        if (status === 'pendente' && dueDate) {
            try {
                const today = new Date();
                const dueDateObj = new Date(dueDate);
                isOverdue = dueDateObj < today;
                
                if (isOverdue) {
                    statusColor = '#dc3545';
                    statusIcon = '‚ö†Ô∏è';
                    statusText = 'VENCIDA';
                    statusBg = '#f8d7da';
                }
            } catch (e) {
                // Ignorar erro de data
            }
        }

        // Fun√ß√£o auxiliar para formatar moeda (compat√≠vel com seu c√≥digo)
        function formatCurrency(value) {
            try {
                if (typeof formatCurrency !== 'undefined' && formatCurrency !== arguments.callee) {
                    return formatCurrency(value);
                }
                // Fallback se sua fun√ß√£o n√£o estiver dispon√≠vel
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value || 0);
            } catch (e) {
                return `R$ ${(value || 0).toFixed(2).replace('.', ',')}`;
            }
        }

        // Fun√ß√£o auxiliar para formatar data (compat√≠vel com seu c√≥digo)
        function formatDate(dateStr) {
            try {
                if (typeof formatDate !== 'undefined' && formatDate !== arguments.callee) {
                    return formatDate(dateStr);
                }
                // Fallback se sua fun√ß√£o n√£o estiver dispon√≠vel
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR');
            } catch (e) {
                return dateStr || 'N/A';
            }
        }

        // Criar elemento do card
        const cardElement = document.createElement('div');
        cardElement.className = 'payment-request-card';
        cardElement.id = `payment-request-${request.id}`;

        // HTML do card (design compat√≠vel com seu sistema)
        cardElement.innerHTML = `
            <div style="
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                border-left: 5px solid ${statusColor};
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            " onmouseover="this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)'" 
               onmouseout="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">
                
                <!-- Badge de Status -->
                <div style="
                    position: absolute;
                    top: 0;
                    right: 0;
                    background: ${statusColor};
                    color: white;
                    padding: 0.5rem 1rem;
                    border-bottom-left-radius: 12px;
                    font-size: 0.85rem;
                    font-weight: bold;
                    z-index: 2;
                ">
                    ${statusIcon} ${statusText}
                </div>
                
                <!-- Informa√ß√µes do Cliente -->
                <div style="
                    margin-bottom: 1.5rem;
                    padding-right: 120px;
                ">
                    <h4 style="
                        margin: 0 0 0.5rem 0;
                        color: #2c3e50;
                        font-size: 1.2rem;
                        font-weight: 600;
                    ">
                        üë§ ${clientName}
                    </h4>
                    <p style="
                        margin: 0;
                        color: #6c757d;
                        font-size: 0.9rem;
                    ">
                        üìß ${clientEmail}
                    </p>
                </div>
                
                <!-- Informa√ß√µes do Produto -->
                <div style="
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 1.5rem;
                    margin-bottom: 1.5rem;
                    border: 1px solid #e9ecef;
                ">
                    <div style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 1rem;
                        font-size: 0.9rem;
                    ">
                        <div>
                            <div style="
                                font-weight: 600;
                                color: #495057;
                                margin-bottom: 0.3rem;
                            ">üõí Produto</div>
                            <div style="color: #2c3e50;">
                                ${productName}
                            </div>
                        </div>
                        <div>
                            <div style="
                                font-weight: 600;
                                color: #495057;
                                margin-bottom: 0.3rem;
                            ">üè™ Loja</div>
                            <div style="color: #2c3e50;">
                                ${storeName}
                            </div>
                        </div>
                        <div>
                            <div style="
                                font-weight: 600;
                                color: #495057;
                                margin-bottom: 0.3rem;
                            ">üì¶ Parcela</div>
                            <div style="
                                color: #2c3e50;
                                font-weight: bold;
                                font-size: 1rem;
                            ">
                                ${installmentNumber}¬™ parcela
                            </div>
                        </div>
                        <div>
                            <div style="
                                font-weight: 600;
                                color: #495057;
                                margin-bottom: 0.3rem;
                            ">üí∞ Valor</div>
                            <div style="
                                color: #28a745;
                                font-weight: bold;
                                font-size: 1.3rem;
                            ">
                                ${formatCurrency(installmentValue)}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Informa√ß√µes de Data -->
                <div style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 1rem;
                    margin-bottom: 1.5rem;
                    padding: 1rem;
                    background: ${isOverdue ? '#fff5f5' : '#f8f9fa'};
                    border-radius: 8px;
                    border: 1px solid ${isOverdue ? '#fed7d7' : '#e9ecef'};
                ">
                    <div>
                        <div style="
                            font-size: 0.85rem;
                            font-weight: 600;
                            color: #495057;
                            margin-bottom: 0.3rem;
                        ">üìÖ Vencimento</div>
                        <div style="
                            color: ${isOverdue ? '#dc3545' : '#6c757d'};
                            font-weight: ${isOverdue ? 'bold' : 'normal'};
                        ">
                            ${formatDate(dueDate)}
                            ${isOverdue ? '<br><small style="color: #dc3545;">‚ö†Ô∏è Vencida</small>' : ''}
                        </div>
                    </div>
                    <div>
                        <div style="
                            font-size: 0.85rem;
                            font-weight: 600;
                            color: #495057;
                            margin-bottom: 0.3rem;
                        ">üì® Solicita√ß√£o</div>
                        <div style="color: #6c757d;">
                            ${formatDate(requestDate)}
                        </div>
                    </div>
                </div>
                
                <!-- Observa√ß√£o do Cliente (se houver) -->
                ${note && note.trim() ? `
                    <div style="
                        background: #e3f2fd;
                        border-left: 4px solid #2196f3;
                        padding: 1rem;
                        margin-bottom: 1.5rem;
                        border-radius: 0 8px 8px 0;
                    ">
                        <div style="
                            font-size: 0.85rem;
                            font-weight: 600;
                            color: #1565c0;
                            margin-bottom: 0.5rem;
                        ">üí¨ Observa√ß√£o do Cliente</div>
                        <div style="
                            color: #495057;
                            font-style: italic;
                            line-height: 1.4;
                        ">
                            "${note.trim()}"
                        </div>
                    </div>
                ` : ''}
                
                <!-- Bot√µes de A√ß√£o (apenas para solicita√ß√µes pendentes) -->
                ${status === 'pendente' ? `
                    <div style="
                        display: flex;
                        gap: 0.75rem;
                        justify-content: flex-end;
                        margin-top: 2rem;
                        padding-top: 1.5rem;
                        border-top: 2px solid #e9ecef;
                    ">
                        <button onclick="approvePaymentRequest('${request.id}')" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 0.8rem 1.5rem;
                            border-radius: 8px;
                            font-weight: bold;
                            cursor: pointer;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        " onmouseover="this.style.background='#218838'" 
                           onmouseout="this.style.background='#28a745'">
                            ‚úÖ Aprovar Pagamento
                        </button>
                        
                        <button onclick="rejectPaymentRequest('${request.id}')" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 0.8rem 1.5rem;
                            border-radius: 8px;
                            font-weight: bold;
                            cursor: pointer;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        " onmouseover="this.style.background='#c82333'" 
                           onmouseout="this.style.background='#dc3545'">
                            ‚ùå Rejeitar Solicita√ß√£o
                        </button>
                    </div>
                ` : `
                    <!-- Status Final (para solicita√ß√µes processadas) -->
                    <div style="
                        text-align: center;
                        margin-top: 1.5rem;
                        padding: 1rem;
                        background: ${statusBg};
                        border-radius: 8px;
                        border: 2px solid ${statusColor};
                    ">
                        <div style="
                            color: ${statusColor};
                            font-weight: bold;
                            font-size: 1rem;
                        ">
                            ${statusIcon} Solicita√ß√£o ${statusText}
                        </div>
                    </div>
                `}
                
                <!-- ID da Solicita√ß√£o (para refer√™ncia) -->
                <div style="
                    position: absolute;
                    bottom: 8px;
                    right: 12px;
                    font-size: 0.7rem;
                    color: #adb5bd;
                    opacity: 0.6;
                    font-family: monospace;
                ">
                    ID: ${request.id.slice(-8)}
                </div>
            </div>
        `;

        console.log(`‚úÖ Card criado para: ${clientName} - Parcela ${installmentNumber}`);
        return cardElement;

    } catch (error) {
        console.error('‚ùå Erro ao criar card de solicita√ß√£o:', error);
        
        // Retornar card de erro em caso de falha
        const errorCard = document.createElement('div');
        errorCard.style.cssText = `
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            text-align: center;
        `;
        errorCard.innerHTML = `
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
            <div style="font-weight: bold; margin-bottom: 0.5rem;">Erro ao Criar Card</div>
            <div style="font-size: 0.9rem;">Erro: ${error.message}</div>
        `;
        
        return errorCard;
    }
}

// ========================================
// DISPONIBILIZAR A FUN√á√ÉO GLOBALMENTE
// ========================================

// Garantir que a fun√ß√£o esteja dispon√≠vel globalmente
window.createPaymentRequestCard = createPaymentRequestCard;

// ========================================
// LOGS DE CONFIRMA√á√ÉO
// ========================================

console.log('‚úÖ === FUN√á√ÉO createPaymentRequestCard ADICIONADA ===');
console.log('‚úÖ Fun√ß√£o compat√≠vel com seu c√≥digo existente');
console.log('‚úÖ Dispon√≠vel globalmente como window.createPaymentRequestCard');
console.log('‚úÖ Suporte completo a todos os status de solicita√ß√£o');
console.log('‚úÖ Design responsivo e moderno');
console.log('‚úÖ Tratamento robusto de erros');
console.log('');
console.log('üéØ Erro "createPaymentRequestCard is not defined" RESOLVIDO!');
console.log('üîÑ Seu c√≥digo existente continuar√° funcionando normalmente');

// Renderizar estado de erro
function renderErrorState(container, errorMessage) {
    if (!container) return;
    
    container.innerHTML = `
        <div style="
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #dc3545;
            animation: fadeInUp 0.5s ease-out;
        ">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
            <h4 style="margin-bottom: 1rem;">Erro na Interface</h4>
            <p style="margin-bottom: 1.5rem;">
                N√£o foi poss√≠vel carregar as solicita√ß√µes de pagamento.
            </p>
            <div style="font-size: 0.9rem; margin-bottom: 1.5rem; opacity: 0.8;">
                Erro: ${errorMessage}
            </div>
            <button onclick="refreshPaymentRequests()" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                transition: background 0.3s ease;
            " onmouseover="this.style.background='#c82333'" 
               onmouseout="this.style.background='#dc3545'">
                üîÑ Tentar Novamente
            </button>
        </div>
    `;
}

// Fun√ß√£o de refresh das solicita√ß√µes
async function refreshPaymentRequests() {
    try {
        if (typeof showAlert === 'function') {
            showAlert('üîÑ Atualizando solicita√ß√µes...', 'info');
        }
        
        console.log('üîÑ Refresh manual das solicita√ß√µes...');
        
        if (typeof loadPendingPaymentRequests === 'function') {
            await loadPendingPaymentRequests();
            
            if (typeof showAlert === 'function') {
                showAlert('‚úÖ Solicita√ß√µes atualizadas!', 'success');
            }
        } else {
            console.warn('‚ö†Ô∏è Fun√ß√£o loadPendingPaymentRequests n√£o dispon√≠vel');
            
            if (typeof showAlert === 'function') {
                showAlert('‚ö†Ô∏è Fun√ß√£o de carregamento n√£o dispon√≠vel', 'warning');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro no refresh:', error);
        
        if (typeof showAlert === 'function') {
            showAlert('‚ùå Erro ao atualizar: ' + error.message, 'error');
        }
    }
}
// ===== FECHAR TODOS OS MODALS =====
function closeAllModals() {
    console.log('üîí Fechando todos os modais...');
    
    // Fechar todos os elementos com ID comum de modal
    const modalIds = ['detailModal', 'modal', 'creditModal', 'editModal'];
    modalIds.forEach(id => {
        const modal = document.getElementById(id);
        if (modal) {
            modal.remove();
            console.log(`üóëÔ∏è Modal ${id} removido`);
        }
    });
    
    // Fechar qualquer overlay vis√≠vel
    const overlays = document.querySelectorAll('[style*="position: fixed"]');
    overlays.forEach(overlay => {
        if (overlay.style.zIndex > 1000) {
            overlay.style.display = 'none';
        }
    });
}

// ===== CRIAR MODAL COM FOR√áA BRUTA =====
function createForceModal(credit) {
    console.log('üèóÔ∏è Criando modal for√ßado...');
    
    // Remover qualquer modal existente primeiro
    const existing = document.getElementById('detailModal');
    if (existing) existing.remove();
    
    // Criar container do modal
    const modalContainer = document.createElement('div');
    modalContainer.id = 'detailModal';
    modalContainer.innerHTML = `
        <div id="forceOverlay" style="
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.8) !important;
            z-index: 999999 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            visibility: visible !important;
            opacity: 1 !important;
        " onclick="closeForceModal()">
            <div id="forceModalContent" style="
                background: white !important;
                border-radius: 15px !important;
                max-width: 90vw !important;
                max-height: 90vh !important;
                width: 600px !important;
                overflow: hidden !important;
                box-shadow: 0 20px 40px rgba(0,0,0,0.5) !important;
                position: relative !important;
                z-index: 1000000 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            " onclick="event.stopPropagation()">
                
                <!-- Header -->
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                    color: white !important;
                    padding: 1.5rem !important;
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                ">
                    <h3 style="
                        margin: 0 !important;
                        color: white !important;
                        font-size: 1.3rem !important;
                        font-weight: bold !important;
                    ">${credit.productEmoji || 'üõí'} ${credit.productName || 'Produto'}</h3>
                    
                    <button onclick="closeForceModal()" style="
                        background: rgba(255,255,255,0.2) !important;
                        border: none !important;
                        color: white !important;
                        font-size: 1.8rem !important;
                        width: 40px !important;
                        height: 40px !important;
                        border-radius: 50% !important;
                        cursor: pointer !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        font-weight: bold !important;
                    ">&times;</button>
                </div>
                
                <!-- Conte√∫do -->
                <div style="
                    padding: 1.5rem !important;
                    overflow-y: auto !important;
                    max-height: 70vh !important;
                ">
                    ${generateForceContent(credit)}
                </div>
            </div>
        </div>
    `;
    
    // Adicionar ao DOM com for√ßa
    document.body.appendChild(modalContainer);
    
    console.log('‚úÖ Modal criado com for√ßa');
    return modalContainer;
}

function logout() {
    appState.currentUser = null;
    appState.userType = null;
    appState.userData = null;
    appState.credits = [];
    appState.clients = [];
    
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    
    document.getElementById('clientForm').reset();
    document.getElementById('adminForm').reset();
    
    showAlert('Desconectado! üëã', 'success');
}

// ===== GERAR CONTE√öDO FOR√áADO =====
function generateForceContent(credit) {
    let html = `
        <div style="margin-bottom: 1.5rem;">
            <div style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                font-size: 0.95rem;
                background: #f8f9fa;
                padding: 1rem;
                border-radius: 8px;
            ">
                <div><strong>üë§ Cliente:</strong><br>${credit.clientName || 'N/A'}</div>
                <div><strong>üè™ Loja:</strong><br>${credit.storeEmoji || 'üè¨'} ${credit.storeName || 'N/A'}</div>
                <div><strong>üìÖ Data:</strong><br>${formatDateSafe(credit.purchaseDate)}</div>
                <div><strong>üí∞ Valor:</strong><br><span style="font-size: 1.2rem; color: #28a745; font-weight: bold;">${formatCurrencySafe(credit.totalValue)}</span></div>
            </div>
        </div>
        
        <h4 style="margin-bottom: 1rem; color: #2c3e50;">üí≥ Parcelas (${credit.installments?.length || 0})</h4>
    `;
    
    if (!credit.installments || credit.installments.length === 0) {
        html += '<div style="text-align: center; padding: 2rem; color: #6c757d;">Nenhuma parcela encontrada</div>';
    } else {
        credit.installments.forEach(inst => {
            if (!inst) return;
            
            const isPaid = inst.status === 'Pago';
            const today = new Date();
            const dueDate = new Date(inst.dueDate);
            const isOverdue = !isPaid && dueDate < today;
            
            const bgColor = isPaid ? '#d4edda' : isOverdue ? '#f8d7da' : '#fff3cd';
            const borderColor = isPaid ? '#28a745' : isOverdue ? '#dc3545' : '#ffc107';
            const icon = isPaid ? '‚úÖ' : isOverdue ? '‚ö†Ô∏è' : '‚è≥';
            const status = isPaid ? 'Pago' : isOverdue ? 'Vencida' : 'Pendente';
            
            html += `
                <div style="
                    background: ${bgColor};
                    border-left: 4px solid ${borderColor};
                    border-radius: 8px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                        <div>
                            <strong>Parcela ${inst.number || '?'}</strong><br>
                            <small>Vence: ${formatDateSafe(inst.dueDate)}</small>
                            ${inst.paymentDate ? `<br><small>Pago: ${formatDateSafe(inst.paymentDate)}</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold;">${formatCurrencySafe(inst.value)}</div>
                            <div style="color: ${borderColor}; font-weight: bold;">${icon} ${status}</div>
                        </div>
                    </div>
                    
                    ${!isPaid ? `
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="pagarParcelaForce('${inst.id}', '${credit.id}', ${inst.number})" style="
                                flex: 1;
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 0.7rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 0.9rem;
                            ">üí≥ Pagar Online</button>
                            
                            <button onclick="marcarPagoForce('${inst.id}')" style="
                                flex: 1;
                                background: #17a2b8;
                                color: white;
                                border: none;
                                padding: 0.7rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 0.9rem;
                            ">‚úÖ Marcar Pago</button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }
    
    return html;
}

// ===== FOR√áAR EXIBI√á√ÉO DO MODAL =====
function forceShowModal(modal) {
    console.log('üí™ For√ßando exibi√ß√£o do modal...');
    
    // M√∫ltiplas tentativas para garantir exibi√ß√£o
    setTimeout(() => {
        const overlay = modal.querySelector('#forceOverlay');
        if (overlay) {
            overlay.style.display = 'flex';
            overlay.style.visibility = 'visible';
            overlay.style.opacity = '1';
            console.log('‚úÖ Tentativa 1: Modal for√ßado');
        }
    }, 100);
    
    setTimeout(() => {
        const content = modal.querySelector('#forceModalContent');
        if (content) {
            content.style.display = 'block';
            content.style.visibility = 'visible';
            content.style.opacity = '1';
            console.log('‚úÖ Tentativa 2: Conte√∫do for√ßado');
        }
    }, 200);
    
    // Verifica√ß√£o final
    setTimeout(() => {
        const isVisible = modal.offsetWidth > 0 && modal.offsetHeight > 0;
        console.log(`üîç Modal vis√≠vel: ${isVisible ? 'SIM' : 'N√ÉO'}`);
        
        if (!isVisible) {
            console.log('‚ö†Ô∏è Modal n√£o vis√≠vel, tentando corre√ß√£o final...');
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 999999 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
        }
    }, 300);
}

// ===== FECHAR MODAL FOR√áADO =====
function closeForceModal() {
    console.log('üîí Fechando modal for√ßado...');
    
    const modal = document.getElementById('detailModal');
    if (modal) {
        modal.remove();
        console.log('‚úÖ Modal removido');
    }
}

// ===== FUN√á√ïES DE A√á√ÉO FOR√áADAS =====
function pagarParcelaForce(installmentId, creditId, installmentNumber) {
    console.log('üí≥ Pagamento:', { installmentId, creditId, installmentNumber });
    
    try {
        if (typeof openPaymentUrl === 'function') {
            openPaymentUrl(creditId, installmentNumber, installmentId);
        } else {
            alert('üîó Funcionalidade de pagamento em desenvolvimento');
        }
    } catch (error) {
        alert('‚ùå Erro no pagamento: ' + error.message);
    }
}

function marcarPagoForce(installmentId) {
    console.log('‚úÖ Marcar como pago:', installmentId);
    
    try {
        if (typeof markAsPaidManually === 'function') {
            markAsPaidManually(installmentId);
        } else {
            if (confirm('Marcar esta parcela como paga?')) {
                alert('‚úÖ Parcela marcada como paga!\n(Funcionalidade simulada)');
                closeForceModal();
            }
        }
    } catch (error) {
        alert('‚ùå Erro: ' + error.message);
    }
}

// ===== FUN√á√ïES AUXILIARES SEGURAS =====
function formatCurrencySafe(amount) {
    try {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(amount || 0);
    } catch (e) {
        return `R$ ${amount || 0}`;
    }
}

function formatDateSafe(dateStr) {
    try {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString('pt-BR');
    } catch (e) {
        return dateStr || 'N/A';
    }
}

// ===== FUN√á√ÉO DE TESTE VISUAL =====
function testForceModal() {
    console.log('üß™ Testando modal for√ßado...');
    
    // Criar dados de teste
    if (!window.appState) window.appState = { credits: [] };
    if (!appState.credits) appState.credits = [];
    
    const testCredit = {
        id: 'force-test-123',
        clientName: 'Jo√£o For√ßa Teste',
        productName: 'Produto Teste Force',
        productEmoji: 'üß™',
        storeName: 'Loja Teste',
        storeEmoji: 'üè™',
        totalValue: 300.00,
        purchaseDate: '2025-01-15',
        installments: [
            {
                id: 'inst-force-1',
                number: 1,
                value: 150.00,
                dueDate: '2025-02-15',
                status: 'Pago',
                paymentDate: '2025-02-10'
            },
            {
                id: 'inst-force-2',
                number: 2,
                value: 150.00,
                dueDate: '2025-03-15',
                status: 'Pendente'
            }
        ]
    };
    
    // Remover teste anterior
    appState.credits = appState.credits.filter(c => c.id !== 'force-test-123');
    appState.credits.push(testCredit);
    
    // Testar modal
    viewCreditDetailsWithApproval('force-test-123');
    
    console.log('‚úÖ Teste de modal for√ßado iniciado');
}

// ===== DIAGN√ìSTICO VISUAL =====
function debugModalVisibility() {
    console.log('üîç === DIAGN√ìSTICO DE VISIBILIDADE ===');
    
    const modal = document.getElementById('detailModal');
    if (!modal) {
        console.log('‚ùå Modal n√£o existe');
        return;
    }
    
    console.log('‚úÖ Modal existe');
    console.log('üìè Dimens√µes:', {
        width: modal.offsetWidth,
        height: modal.offsetHeight,
        visible: modal.offsetWidth > 0 && modal.offsetHeight > 0
    });
    
    console.log('üé® Estilos computados:');
    const styles = window.getComputedStyle(modal);
    console.log({
        display: styles.display,
        visibility: styles.visibility,
        opacity: styles.opacity,
        zIndex: styles.zIndex,
        position: styles.position
    });
    
    // For√ßar corre√ß√£o se necess√°rio
    if (modal.offsetWidth === 0) {
        console.log('üîß For√ßando corre√ß√£o...');
        forceShowModal(modal);
    }
}

// ===== NOTIFICA√á√ÉO DE CARREGAMENTO =====
const forceNotification = document.createElement('div');
forceNotification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #007bff;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    z-index: 99999;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
`;
forceNotification.textContent = 'üí™ Modal FOR√áADO carregado!';
document.body.appendChild(forceNotification);

setTimeout(() => {
    if (forceNotification.parentNode) {
        forceNotification.remove();
    }
}, 3000);

console.log('üí™ === MODAL FOR√áADO CARREGADO ===');
console.log('üß™ Execute: testForceModal() para testar');
console.log('üîç Execute: debugModalVisibility() para diagn√≥stico');
console.log('üí• Agora o modal VAI aparecer com for√ßa bruta!');

// ========================================
// FUN√á√ÉO PARA GARANTIR QUE MODAL EXISTE
// ========================================

function ensureModalExists() {
    let modal = document.getElementById('detailModal');
    
    if (!modal) {
        console.log('üîß Criando modal detailModal...');
        
        modal = document.createElement('div');
        modal.id = 'detailModal';
        modal.className = 'modal';
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Detalhes</h3>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div id="modalContent">Carregando...</div>
            </div>
        `;
        
        // Adicionar estilos b√°sicos se necess√°rio
        if (!document.getElementById('modal-styles')) {
            const style = document.createElement('style');
            style.id = 'modal-styles';
            style.textContent = `
                .modal {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    align-items: center;
                    justify-content: center;
                }
                .modal.active {
                    display: flex;
                }
                .modal-content {
                    background: white;
                    border-radius: 20px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                }
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 1.5rem;
                    padding-bottom: 1rem;
                    border-bottom: 1px solid #ecf0f1;
                }
                .close-btn {
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #7f8c8d;
                    padding: 0.5rem;
                    border-radius: 50%;
                    transition: background 0.3s ease;
                }
                .close-btn:hover {
                    background: #f8f9fa;
                }
                .installment {
                    background: #f8f9fa;
                    border-radius: 10px;
                    padding: 1rem;
                    margin: 1rem 0;
                    transition: all 0.3s ease;
                }
                .installment.paid {
                    background: #d4edda;
                    border-left: 4px solid #2ecc71;
                }
                .installment.overdue {
                    background: #f8d7da;
                    border-left: 4px solid #e74c3c;
                }
                .installment.pending {
                    background: #fff3cd;
                    border-left: 4px solid #f39c12;
                }
                .action-btn {
                    border: none;
                    padding: 0.8rem 1rem;
                    border-radius: 8px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-decoration: none;
                    display: inline-block;
                    text-align: center;
                }
                .btn-primary {
                    background: #3498db;
                    color: white;
                }
                .btn-primary:hover {
                    background: #2980b9;
                }
                .btn-success {
                    background: #2ecc71;
                    color: white;
                }
                .btn-success:hover {
                    background: #27ae60;
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(modal);
        console.log('‚úÖ Modal criado com sucesso');
    }
    
    return modal;
}

function closeModal() {
    try {
        const modal = document.getElementById('detailModal');
        if (modal) {
            modal.classList.remove('active');
            console.log('‚úÖ Modal fechado');
        }
    } catch (error) {
        console.error('‚ùå Erro ao fechar modal:', error);
    }
}

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    
    const userName = document.getElementById('userName');
    const modeToggle = document.getElementById('modeToggle');
    
    if (appState.userType === 'admin') {
        userName.textContent = 'Administrador';
        modeToggle.style.display = 'block';
        showDashboard('admin');
    } else {
        userName.textContent = appState.currentUser;
        modeToggle.style.display = 'none';
        showDashboard('client');
    }
}

function showDashboard(type) {
    document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
    document.getElementById(type + 'Dashboard').classList.add('active');
}

function toggleMode() {
    if (appState.userType === 'admin') {
        const currentDashboard = document.querySelector('.dashboard.active').id;
        if (currentDashboard === 'adminDashboard') {
            showDashboard('client');
        } else {
            showDashboard('admin');
        }
    }
}/**
 * FUN√á√ÉO: testRequestSystem - Teste do sistema de solicita√ß√µes
 */
function testRequestSystem() {
  console.log('üß™ [BACKEND] === TESTE DO SISTEMA DE SOLICITA√á√ïES ===');
  
  try {
    // 1. Criar solicita√ß√£o de teste
    console.log('1Ô∏è‚É£ Criando solicita√ß√£o de teste...');
    const createResult = requestPaymentConfirmation({
      clientName: 'Cliente Teste',
      clientEmail: 'teste@email.com',
      productName: 'Produto Teste',
      storeName: 'Loja Teste',
      installmentNumber: 1,
      installmentValue: 100.00,
      dueDate: new Date(),
      creditId: 'test_credit_123',
      installmentId: 'test_installment_456',
      note: 'Teste do sistema'
    });
    
    console.log('Cria√ß√£o:', createResult.success ? '‚úÖ' : '‚ùå', createResult.message || createResult.error);
    
    if (!createResult.success) {
      return { success: false, error: 'Falha na cria√ß√£o da solicita√ß√£o' };
    }
    
    const requestId = createResult.requestId;
    
    // 2. Verificar status
    console.log('2Ô∏è‚É£ Verificando status...');
    const statusResult = checkRequestStatus({ requestId });
    console.log('Status:', statusResult.success ? '‚úÖ' : '‚ùå', statusResult.status || statusResult.error);
    
    // 3. Listar pendentes
    console.log('3Ô∏è‚É£ Listando pendentes...');
    const pendingResult = getPendingPaymentRequests();
    console.log('Pendentes:', pendingResult.success ? '‚úÖ' : '‚ùå', `${pendingResult.total || 0} encontradas`);
    
    // 4. Gerar relat√≥rio
    console.log('4Ô∏è‚É£ Gerando relat√≥rio...');
    const reportResult = generateRequestsReport();
    console.log('Relat√≥rio:', reportResult.success ? '‚úÖ' : '‚ùå', reportResult.message || reportResult.error);
    
    // 5. Aprovar solicita√ß√£o de teste
    console.log('5Ô∏è‚É£ Aprovando solicita√ß√£o de teste...');
    const approveResult = approvePaymentRequest({
      requestId: requestId,
      adminNote: 'Teste de aprova√ß√£o autom√°tica'
    });
    console.log('Aprova√ß√£o:', approveResult.success ? '‚úÖ' : '‚ùå', approveResult.message || approveResult.error);
    
    console.log('üéâ [BACKEND] Teste do sistema conclu√≠do!');
    
    return {
      success: true,
      message: 'Sistema de solicita√ß√µes testado com sucesso',
      testRequestId: requestId,
      results: {
        create: createResult.success,
        status: statusResult.success,
        pending: pendingResult.success,
        report: reportResult.success,
        approve: approveResult.success
      }
    };
    
  } catch (error) {
    console.error('‚ùå [BACKEND] Erro no teste:', error);
    return { success: false, error: error.message };
  }
}

// ===== LOGS DE INICIALIZA√á√ÉO =====

console.log('üîß === FUN√á√ïES DE BACKEND PARA INTEGRA√á√ÉO CARREGADAS ===');
console.log('‚úÖ Fun√ß√µes implementadas:');
console.log('  - requestPaymentConfirmation(): Criar solicita√ß√£o');
console.log('  - checkRequestStatus(): Verificar status');
console.log('  - getPendingPaymentRequests(): Listar pendentes');
console.log('  - approvePaymentRequest(): Aprovar solicita√ß√£o');
console.log('  - rejectPaymentRequest(): Rejeitar solicita√ß√£o');
console.log('  - getAllPaymentRequests(): Buscar todas');
console.log('  - generateRequestsReport(): Gerar relat√≥rio');
console.log('  - testRequestSystem(): Testar sistema');
console.log('');
console.log('üß™ Para testar: testRequestSystem()');
console.log('üìä Para relat√≥rio: generateRequestsReport()');
console.log('üìã Para listar pendentes: getPendingPaymentRequests()');
console.log('');
console.log('üéØ Sistema de solicita√ß√µes 100% funcional!');

// ========================================
// FUN√á√ïES DE TESTE PARA O NOVO SISTEMA
// ========================================

function testPaymentSystem() {
    console.log('üß™ Testando sistema de pagamentos da planilha...');
    
    // Simular busca de link
    getPaymentUrlFromSheet('credit1', 1, 'inst1');
    
    console.log('‚úÖ Teste iniciado - verifique o modal');
}

function testNoPaymentUrl() {
    console.log('üß™ Testando cen√°rio sem link de pagamento...');
    
    // Simular parcela sem link
    showNoPaymentUrlModal('credit1', 2, 'inst2');
    
    console.log('‚úÖ Modal de "sem link" exibido');
}

// ========================================
// SISTEMA COMPLETO DE GEST√ÉO DE CLIENTES
// ========================================

// ===== CRIAR MODAL UNIVERSAL =====
function createUniversalModal() {
    // Remover modal existente se houver
    const existing = document.getElementById('detailModal');
    if (existing) existing.remove();
    
    const modal = document.createElement('div');
    modal.id = 'detailModal';
    modal.innerHTML = `
        <div style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        " id="modalOverlay" onclick="closeUniversalModal()">
            <div style="
                background: white;
                border-radius: 15px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow: hidden;
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
                animation: modalSlideIn 0.3s ease-out;
            " onclick="event.stopPropagation()">
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <h3 id="modalTitle" style="margin: 0; font-size: 1.2rem;">Modal</h3>
                    <button onclick="closeUniversalModal()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 1.5rem;
                        width: 35px;
                        height: 35px;
                        border-radius: 50%;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: background 0.3s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
                </div>
                <div id="modalContent" style="
                    padding: 1.5rem;
                    overflow-y: auto;
                    max-height: calc(80vh - 120px);
                ">Carregando...</div>
            </div>
        </div>
    `;
    
    // Adicionar CSS para anima√ß√£o
    if (!document.getElementById('modal-animations')) {
        const style = document.createElement('style');
        style.id = 'modal-animations';
        style.textContent = `
            @keyframes modalSlideIn {
                from { transform: scale(0.7); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(modal);
    return modal;
}

// ===== ABRIR MODAL =====
function openUniversalModal() {
    const modal = createUniversalModal();
    const overlay = modal.querySelector('#modalOverlay');
    overlay.style.display = 'flex';
    return modal;
}

// ===== FECHAR MODAL =====
function closeUniversalModal() {
    const modal = document.getElementById('detailModal');
    if (modal) {
        const overlay = modal.querySelector('#modalOverlay');
        if (overlay) overlay.style.display = 'none';
    }
}

// ========================================
// FUN√á√ÉO EDITAR CLIENTE (COMPLETA)
// ========================================

function editClient(clientId) {
    try {
        if (!clientId) {
            alert('‚ùå ID do cliente n√£o fornecido');
            return;
        }
        
        if (!appState?.clients) {
            alert('‚ùå Lista de clientes n√£o carregada');
            return;
        }
        
        const client = appState.clients.find(c => c?.id === clientId);
        if (!client) {
            alert('‚ùå Cliente n√£o encontrado');
            return;
        }
        
        const modal = openUniversalModal();
        const title = modal.querySelector('#modalTitle');
        const content = modal.querySelector('#modalContent');
        
        title.textContent = '‚úèÔ∏è Editar Cliente';
        
        content.innerHTML = `
            <form id="editClientForm" onsubmit="saveClientChanges('${clientId}'); return false;">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Nome Completo</label>
                    <input type="text" id="editName" value="${escapeHtml(client.name || '')}" 
                           style="width: 100%; padding: 0.8rem; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;" required>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">CPF/CNPJ</label>
                    <input type="text" id="editCpf" value="${escapeHtml(client.cpf || '')}" 
                           style="width: 100%; padding: 0.8rem; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;" required>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">E-mail</label>
                    <input type="email" id="editEmail" value="${escapeHtml(client.email || '')}" 
                           style="width: 100%; padding: 0.8rem; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Telefone</label>
                    <input type="tel" id="editPhone" value="${escapeHtml(client.phone || '')}" 
                           style="width: 100%; padding: 0.8rem; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Nova Senha (opcional)</label>
                    <input type="password" id="editPassword" placeholder="Deixe em branco para manter atual" 
                           style="width: 100%; padding: 0.8rem; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem;">
                    <small style="color: #6c757d; font-size: 0.85rem;">Deixe vazio para n√£o alterar a senha</small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" style="
                        flex: 1;
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 1rem;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: background 0.3s ease;
                    " onmouseover="this.style.background='#218838'" 
                       onmouseout="this.style.background='#28a745'">
                        üíæ Salvar Altera√ß√µes
                    </button>
                    
                    <button type="button" onclick="resetClientPassword('${clientId}')" style="
                        flex: 1;
                        background: #ffc107;
                        color: #212529;
                        border: none;
                        padding: 1rem;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: background 0.3s ease;
                    " onmouseover="this.style.background='#e0a800'" 
                       onmouseout="this.style.background='#ffc107'">
                        üîÑ Reset Senha
                    </button>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button type="button" onclick="deleteClient('${clientId}')" style="
                        width: 100%;
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 1rem;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: background 0.3s ease;
                    " onmouseover="this.style.background='#c82333'" 
                       onmouseout="this.style.background='#dc3545'">
                        üóëÔ∏è Excluir Cliente
                    </button>
                </div>
            </form>
        `;
        
    } catch (error) {
        alert(`‚ùå Erro ao abrir edi√ß√£o: ${error.message}`);
    }
}

async function saveClientChanges(clientId) {
    try {
        const name = document.getElementById('editName').value.trim();
        const cpf = document.getElementById('editCpf').value.trim();
        const email = document.getElementById('editEmail').value.trim();
        const phone = document.getElementById('editPhone').value.trim();
        const password = document.getElementById('editPassword').value.trim();
        
        if (!name || !cpf) {
            alert('‚ùå Nome e CPF s√£o obrigat√≥rios');
            return;
        }
        
        const clientData = { name, cpf, email, phone };
        if (password) clientData.password = password;
        
        showLoading();
        
        const result = await callGoogleScript('updateClient', clientId, clientData);
        
        hideLoading();
        
        if (result?.success) {
            alert('‚úÖ Cliente atualizado com sucesso!');
            closeUniversalModal();
            
            if (typeof refreshClientsList === 'function') {
                refreshClientsList();
            }
        } else {
            alert(`‚ùå Erro ao salvar: ${result?.error || 'Erro desconhecido'}`);
        }
        
    } catch (error) {
        hideLoading();
        alert(`‚ùå Erro ao salvar altera√ß√µes: ${error.message}`);
    }
}

async function resetClientPassword(clientId) {
    if (!confirm('üîÑ Resetar senha deste cliente para "123456"?')) {
        return;
    }
    
    try {
        showLoading();
        
        const result = await callGoogleScript('updateClient', clientId, { password: '123456' });
        
        hideLoading();
        
        if (result?.success) {
            alert('‚úÖ Senha resetada para "123456"');
            closeUniversalModal();
        } else {
            alert(`‚ùå Erro ao resetar senha: ${result?.error || 'Erro desconhecido'}`);
        }
        
    } catch (error) {
        hideLoading();
        alert(`‚ùå Erro ao resetar senha: ${error.message}`);
    }
}

async function deleteClient(clientId) {
    const client = appState.clients?.find(c => c.id === clientId);
    const clientName = client?.name || 'Cliente';
    
    if (!confirm(`üóëÔ∏è Tem certeza que deseja EXCLUIR o cliente "${clientName}"?\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
    }
    
    try {
        showLoading();
        
        const result = await callGoogleScript('deleteClient', clientId);
        
        hideLoading();
        
        if (result?.success) {
            closeUniversalModal();
            showAlert(`‚úÖ Cliente "${clientName}" exclu√≠do com sucesso!`, 'success');
            
            if (typeof refreshClientsList === 'function') {
                setTimeout(refreshClientsList, 500);
            }
            
            if (typeof loadAdminData === 'function') {
                setTimeout(loadAdminData, 500);
            }
            
        } else {
            closeUniversalModal();
            showAlert(`‚ùå Erro ao excluir: ${result?.error || 'Erro desconhecido'}`, 'error');
        }
        
    } catch (error) {
        hideLoading();
        closeUniversalModal();
        console.error('‚ùå Erro cr√≠tico na exclus√£o:', error);
        showAlert(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(amount);
}

function formatDate(dateString) {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString('pt-BR');
}

// ========================================
// INICIALIZA√á√ÉO
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üõí Sistema de Credi√°rio StarkTech iniciado!');
    
    // Configurar event listeners
    const clientForm = document.getElementById('clientForm');
    const adminForm = document.getElementById('adminForm');
    const newClientForm = document.getElementById('newClientForm');
    const newCreditForm = document.getElementById('newCreditForm');
    
    if (clientForm) clientForm.addEventListener('submit', handleClientLogin);
    if (adminForm) adminForm.addEventListener('submit', handleAdminLogin);
    if (newClientForm) newClientForm.addEventListener('submit', createClient);
    if (newCreditForm) newCreditForm.addEventListener('submit', createCredit);
    
    // Configurar data padr√£o
    const today = new Date().toISOString().split('T')[0];
    const purchaseDateInput = document.getElementById('newPurchaseDate');
    if (purchaseDateInput) {
        purchaseDateInput.value = today;
    }
    
    showSyncStatus('Sistema carregado! üöÄ', 'success');
});

    </script>
</body>
</html>
